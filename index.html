<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<meta http-equiv="Content-Security-Policy" content="
  default-src 'self';
  script-src 'self' 'unsafe-inline' 'unsafe-eval'
    https://www.gstatic.com
    https://apis.google.com
    https://accounts.google.com;
  connect-src 'self'
    https://*.googleapis.com
    https://*.google.com
    https://*.firebaseio.com
    https://*.firebaseapp.com
    https://identitytoolkit.googleapis.com
    https://securetoken.googleapis.com
    https://generativelanguage.googleapis.com
    wss://*.firebaseio.com;
  frame-src
    https://accounts.google.com
    https://*.firebaseapp.com;
  img-src 'self' data: https:;
  style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
  font-src 'self' https://fonts.gstatic.com;
  worker-src blob:;
">
<meta name="application-name" content="FaithQuest">
<meta name="description" content="Family Bible learning with guided lessons, real-world missions, and age-safe AI.">
<meta name="theme-color" content="#0F172A">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="FaithQuest">
<title>FaithQuest — Family Bible Learning</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
:root {
  --amber: #F59E0B;
  --amber-light: #FEF3C7;
  --amber-dark: #D97706;
  --sky: #0EA5E9;
  --sky-light: #E0F2FE;
  --emerald: #10B981;
  --emerald-light: #D1FAE5;
  --rose: #F43F5E;
  --rose-light: #FFE4E6;
  --purple: #8B5CF6;
  --purple-light: #EDE9FE;
  --slate-900: #0F172A;
  --slate-800: #1E293B;
  --slate-700: #334155;
  --slate-600: #475569;
  --slate-400: #94A3B8;
  --slate-200: #E2E8F0;
  --slate-100: #F1F5F9;
  --slate-50: #F8FAFC;
  --white: #FFFFFF;
  --sand: #FAFAF7;
  --gold: #B45309;
  --radius: 16px;
  --radius-sm: 8px;
  --radius-lg: 24px;
  --shadow: 0 4px 24px rgba(15,23,42,0.08);
  --shadow-lg: 0 12px 48px rgba(15,23,42,0.12);
  --font-display: 'Playfair Display', serif;
  --font-body: 'DM Sans', sans-serif;
}
*{margin:0;padding:0;box-sizing:border-box;}
html{scroll-behavior:smooth;}
html,body{height:100%;overflow:hidden;}body{font-family:var(--font-body);background:var(--sand);color:var(--slate-800);}
.hidden{display:none!important;}

/* ===== SCREENS ===== */
.screen{display:none;height:100vh;flex-direction:column;overflow:hidden;}
.screen.active{display:flex;}

/* ===== TYPOGRAPHY ===== */
h1,h2,h3{font-family:var(--font-display);}
.display-lg{font-size:clamp(2.2rem,6vw,3.8rem);font-weight:700;line-height:1.1;}
.display-md{font-size:clamp(1.6rem,4vw,2.4rem);font-weight:600;line-height:1.2;}
.display-sm{font-size:clamp(1.2rem,3vw,1.6rem);font-weight:600;line-height:1.3;}
.body-lg{font-size:1.0625rem;line-height:1.7;}
.body-sm{font-size:0.875rem;line-height:1.6;}
.label{font-size:0.75rem;font-weight:600;letter-spacing:0.08em;text-transform:uppercase;color:var(--slate-500);}
.muted{color:var(--slate-500);}

/* ===== BUTTONS ===== */
.btn{display:inline-flex;align-items:center;gap:8px;padding:14px 28px;border:none;border-radius:100px;font-family:var(--font-body);font-size:0.9375rem;font-weight:600;cursor:pointer;transition:all 0.2s;text-decoration:none;justify-content:center;}
.btn-primary{background:linear-gradient(135deg,var(--amber) 0%,var(--amber-dark) 100%);color:var(--white);box-shadow:0 4px 16px rgba(245,158,11,0.35);}
.btn-primary:hover{transform:translateY(-1px);box-shadow:0 8px 24px rgba(245,158,11,0.4);}
.btn-secondary{background:var(--white);color:var(--slate-800);border:2px solid var(--slate-200);box-shadow:var(--shadow);}
.btn-secondary:hover{border-color:var(--amber);color:var(--amber-dark);}
.btn-ghost{background:transparent;color:var(--slate-600);padding:10px 20px;}
.btn-ghost:hover{background:var(--slate-100);}
.btn-danger{background:var(--rose);color:var(--white);}
.btn-sky{background:linear-gradient(135deg,var(--sky) 0%,#0284C7 100%);color:var(--white);box-shadow:0 4px 16px rgba(14,165,233,0.3);}
.btn-emerald{background:linear-gradient(135deg,var(--emerald) 0%,#059669 100%);color:var(--white);box-shadow:0 4px 16px rgba(16,185,129,0.3);}
.btn-sm{padding:10px 20px;font-size:0.875rem;}
.btn-lg{padding:18px 40px;font-size:1rem;}
.btn-full{width:100%;}
.btn:disabled{opacity:0.5;cursor:not-allowed;transform:none!important;}

/* ===== CARDS ===== */
.card{background:var(--white);border-radius:var(--radius);padding:24px;box-shadow:var(--shadow);}
.card-lg{padding:32px;}
.card-hover:hover{transform:translateY(-2px);box-shadow:var(--shadow-lg);transition:all 0.2s;}

/* ===== INPUTS ===== */
.form-group{display:flex;flex-direction:column;gap:6px;margin-bottom:20px;}
.form-label{font-size:0.875rem;font-weight:600;color:var(--slate-700);}
.form-input{padding:14px 16px;border:2px solid var(--slate-200);border-radius:var(--radius-sm);font-family:var(--font-body);font-size:0.9375rem;color:var(--slate-800);background:var(--white);transition:border-color 0.2s;outline:none;}
.form-input:focus{border-color:var(--amber);}
.form-input.error{border-color:var(--rose);}
.form-error{font-size:0.8125rem;color:var(--rose);font-weight:500;}
select.form-input{appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2394A3B8' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 14px center;background-size:18px;padding-right:44px;}

/* ===== NAV ===== */
.top-nav{display:flex;align-items:center;justify-content:space-between;padding:16px 24px;background:var(--white);border-bottom:1px solid var(--slate-200);position:sticky;top:0;z-index:100;box-shadow:0 1px 8px rgba(0,0,0,0.04);}
.nav-logo{display:flex;align-items:center;gap:10px;text-decoration:none;}
.nav-logo-icon{width:36px;height:36px;background:linear-gradient(135deg,var(--amber),var(--amber-dark));border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;}
.nav-logo-text{font-family:var(--font-display);font-size:1.25rem;font-weight:700;color:var(--slate-900);}
.bottom-nav{display:flex;background:var(--white);border-top:1px solid var(--slate-200);padding:8px 0 max(8px,env(safe-area-inset-bottom));position:fixed;bottom:0;left:0;right:0;z-index:100;}
.bottom-nav-item{flex:1;display:flex;flex-direction:column;align-items:center;gap:3px;padding:8px 4px;cursor:pointer;border:none;background:none;font-family:var(--font-body);color:var(--slate-400);transition:color 0.2s;}
.bottom-nav-item.active{color:var(--amber-dark);}
.bottom-nav-icon{font-size:22px;line-height:1;}
.bottom-nav-label{font-size:0.65rem;font-weight:600;letter-spacing:0.03em;}

/* ===== BADGES / CHIPS ===== */
.badge{display:inline-flex;align-items:center;gap:4px;padding:4px 12px;border-radius:100px;font-size:0.75rem;font-weight:600;}
.badge-amber{background:var(--amber-light);color:var(--gold);}
.badge-sky{background:var(--sky-light);color:#0369A1;}
.badge-emerald{background:var(--emerald-light);color:#065F46;}
.badge-purple{background:var(--purple-light);color:#6D28D9;}
.badge-rose{background:var(--rose-light);color:#BE123C;}

/* ===== PROGRESS BAR ===== */
.progress-bar{height:8px;background:var(--slate-200);border-radius:100px;overflow:hidden;}
.progress-fill{height:100%;background:linear-gradient(90deg,var(--amber),var(--amber-dark));border-radius:100px;transition:width 0.5s ease;}

/* ===== TOAST ===== */
#toast{position:fixed;top:20px;left:50%;transform:translateX(-50%);background:var(--slate-900);color:var(--white);padding:12px 24px;border-radius:100px;font-size:0.875rem;font-weight:500;z-index:9999;opacity:0;transition:opacity 0.3s;pointer-events:none;white-space:nowrap;max-width:90vw;text-align:center;}
#toast.show{opacity:1;}

/* ===== MODAL ===== */
.modal-overlay{position:fixed;inset:0;background:rgba(15,23,42,0.6);z-index:1000;display:flex;align-items:flex-end;justify-content:center;opacity:0;pointer-events:none;transition:opacity 0.3s;}
.modal-overlay.open{opacity:1;pointer-events:all;}
.modal{background:var(--white);border-radius:24px 24px 0 0;padding:32px 24px max(32px,env(safe-area-inset-bottom));width:100%;max-width:560px;transform:translateY(100%);transition:transform 0.3s cubic-bezier(0.34,1.56,0.64,1);}
.modal-overlay.open .modal{transform:translateY(0);}
.modal-handle{width:40px;height:4px;background:var(--slate-200);border-radius:100px;margin:0 auto 24px;}
.modal-title{font-family:var(--font-display);font-size:1.4rem;font-weight:600;margin-bottom:8px;}

/* ===== AVATAR ===== */
.avatar{border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.25rem;flex-shrink:0;}
.avatar-sm{width:36px;height:36px;font-size:1rem;}
.avatar-md{width:48px;height:48px;}
.avatar-lg{width:64px;height:64px;font-size:1.8rem;}

/* ===== STREAK ===== */
.streak-badge{display:inline-flex;align-items:center;gap:6px;background:linear-gradient(135deg,#FF6B35,#F59E0B);color:white;padding:6px 14px;border-radius:100px;font-weight:700;font-size:0.875rem;}

/* ===== LANDING PAGE ===== */
#screen-landing{background:var(--white);}
#how-it-works,#paths-section,#lesson-preview,#pricing{scroll-margin-top:80px;}
.landing-hero{background:linear-gradient(160deg,#0F172A 0%,#1E3A5F 50%,#0F3460 100%);color:white;padding:80px 24px 80px;text-align:center;position:relative;overflow:visible;}
.hero-stars{position:absolute;inset:0;background-image:radial-gradient(circle,rgba(255,255,255,0.15) 1px,transparent 1px);background-size:40px 40px;opacity:0.4;}
.hero-glow{position:absolute;top:-100px;left:50%;transform:translateX(-50%);width:600px;height:600px;background:radial-gradient(circle,rgba(245,158,11,0.2) 0%,transparent 70%);}
.hero-content{position:relative;z-index:1;max-width:600px;margin:0 auto;}
.hero-eyebrow{display:inline-flex;align-items:center;gap:8px;background:rgba(245,158,11,0.2);border:1px solid rgba(245,158,11,0.4);color:var(--amber);padding:8px 16px;border-radius:100px;font-size:0.8125rem;font-weight:600;margin-bottom:24px;}
.hero-title{font-family:var(--font-display);font-size:clamp(2rem,5vw,3.2rem);font-weight:700;line-height:1.1;margin-bottom:20px;color:white;}
.hero-title span{color:var(--amber);}
.hero-sub{font-size:1.125rem;color:rgba(255,255,255,0.75);line-height:1.7;margin-bottom:40px;max-width:480px;margin-left:auto;margin-right:auto;}
.hero-cta-row{display:flex;gap:16px;justify-content:center;flex-wrap:wrap;}
.hero-trust{margin-top:48px;display:flex;justify-content:center;gap:32px;flex-wrap:wrap;}
.trust-item{display:flex;flex-direction:column;align-items:center;gap:4px;color:rgba(255,255,255,0.6);font-size:0.8125rem;}
.trust-icon{font-size:1.5rem;}
.section{padding:80px 24px;max-width:900px;margin:0 auto;}
.section-header{text-align:center;margin-bottom:56px;}
.section-eyebrow{display:inline-block;background:var(--amber-light);color:var(--gold);padding:6px 16px;border-radius:100px;font-size:0.75rem;font-weight:700;letter-spacing:0.06em;text-transform:uppercase;margin-bottom:16px;}
.how-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:24px;}
.how-card{text-align:center;padding:32px 24px;}
.how-icon{font-size:2.5rem;margin-bottom:16px;display:block;}
.how-title{font-family:var(--font-display);font-size:1.1rem;font-weight:600;margin-bottom:8px;}
.how-desc{font-size:0.875rem;color:var(--slate-600);line-height:1.6;}
.paths-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:20px;}
.path-card-landing{border-radius:var(--radius);overflow:hidden;cursor:pointer;transition:all 0.2s;}
.path-card-landing:hover{transform:translateY(-3px);box-shadow:var(--shadow-lg);}
.path-header{padding:28px 24px 20px;position:relative;overflow:hidden;}
.path-header::before{content:'';position:absolute;top:-30px;right:-30px;width:120px;height:120px;border-radius:50%;background:rgba(255,255,255,0.1);}
.path-emoji{font-size:2rem;display:block;margin-bottom:12px;position:relative;z-index:1;}
.path-title-text{font-family:var(--font-display);font-size:1.1rem;font-weight:600;color:white;position:relative;z-index:1;}
.path-body{padding:16px 24px 24px;background:white;}
.path-desc{font-size:0.8125rem;color:var(--slate-600);line-height:1.5;margin-bottom:12px;}
.testimonials{background:linear-gradient(135deg,#0F172A,#1E293B);padding:80px 24px;color:white;}
.testimonial-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:24px;max-width:900px;margin:0 auto;}
.testimonial-card{background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:var(--radius);padding:24px;}
.testimonial-text{font-size:0.9375rem;line-height:1.7;color:rgba(255,255,255,0.8);margin-bottom:16px;font-style:italic;}
.testimonial-author{display:flex;align-items:center;gap:12px;}
.testimonial-avatar{width:40px;height:40px;border-radius:50%;background:linear-gradient(135deg,var(--amber),var(--amber-dark));display:flex;align-items:center;justify-content:center;font-size:1.1rem;}
.testimonial-name{font-weight:600;color:white;font-size:0.875rem;}
.testimonial-role{font-size:0.75rem;color:rgba(255,255,255,0.5);}
.pricing-section{padding:80px 24px;background:var(--slate-50);}
.pricing-toggle{display:flex;align-items:center;gap:12px;justify-content:center;margin-bottom:48px;}
.toggle-track{width:52px;height:28px;background:var(--slate-300);border-radius:100px;cursor:pointer;position:relative;transition:background 0.2s;}
.toggle-track.on{background:var(--amber);}
.toggle-thumb{position:absolute;top:4px;left:4px;width:20px;height:20px;background:white;border-radius:50%;transition:transform 0.2s;box-shadow:0 1px 4px rgba(0,0,0,0.2);}
.toggle-track.on .toggle-thumb{transform:translateX(24px);}
.toggle-label{font-size:0.9375rem;font-weight:600;color:var(--slate-700);}
.pricing-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:24px;max-width:680px;margin:0 auto;}
.pricing-card{background:white;border-radius:var(--radius-lg);padding:36px 32px;box-shadow:var(--shadow);}
.pricing-card.featured{background:linear-gradient(160deg,#1E293B,#0F172A);color:white;position:relative;overflow:hidden;}
.pricing-card.featured::before{content:'';position:absolute;top:-50px;right:-50px;width:200px;height:200px;background:radial-gradient(circle,rgba(245,158,11,0.3),transparent 70%);}
.pricing-badge{background:var(--amber);color:white;padding:4px 12px;border-radius:100px;font-size:0.75rem;font-weight:700;display:inline-block;margin-bottom:12px;}
.pricing-plan-name{font-family:var(--font-display);font-size:1.3rem;font-weight:600;margin-bottom:8px;}
.pricing-price{font-family:var(--font-display);font-size:2.5rem;font-weight:700;margin-bottom:4px;}
.pricing-price sup{font-size:1rem;font-weight:600;vertical-align:top;margin-top:8px;}
.pricing-period{font-size:0.875rem;opacity:0.7;}
.pricing-features{list-style:none;margin:24px 0;display:flex;flex-direction:column;gap:10px;}
.pricing-features li{display:flex;gap:10px;font-size:0.9rem;}
.pricing-check{color:var(--emerald);flex-shrink:0;}
.pricing-featured-check{color:var(--amber);}
.faq-section{padding:80px 24px;max-width:700px;margin:0 auto;}
.faq-item{border-bottom:1px solid var(--slate-200);padding:20px 0;}
.faq-question{font-weight:600;font-size:0.9375rem;cursor:pointer;display:flex;justify-content:space-between;align-items:center;gap:16px;}
.faq-answer{font-size:0.875rem;color:var(--slate-600);line-height:1.7;margin-top:12px;display:none;}
.faq-answer.open{display:block;}
.landing-footer{background:var(--slate-900);color:rgba(255,255,255,0.6);padding:40px 24px;text-align:center;font-size:0.875rem;}
.landing-footer a{color:var(--amber);text-decoration:none;}

/* ===== AUTH SCREEN — split panel ===== */
#screen-auth{background:var(--slate-900);align-items:stretch;justify-content:center;padding:0;flex-direction:row!important;height:100vh;overflow:hidden;}
.auth-panel-left{flex:1;background:linear-gradient(160deg,#0F172A 0%,#1E3A5F 55%,#0F3460 100%);display:flex;flex-direction:column;justify-content:space-between;padding:48px 52px;position:relative;overflow:hidden;}
.auth-panel-left::before{content:'';position:absolute;inset:0;background-image:radial-gradient(circle,rgba(255,255,255,0.05) 1px,transparent 1px);background-size:28px 28px;}
.auth-panel-left-glow{position:absolute;bottom:-120px;left:-80px;width:500px;height:500px;background:radial-gradient(circle,rgba(245,158,11,0.15) 0%,transparent 65%);}
.auth-left-content{position:relative;z-index:1;}
.auth-left-logo{display:flex;align-items:center;gap:12px;margin-bottom:64px;}
.auth-left-logo-icon{width:44px;height:44px;background:linear-gradient(135deg,var(--amber),var(--amber-dark));border-radius:13px;display:flex;align-items:center;justify-content:center;font-size:22px;box-shadow:0 4px 16px rgba(245,158,11,0.4);}
.auth-left-logo-text{font-family:var(--font-display);font-size:1.4rem;font-weight:700;color:white;}
.auth-left-heading{font-family:var(--font-display);font-size:clamp(1.8rem,3vw,2.6rem);font-weight:700;color:white;line-height:1.15;margin-bottom:16px;}
.auth-left-heading span{color:var(--amber);}
.auth-left-sub{font-size:0.9375rem;color:rgba(255,255,255,0.6);line-height:1.75;margin-bottom:48px;max-width:360px;}
.auth-left-features{display:flex;flex-direction:column;gap:14px;}
.auth-left-feature{display:flex;align-items:center;gap:12px;}
.auth-feature-icon{width:36px;height:36px;border-radius:10px;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.12);display:flex;align-items:center;justify-content:center;font-size:1rem;flex-shrink:0;}
.auth-feature-text{font-size:0.875rem;color:rgba(255,255,255,0.7);line-height:1.4;}
.auth-feature-text strong{color:white;font-weight:600;}
.auth-left-footer{position:relative;z-index:1;font-size:0.75rem;color:rgba(255,255,255,0.3);}
.auth-panel-right{width:100%;max-width:480px;background:white;display:flex;flex-direction:column;justify-content:center;padding:48px 48px;overflow-y:auto;}
.auth-right-back{display:inline-flex;align-items:center;gap:6px;font-size:0.875rem;font-weight:500;color:var(--slate-500);cursor:pointer;margin-bottom:40px;transition:color 0.2s;background:none;border:none;font-family:var(--font-body);padding:0;}
.auth-right-back:hover{color:var(--slate-900);}
.auth-right-heading{font-family:var(--font-display);font-size:1.75rem;font-weight:700;color:var(--slate-900);margin-bottom:6px;}
.auth-right-sub{font-size:0.9rem;color:var(--slate-500);margin-bottom:32px;line-height:1.6;}
.auth-right-sub a{color:var(--amber-dark);font-weight:600;cursor:pointer;text-decoration:none;}
.auth-right-sub a:hover{text-decoration:underline;}
.auth-divider{display:flex;align-items:center;gap:12px;margin:24px 0;}
.auth-divider-line{flex:1;height:1px;background:var(--slate-200);}
.auth-divider-text{font-size:0.75rem;font-weight:600;color:var(--slate-400);text-transform:uppercase;letter-spacing:0.06em;}
.auth-demo-hint{background:linear-gradient(135deg,var(--amber-light),#FFF7ED);border:1px solid rgba(245,158,11,0.3);border-radius:var(--radius-sm);padding:12px 16px;margin-top:20px;display:flex;gap:10px;align-items:flex-start;}
.auth-demo-hint-icon{font-size:1rem;flex-shrink:0;margin-top:1px;}
.auth-demo-hint-text{font-size:0.8125rem;color:var(--gold);line-height:1.5;}
.auth-input-group{position:relative;margin-bottom:20px;}
.auth-input-label{display:block;font-size:0.8125rem;font-weight:600;color:var(--slate-700);margin-bottom:6px;}
.auth-input{width:100%;padding:13px 16px;border:2px solid var(--slate-200);border-radius:10px;font-family:var(--font-body);font-size:0.9375rem;color:var(--slate-900);background:white;transition:border-color 0.2s,box-shadow 0.2s;outline:none;}
.auth-input:focus{border-color:var(--amber);box-shadow:0 0 0 4px rgba(245,158,11,0.1);}
.auth-input.has-error{border-color:var(--rose);}
.auth-input-error{font-size:0.75rem;color:var(--rose);font-weight:500;margin-top:5px;}
.auth-pass-toggle{position:absolute;right:14px;bottom:13px;cursor:pointer;font-size:1rem;color:var(--slate-400);transition:color 0.2s;}
.auth-pass-toggle:hover{color:var(--slate-700);}
.auth-forgot{font-size:0.8125rem;color:var(--amber-dark);font-weight:600;cursor:pointer;float:right;margin-top:-14px;margin-bottom:20px;display:block;}
.auth-forgot:hover{text-decoration:underline;}
.auth-terms{font-size:0.75rem;color:var(--slate-400);line-height:1.6;margin-top:16px;text-align:center;}
.auth-terms a{color:var(--slate-600);}
.auth-strength{margin-top:6px;display:flex;gap:4px;}
.auth-strength-bar{height:3px;flex:1;border-radius:100px;background:var(--slate-200);transition:background 0.3s;}
.auth-strength-bar.weak{background:var(--rose);}
.auth-strength-bar.medium{background:var(--amber);}
.auth-strength-bar.strong{background:var(--emerald);}
@media(max-width:768px){
  #screen-auth{flex-direction:column!important;}
  .auth-panel-left{display:none;}
  .auth-panel-right{max-width:100%;padding:32px 24px;}
}

/* ===== ONBOARDING ===== */
#screen-onboarding{background:#F8FAFC;}

/* Progress rail */
.ob-rail{display:flex;align-items:center;gap:6px;padding:18px 20px 0;}
.ob-rail-back{width:36px;height:36px;border-radius:11px;border:none;background:white;color:var(--slate-600);display:flex;align-items:center;justify-content:center;font-size:1rem;cursor:pointer;box-shadow:0 1px 6px rgba(0,0,0,0.08);flex-shrink:0;transition:all 0.18s;}
.ob-rail-back:hover{background:var(--slate-100);}
.ob-rail-segs{display:flex;gap:5px;flex:1;}
.ob-rail-seg{flex:1;height:4px;border-radius:100px;background:var(--slate-200);transition:background 0.4s;}
.ob-rail-seg.done{background:var(--amber);}
.ob-rail-seg.active{background:var(--amber);opacity:0.5;}
.ob-rail-skip{font-size:0.78rem;font-weight:700;color:var(--slate-400);cursor:pointer;background:none;border:none;font-family:var(--font-body);letter-spacing:0.02em;white-space:nowrap;}
.ob-rail-skip:hover{color:var(--slate-700);}

/* Step card — the main visual panel */
.ob-card{margin:16px 16px 0;border-radius:24px;overflow:hidden;position:relative;}
.ob-card-bg{padding:36px 24px 40px;position:relative;overflow:hidden;}
.ob-card-dot-grid{position:absolute;inset:0;background-image:radial-gradient(circle,rgba(255,255,255,0.12) 1px,transparent 1px);background-size:22px 22px;}
.ob-card-glow{position:absolute;bottom:-60px;right:-40px;width:260px;height:260px;border-radius:50%;background:radial-gradient(circle,rgba(245,158,11,0.25),transparent 65%);}
.ob-card-content{position:relative;z-index:2;}
.ob-card-step-label{font-size:0.68rem;font-weight:800;letter-spacing:0.14em;text-transform:uppercase;color:rgba(255,255,255,0.55);margin-bottom:16px;display:flex;align-items:center;gap:8px;}
.ob-card-step-dot{width:6px;height:6px;border-radius:50%;background:var(--amber);}
.ob-card-icon{font-size:3.2rem;display:block;margin-bottom:14px;line-height:1;}
.ob-card-title{font-family:var(--font-display);font-size:clamp(1.6rem,5vw,2.1rem);font-weight:700;color:white;line-height:1.1;margin-bottom:8px;}
.ob-card-sub{font-size:0.875rem;color:rgba(255,255,255,0.6);line-height:1.6;max-width:340px;}

/* Per-step bg gradients */
.ob-bg-family{background:linear-gradient(150deg,#0F172A,#1E3A5F 50%,#0F3460);}
.ob-bg-child{background:linear-gradient(150deg,#064E3B,#047857 55%,#059669);}
.ob-bg-avatar{background:linear-gradient(150deg,#4C1D95,#7C3AED 60%,#6D28D9);}
.ob-bg-path{background:linear-gradient(150deg,#78350F,#B45309 55%,#D97706);}
.ob-bg-launch{background:linear-gradient(150deg,#0F172A,#1E3A5F 50%,#0F3460);}

/* Form body */
.ob-body{padding:20px 16px 0;flex:1;overflow-y:auto;}
.ob-field-label{font-size:0.775rem;font-weight:800;color:var(--slate-500);margin-bottom:7px;display:block;letter-spacing:0.05em;text-transform:uppercase;}
.ob-input{width:100%;padding:15px 16px;border:2px solid var(--slate-200);border-radius:14px;font-family:var(--font-body);font-size:1rem;color:var(--slate-900);background:white;transition:border-color 0.2s,box-shadow 0.2s;outline:none;margin-bottom:16px;box-shadow:0 1px 4px rgba(0,0,0,0.05);}
.ob-input:focus{border-color:var(--amber);box-shadow:0 0 0 4px rgba(245,158,11,0.1);}

/* Tier cards */
.age-tier-grid{display:flex;flex-direction:column;gap:9px;}
.age-tier-card{display:flex;align-items:center;gap:14px;padding:15px 16px;background:white;border-radius:16px;border:2px solid var(--slate-200);cursor:pointer;transition:all 0.2s;box-shadow:0 1px 6px rgba(0,0,0,0.06);}
.age-tier-card:hover{border-color:#FCD34D;transform:translateY(-1px);}
.age-tier-card.selected{border-color:var(--amber);background:linear-gradient(135deg,#FFFBF0,white);box-shadow:0 0 0 4px rgba(245,158,11,0.1);}
.age-tier-visual{width:48px;height:48px;border-radius:14px;display:flex;align-items:center;justify-content:center;font-size:1.5rem;background:var(--slate-100);transition:background 0.2s;flex-shrink:0;}
.age-tier-card.selected .age-tier-visual{background:#FEF3C7;}
.age-tier-info{flex:1;}
.age-tier-name{font-weight:700;font-size:0.9375rem;color:var(--slate-900);}
.age-tier-range{font-size:0.75rem;color:var(--slate-400);font-weight:500;margin-left:6px;}
.age-tier-desc{font-size:0.75rem;color:var(--slate-500);margin-top:2px;line-height:1.4;}
.age-tier-check{width:22px;height:22px;border-radius:50%;border:2px solid var(--slate-200);display:flex;align-items:center;justify-content:center;font-size:0.65rem;color:white;flex-shrink:0;transition:all 0.2s;}
.age-tier-card.selected .age-tier-check{background:var(--amber);border-color:var(--amber);}

/* Avatar picker */
.ob-avatar-preview{width:76px;height:76px;border-radius:50%;background:linear-gradient(135deg,#FEF3C7,#FFFBF0);border:3px solid var(--amber);display:flex;align-items:center;justify-content:center;font-size:2.5rem;margin:0 auto 18px;box-shadow:0 0 0 6px rgba(245,158,11,0.1),0 4px 20px rgba(0,0,0,0.08);transition:transform 0.3s cubic-bezier(0.34,1.56,0.64,1);}
.avatar-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;}
.avatar-option{aspect-ratio:1;border-radius:13px;display:flex;align-items:center;justify-content:center;font-size:1.6rem;cursor:pointer;border:2.5px solid transparent;transition:all 0.18s;background:white;box-shadow:0 1px 4px rgba(0,0,0,0.06);}
.avatar-option:hover{background:#FEF9EE;transform:scale(1.08);}
.avatar-option.selected{border-color:var(--amber);background:#FEF3C7;transform:scale(1.12);box-shadow:0 4px 14px rgba(245,158,11,0.3);}

/* Path picker */
.ob-path-list{display:flex;flex-direction:column;gap:9px;}
.ob-path-row{display:flex;align-items:center;background:white;border-radius:16px;overflow:hidden;border:2px solid transparent;cursor:pointer;transition:all 0.2s;box-shadow:0 1px 6px rgba(0,0,0,0.06);}
.ob-path-row:hover{transform:translateY(-1px);box-shadow:0 5px 20px rgba(0,0,0,0.1);}
.ob-path-row.selected{border-color:var(--amber);box-shadow:0 0 0 4px rgba(245,158,11,0.1);}
.ob-path-row.locked{opacity:0.5;cursor:not-allowed;}
.ob-path-swatch{width:52px;min-height:72px;display:flex;align-items:center;justify-content:center;font-size:1.5rem;flex-shrink:0;}
.ob-path-swatch.sw-jesus{background:linear-gradient(160deg,#1E3A5F,#0F3460);}
.ob-path-swatch.sw-fruit{background:linear-gradient(160deg,#065F46,#059669);}
.ob-path-swatch.sw-courage{background:linear-gradient(160deg,#7C3AED,#6D28D9);}
.ob-path-swatch.sw-words{background:linear-gradient(160deg,#B45309,#D97706);}
.ob-path-swatch.sw-prayer{background:linear-gradient(160deg,#0369A1,#0284C7);}
.ob-path-body{flex:1;padding:13px 14px;}
.ob-path-title{font-weight:700;font-size:0.9375rem;color:var(--slate-900);margin-bottom:2px;}
.ob-path-meta{font-size:0.74rem;color:var(--slate-500);line-height:1.4;}
.ob-path-check{width:24px;height:24px;border-radius:50%;border:2px solid var(--slate-200);display:flex;align-items:center;justify-content:center;font-size:0.7rem;color:white;flex-shrink:0;margin-right:14px;transition:all 0.2s;}
.ob-path-row.selected .ob-path-check{background:var(--amber);border-color:var(--amber);}

/* Confirm / launch card */
.ob-confirm-card{background:linear-gradient(140deg,#0F172A,#1E3A5F);border-radius:22px;padding:28px 24px;color:white;margin-bottom:14px;text-align:center;}
.ob-confirm-avatar-ring{width:80px;height:80px;border-radius:50%;border:3px solid rgba(245,158,11,0.6);background:rgba(245,158,11,0.15);display:flex;align-items:center;justify-content:center;font-size:2.8rem;margin:0 auto 14px;box-shadow:0 0 0 8px rgba(245,158,11,0.08);}
.ob-confirm-name{font-family:var(--font-display);font-size:1.5rem;font-weight:700;color:white;margin-bottom:2px;}
.ob-confirm-sub{font-size:0.8rem;color:rgba(255,255,255,0.45);margin-bottom:22px;}
.ob-confirm-row{display:flex;align-items:center;gap:12px;background:rgba(255,255,255,0.07);border-radius:12px;padding:12px 14px;margin-bottom:8px;text-align:left;}
.ob-confirm-row-icon{font-size:1.1rem;flex-shrink:0;}
.ob-confirm-row-text{font-size:0.82rem;color:rgba(255,255,255,0.7);line-height:1.45;}
.ob-confirm-row-text strong{color:white;}

/* CTA footer */
.ob-footer{padding:16px;background:white;border-top:1px solid var(--slate-100);}
.ob-cta-btn{width:100%;padding:17px;border-radius:16px;font-family:var(--font-body);font-size:1rem;font-weight:700;border:none;background:var(--amber);color:white;cursor:pointer;transition:all 0.2s;box-shadow:0 4px 16px rgba(245,158,11,0.3);}
.ob-cta-btn:hover{background:var(--amber-dark);transform:translateY(-1px);box-shadow:0 6px 22px rgba(245,158,11,0.4);}
.ob-footer-note{text-align:center;font-size:0.72rem;color:var(--slate-400);margin-top:9px;line-height:1.5;}

/* Slide transition */
@keyframes obSlideIn{from{opacity:0;transform:translateX(20px);}to{opacity:1;transform:translateX(0);}}
.ob-slide{animation:obSlideIn 0.28s cubic-bezier(0.34,1.15,0.64,1) both;}

/* ===== PARENT DASHBOARD ===== */
.app-content{flex:1;overflow-y:auto;padding:0 0 100px;max-width:860px;margin:0 auto;width:100%;}

/* Welcome hero */
.pd-hero{background:linear-gradient(135deg,#0F172A 0%,#1E3A5F 55%,#0F3460 100%);padding:28px 24px 32px;position:relative;overflow:hidden;}
.pd-hero::before{content:'';position:absolute;inset:0;background-image:radial-gradient(circle,rgba(255,255,255,0.06) 1px,transparent 1px);background-size:24px 24px;}
.pd-hero-glow{position:absolute;top:-80px;right:-60px;width:280px;height:280px;background:radial-gradient(circle,rgba(245,158,11,0.18),transparent 65%);}
.pd-hero-content{position:relative;z-index:1;}
.pd-hero-greeting{font-size:0.8rem;font-weight:600;color:rgba(255,255,255,0.55);text-transform:uppercase;letter-spacing:0.1em;margin-bottom:4px;}
.pd-hero-name{font-family:var(--font-display);font-size:1.65rem;font-weight:700;color:white;margin-bottom:2px;}
.pd-hero-date{font-size:0.8125rem;color:rgba(255,255,255,0.5);margin-bottom:20px;}
.pd-kpi-row{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;}
.pd-kpi{background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.1);border-radius:14px;padding:14px 12px;text-align:center;backdrop-filter:blur(4px);}
.pd-kpi-val{font-family:var(--font-display);font-size:1.6rem;font-weight:700;color:white;line-height:1;display:block;}
.pd-kpi-lbl{font-size:0.7rem;color:rgba(255,255,255,0.55);font-weight:600;text-transform:uppercase;letter-spacing:0.06em;margin-top:4px;display:block;}
.pd-kpi.highlight{background:rgba(245,158,11,0.2);border-color:rgba(245,158,11,0.4);}
.pd-kpi.highlight .pd-kpi-val{color:var(--amber);}

/* Body padding */
.pd-body{padding:20px 20px 0;}

/* Section header */
.pd-section-hd{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;margin-top:24px;}
.pd-section-title{font-family:var(--font-display);font-size:1.05rem;font-weight:700;color:var(--slate-900);}
.pd-section-action{font-size:0.8rem;font-weight:600;color:var(--amber-dark);cursor:pointer;background:none;border:none;font-family:var(--font-body);padding:0;}

/* Member cards — horizontal swipeable on mobile */
.pd-members{display:flex;flex-direction:column;gap:10px;}
.pd-member-card{display:flex;align-items:center;gap:14px;background:white;border-radius:16px;padding:14px 16px;box-shadow:0 2px 12px rgba(0,0,0,0.06);border:2px solid transparent;transition:all 0.18s;cursor:pointer;}
.pd-member-card:hover{box-shadow:0 4px 20px rgba(0,0,0,0.1);transform:translateY(-1px);}
.pd-member-card.active-member{border-color:var(--amber);background:linear-gradient(135deg,#FFFBF0,white);}
.pd-member-avatar{width:48px;height:48px;border-radius:14px;display:flex;align-items:center;justify-content:center;font-size:1.6rem;flex-shrink:0;}
.pd-member-info{flex:1;min-width:0;}
.pd-member-name{font-weight:700;font-size:0.9375rem;color:var(--slate-900);display:flex;align-items:center;gap:6px;}
.pd-member-meta{font-size:0.78rem;color:var(--slate-500);margin-top:2px;}
.pd-member-progress{margin-top:8px;}
.pd-member-prog-bar{height:4px;background:var(--slate-100);border-radius:100px;overflow:hidden;}
.pd-member-prog-fill{height:100%;background:linear-gradient(90deg,var(--amber),var(--amber-dark));border-radius:100px;transition:width 0.6s ease;}
.pd-member-prog-label{font-size:0.7rem;color:var(--slate-400);margin-top:4px;}
.pd-member-action{flex-shrink:0;}

/* Quick stats row below member */
.pd-member-stats{display:flex;gap:8px;margin-top:8px;}
.pd-member-stat-pill{background:var(--slate-100);border-radius:100px;padding:4px 10px;font-size:0.72rem;font-weight:600;color:var(--slate-600);}

/* Pending approvals */
.pd-approval{background:white;border-radius:16px;padding:16px;box-shadow:0 2px 12px rgba(0,0,0,0.06);margin-bottom:10px;border-left:4px solid var(--amber);}
.pd-approval-top{display:flex;align-items:flex-start;gap:12px;margin-bottom:12px;}
.pd-approval-avatar{width:38px;height:38px;border-radius:11px;display:flex;align-items:center;justify-content:center;font-size:1.3rem;background:var(--amber-light);flex-shrink:0;}
.pd-approval-meta{flex:1;}
.pd-approval-who{font-weight:700;font-size:0.9rem;color:var(--slate-900);}
.pd-approval-mission{font-size:0.8rem;color:var(--slate-500);margin-top:1px;}
.pd-approval-reflection{background:var(--slate-50);border-radius:10px;padding:10px 12px;font-size:0.825rem;color:var(--slate-700);line-height:1.55;font-style:italic;margin-bottom:12px;}
.pd-approval-actions{display:flex;gap:8px;}

/* Insights */
.pd-insights-kpi{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:16px;}
.pd-ins-card{background:white;border-radius:16px;padding:18px 16px;box-shadow:0 2px 12px rgba(0,0,0,0.06);}
.pd-ins-icon{font-size:1.4rem;margin-bottom:8px;display:block;}
.pd-ins-val{font-family:var(--font-display);font-size:1.5rem;font-weight:700;color:var(--slate-900);display:block;}
.pd-ins-lbl{font-size:0.72rem;font-weight:600;color:var(--slate-500);text-transform:uppercase;letter-spacing:0.06em;margin-top:2px;display:block;}

/* Heatmap */
.pd-heatmap-wrap{background:white;border-radius:16px;padding:18px 16px;box-shadow:0 2px 12px rgba(0,0,0,0.06);margin-bottom:16px;}
.pd-heatmap-title{font-size:0.8rem;font-weight:700;color:var(--slate-600);text-transform:uppercase;letter-spacing:0.06em;margin-bottom:12px;}
.heatmap{display:grid;grid-template-columns:repeat(7,1fr);gap:4px;}
.heatmap-day-labels{display:grid;grid-template-columns:repeat(7,1fr);gap:4px;margin-bottom:4px;}
.heatmap-day-lbl{font-size:0.6rem;color:var(--slate-400);text-align:center;font-weight:600;}
.heatmap-cell{aspect-ratio:1;border-radius:4px;background:var(--slate-100);}
.heatmap-cell.l1{background:#FEF3C7;}
.heatmap-cell.l2{background:#FCD34D;}
.heatmap-cell.l3{background:#F59E0B;}
.heatmap-cell.l4{background:#D97706;}
.pd-heatmap-legend{display:flex;align-items:center;gap:6px;margin-top:10px;justify-content:flex-end;}
.pd-heatmap-legend span{font-size:0.7rem;color:var(--slate-400);}
.pd-legend-cell{width:11px;height:11px;border-radius:2px;}

/* Character bars */
.pd-char-wrap{background:white;border-radius:16px;padding:18px 16px;box-shadow:0 2px 12px rgba(0,0,0,0.06);margin-bottom:16px;}
.pd-char-row{margin-bottom:14px;}
.pd-char-row:last-child{margin-bottom:0;}
.pd-char-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;}
.pd-char-name{font-size:0.875rem;font-weight:600;color:var(--slate-800);}
.pd-char-pct{font-size:0.8rem;font-weight:700;color:var(--amber-dark);}
.pd-char-bar{height:8px;background:var(--slate-100);border-radius:100px;overflow:hidden;}
.pd-char-fill{height:100%;border-radius:100px;transition:width 0.8s ease;}

/* Per-kid insight cards */
.pd-kid-card{background:white;border-radius:16px;padding:18px 16px;box-shadow:0 2px 12px rgba(0,0,0,0.06);margin-bottom:10px;}
.pd-kid-card-top{display:flex;align-items:center;gap:12px;margin-bottom:14px;}
.pd-kid-card-avatar{width:40px;height:40px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:1.4rem;background:var(--amber-light);}
.pd-kid-card-name{font-weight:700;font-size:0.9375rem;}
.pd-kid-card-meta{font-size:0.78rem;color:var(--slate-500);}
.pd-kid-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:14px;}
.pd-kid-stat{background:var(--slate-50);border-radius:10px;padding:10px 8px;text-align:center;}
.pd-kid-stat-val{font-family:var(--font-display);font-size:1.1rem;font-weight:700;color:var(--slate-900);display:block;}
.pd-kid-stat-lbl{font-size:0.65rem;color:var(--slate-500);font-weight:600;text-transform:uppercase;letter-spacing:0.04em;}

/* Paths */
.pd-path-card{display:flex;align-items:center;gap:0;background:white;border-radius:16px;overflow:hidden;box-shadow:0 2px 12px rgba(0,0,0,0.06);margin-bottom:10px;border:2px solid transparent;cursor:pointer;transition:all 0.2s;}
.pd-path-card:hover{transform:translateY(-1px);box-shadow:0 6px 24px rgba(0,0,0,0.1);}
.pd-path-card.active-path{border-color:var(--amber);}
.pd-path-swatch{width:60px;min-height:80px;display:flex;align-items:center;justify-content:center;font-size:1.6rem;flex-shrink:0;}
.pd-path-body{flex:1;padding:14px;}
.pd-path-title{font-weight:700;font-size:0.9375rem;color:var(--slate-900);margin-bottom:3px;}
.pd-path-desc{font-size:0.775rem;color:var(--slate-500);line-height:1.4;}
.pd-path-footer{padding:0 14px 12px;display:flex;align-items:center;justify-content:space-between;}
.pd-path-badge{font-size:0.7rem;font-weight:700;padding:3px 10px;border-radius:100px;background:var(--amber-light);color:var(--gold);}

/* Family / subscription */
.pd-plan-hero{background:linear-gradient(135deg,#0F172A,#1E3A5F);border-radius:20px;padding:24px;margin-bottom:16px;color:white;}
.pd-plan-label{font-size:0.7rem;font-weight:700;color:var(--amber);text-transform:uppercase;letter-spacing:0.1em;margin-bottom:6px;}
.pd-plan-name{font-family:var(--font-display);font-size:1.4rem;font-weight:700;color:white;margin-bottom:4px;}
.pd-plan-desc{font-size:0.825rem;color:rgba(255,255,255,0.55);}
.pd-upgrade-card{background:linear-gradient(135deg,#FEF3C7,#FFFBF0);border:1.5px solid var(--amber);border-radius:18px;padding:20px;margin-bottom:16px;}

/* Legacy compat */
.section-title{font-family:var(--font-display);font-size:1.2rem;font-weight:600;margin-bottom:16px;color:var(--slate-900);}
.stats-row{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:24px;}
.stat-card{background:white;border-radius:var(--radius);padding:16px;text-align:center;box-shadow:var(--shadow);}
.stat-value{font-family:var(--font-display);font-size:1.8rem;font-weight:700;color:var(--slate-900);display:block;}
.stat-label{font-size:0.75rem;color:var(--slate-500);font-weight:500;margin-top:2px;display:block;}
.member-list{display:flex;flex-direction:column;gap:12px;margin-bottom:24px;}
.member-row{display:flex;align-items:center;gap:14px;padding:14px 16px;background:white;border-radius:var(--radius);box-shadow:var(--shadow);}
.member-info{flex:1;}
.member-name{font-weight:600;font-size:0.9375rem;}
.member-meta{font-size:0.8125rem;color:var(--slate-500);}
.pending-list{display:flex;flex-direction:column;gap:12px;}
.pending-card{display:flex;align-items:center;gap:14px;padding:16px;background:white;border-radius:var(--radius);box-shadow:var(--shadow);}
.pending-info{flex:1;}
.pending-title{font-weight:600;font-size:0.875rem;}
.pending-meta{font-size:0.8125rem;color:var(--slate-500);margin-top:2px;}
.insights-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:16px;}
.insight-card{background:white;border-radius:var(--radius);padding:20px;box-shadow:var(--shadow);}
.insight-label{font-size:0.75rem;font-weight:600;color:var(--slate-500);text-transform:uppercase;letter-spacing:0.06em;margin-bottom:8px;}
.insight-value{font-family:var(--font-display);font-size:1.6rem;font-weight:700;color:var(--slate-900);}

/* ===== KID HOME ===== */

/* ── Hero sky zone ── */
.kh-sky{
  background:linear-gradient(170deg,#060D1F 0%,#0C1F3F 40%,#0F2A52 70%,#1A3A5C 100%);
  padding:32px 20px 64px;position:relative;overflow:hidden;
}
/* Stars canvas */
.kh-stars{position:absolute;inset:0;overflow:hidden;pointer-events:none;}
.kh-star{position:absolute;border-radius:50%;background:white;animation:starTwinkle var(--dur,3s) ease-in-out infinite;}
@keyframes starTwinkle{0%,100%{opacity:var(--lo,.2);transform:scale(1);}50%{opacity:var(--hi,.9);transform:scale(1.4);}}
/* Ambient glows */
.kh-glow-left{position:absolute;top:-80px;left:-60px;width:280px;height:280px;border-radius:50%;background:radial-gradient(circle,rgba(245,158,11,0.12),transparent 65%);pointer-events:none;}
.kh-glow-right{position:absolute;bottom:-40px;right:-40px;width:220px;height:220px;border-radius:50%;background:radial-gradient(circle,rgba(99,102,241,0.14),transparent 65%);pointer-events:none;}
/* Avatar + greeting row */
.kh-top-row{display:flex;align-items:center;gap:14px;margin-bottom:20px;position:relative;z-index:2;}
.kh-avatar-wrap{position:relative;flex-shrink:0;}
.kh-avatar{width:56px;height:56px;border-radius:18px;background:rgba(255,255,255,0.12);border:2px solid rgba(255,255,255,0.2);display:flex;align-items:center;justify-content:center;font-size:2rem;backdrop-filter:blur(4px);}
.kh-avatar-lvl{position:absolute;bottom:-6px;right:-6px;background:var(--amber);color:white;font-size:0.55rem;font-weight:900;padding:2px 5px;border-radius:100px;border:2px solid #060D1F;letter-spacing:0.04em;}
.kh-greeting-block{flex:1;}
.kh-time-greeting{font-size:0.7rem;font-weight:700;color:rgba(255,255,255,0.45);text-transform:uppercase;letter-spacing:0.12em;}
.kh-hero-name{font-family:var(--font-display);font-size:1.55rem;font-weight:700;color:white;line-height:1.1;}

/* ── Animated streak ring ── */
.kh-streak-center{display:flex;flex-direction:column;align-items:center;position:relative;z-index:2;margin-bottom:20px;}
.kh-streak-ring-wrap{position:relative;width:110px;height:110px;margin-bottom:10px;}
.kh-streak-ring-svg{width:110px;height:110px;transform:rotate(-90deg);}
.kh-streak-track{fill:none;stroke:rgba(255,255,255,0.08);stroke-width:7;}
.kh-streak-fill{fill:none;stroke-width:7;stroke-linecap:round;stroke:url(#fireGrad);stroke-dasharray:295;stroke-dashoffset:295;transition:stroke-dashoffset 1.2s cubic-bezier(0.34,1.2,0.64,1);}
.kh-streak-inner{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;}
.kh-streak-flame{font-size:1.6rem;line-height:1;animation:flamePulse 1.8s ease-in-out infinite;}
@keyframes flamePulse{0%,100%{transform:scale(1) rotate(-2deg);}33%{transform:scale(1.18) rotate(3deg);}66%{transform:scale(1.08) rotate(-1deg);}}
.kh-streak-num{font-family:var(--font-display);font-size:1.35rem;font-weight:800;color:white;line-height:1;margin-top:1px;}
.kh-streak-label{font-size:0.58rem;font-weight:700;color:rgba(255,255,255,0.5);text-transform:uppercase;letter-spacing:0.1em;}
.kh-streak-title{font-size:0.75rem;font-weight:700;color:rgba(255,255,255,0.6);letter-spacing:0.04em;}
.kh-streak-sub{font-size:0.68rem;color:rgba(255,255,255,0.35);margin-top:2px;}

/* ── XP / stat pills ── */
.kh-stats-row{display:flex;gap:8px;justify-content:center;position:relative;z-index:2;}
.kh-stat-pill{display:flex;align-items:center;gap:6px;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.12);border-radius:100px;padding:7px 14px;backdrop-filter:blur(4px);}
.kh-stat-icon{font-size:0.95rem;line-height:1;}
.kh-stat-val{font-size:0.8rem;font-weight:800;color:white;}
.kh-stat-lbl{font-size:0.65rem;color:rgba(255,255,255,0.45);font-weight:600;}

/* ── Quest card (today's lesson) ── */
.kh-body{padding:0 16px;margin-top:-36px;position:relative;z-index:3;padding-bottom:16px;}
.kh-quest-card{
  background:white;border-radius:24px;
  box-shadow:0 16px 48px rgba(0,0,0,0.22),0 2px 8px rgba(0,0,0,0.08);
  overflow:hidden;margin-bottom:16px;
  animation:questCardIn 0.5s cubic-bezier(0.34,1.2,0.64,1) both;
}
@keyframes questCardIn{from{opacity:0;transform:translateY(16px) scale(0.97);}to{opacity:1;transform:translateY(0) scale(1);}}
.kh-quest-banner{
  background:linear-gradient(135deg,#0F172A 0%,#1E3A5F 60%,#0C3460 100%);
  padding:18px 20px 20px;position:relative;overflow:hidden;
}
.kh-quest-banner::before{content:'';position:absolute;inset:0;background-image:radial-gradient(circle,rgba(255,255,255,0.06) 1px,transparent 1px);background-size:20px 20px;}
.kh-quest-banner-glow{position:absolute;top:-30px;right:-20px;width:160px;height:160px;border-radius:50%;background:radial-gradient(circle,rgba(245,158,11,0.2),transparent 60%);pointer-events:none;}
.kh-quest-tag{display:inline-flex;align-items:center;gap:5px;background:rgba(245,158,11,0.2);border:1px solid rgba(245,158,11,0.4);color:var(--amber);padding:3px 10px;border-radius:100px;font-size:0.62rem;font-weight:800;letter-spacing:0.1em;text-transform:uppercase;margin-bottom:8px;position:relative;z-index:1;}
.kh-quest-title{font-family:var(--font-display);font-size:1.2rem;font-weight:700;color:white;line-height:1.25;position:relative;z-index:1;margin-bottom:4px;}
.kh-quest-path{font-size:0.72rem;color:rgba(255,255,255,0.5);position:relative;z-index:1;}
.kh-quest-body{padding:16px 20px 20px;}
.kh-quest-prog-row{display:flex;align-items:center;gap:10px;margin-bottom:16px;}
.kh-quest-prog-bar{flex:1;height:6px;background:var(--slate-100);border-radius:100px;overflow:hidden;}
.kh-quest-prog-fill{height:100%;background:linear-gradient(90deg,var(--amber),#F97316);border-radius:100px;transition:width 0.8s ease;}
.kh-quest-prog-lbl{font-size:0.7rem;font-weight:700;color:var(--slate-400);white-space:nowrap;}
.kh-start-btn{
  width:100%;padding:16px;border-radius:16px;border:none;
  background:linear-gradient(135deg,var(--amber),#F97316);
  color:white;font-family:var(--font-body);font-weight:800;font-size:1rem;
  cursor:pointer;letter-spacing:0.01em;
  box-shadow:0 6px 20px rgba(245,158,11,0.4);
  transition:all 0.2s;position:relative;overflow:hidden;
}
.kh-start-btn::after{content:'';position:absolute;inset:0;background:linear-gradient(180deg,rgba(255,255,255,0.15),transparent);}
.kh-start-btn:hover{transform:translateY(-2px);box-shadow:0 10px 28px rgba(245,158,11,0.5);}
.kh-start-btn:active{transform:translateY(0);}

/* ── Section heading ── */
.kh-section-hd{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;margin-top:4px;}
.kh-section-title{font-family:var(--font-display);font-size:1rem;font-weight:700;color:var(--slate-900);}
.kh-section-count{font-size:0.75rem;font-weight:700;color:var(--slate-400);}

/* ── Quest scroll (mission card) ── */
.kh-mission{
  background:white;border-radius:18px;padding:14px 16px;
  box-shadow:0 2px 12px rgba(0,0,0,0.07);margin-bottom:10px;
  display:flex;align-items:center;gap:14px;cursor:pointer;
  transition:all 0.22s;border:2px solid transparent;
}
.kh-mission:hover{transform:translateY(-2px);box-shadow:0 6px 24px rgba(0,0,0,0.11);}
.kh-mission.pending{border-color:var(--amber);}
.kh-mission.done{opacity:0.72;}
.kh-mission-icon{
  width:46px;height:46px;border-radius:14px;
  display:flex;align-items:center;justify-content:center;font-size:1.5rem;flex-shrink:0;
}
.kh-mission-info{flex:1;min-width:0;}
.kh-mission-name{font-weight:700;font-size:0.9rem;color:var(--slate-900);margin-bottom:1px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.kh-mission-meta{font-size:0.75rem;color:var(--slate-500);}
.kh-mission-badge{flex-shrink:0;font-size:1.2rem;}

/* ── Empty mission state ── */
.kh-empty-mission{
  background:linear-gradient(135deg,#F8FAFC,white);
  border:2px dashed var(--slate-200);border-radius:18px;
  padding:28px 20px;text-align:center;
}
.kh-empty-mission-icon{font-size:2.2rem;margin-bottom:8px;}
.kh-empty-mission-title{font-weight:700;font-size:0.9rem;color:var(--slate-700);margin-bottom:4px;}
.kh-empty-mission-sub{font-size:0.78rem;color:var(--slate-400);line-height:1.5;}

/* ── Bottom padding ── */
.kh-bottom-pad{height:100px;}

/* Legacy compat (other screens use these) */
.kid-home-header{background:linear-gradient(160deg,#1E3A5F,#0F3460);padding:28px 24px 48px;color:white;position:relative;overflow:hidden;}
.kid-header-bg{position:absolute;inset:0;background-image:radial-gradient(circle,rgba(255,255,255,0.08) 1px,transparent 1px);background-size:24px 24px;}
.kid-hero-content{position:relative;z-index:1;}
.kid-greeting{font-size:0.875rem;color:rgba(255,255,255,0.7);margin-bottom:4px;}
.kid-name{font-family:var(--font-display);font-size:1.8rem;font-weight:700;color:white;margin-bottom:16px;}
.kid-streak-row{display:flex;align-items:center;gap:12px;flex-wrap:wrap;}
.reward-pills{display:flex;gap:8px;overflow-x:auto;padding-bottom:4px;scrollbar-width:none;}
.reward-pills::-webkit-scrollbar{display:none;}
.reward-pill{display:flex;align-items:center;gap:6px;background:rgba(255,255,255,0.15);border-radius:100px;padding:6px 14px;white-space:nowrap;font-size:0.8125rem;color:white;font-weight:600;}
.kid-card-area{margin-top:-28px;padding:0 16px;position:relative;z-index:2;}
.today-lesson-card{background:white;border-radius:var(--radius-lg);padding:24px;box-shadow:var(--shadow-lg);margin-bottom:20px;}
.today-label{font-size:0.75rem;font-weight:700;color:var(--amber-dark);text-transform:uppercase;letter-spacing:0.06em;margin-bottom:8px;}
.today-title{font-family:var(--font-display);font-size:1.3rem;font-weight:700;margin-bottom:8px;}
.today-path{font-size:0.8125rem;color:var(--slate-500);margin-bottom:16px;}
.today-actions{display:flex;gap:12px;}
.missions-section{padding:0 16px;padding-bottom:100px;}
.missions-title{font-family:var(--font-display);font-size:1.1rem;font-weight:600;margin-bottom:16px;color:var(--slate-900);}
.mission-card-kid{background:white;border-radius:var(--radius);padding:16px;box-shadow:var(--shadow);margin-bottom:12px;display:flex;align-items:center;gap:14px;cursor:pointer;transition:all 0.2s;}
.mission-card-kid:hover{transform:translateY(-1px);box-shadow:var(--shadow-lg);}
.mission-icon{width:44px;height:44px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:1.4rem;flex-shrink:0;}
.mission-info{flex:1;}
.mission-name{font-weight:600;font-size:0.9375rem;margin-bottom:2px;}
.mission-meta{font-size:0.8125rem;color:var(--slate-500);}
.mission-arrow{color:var(--slate-400);font-size:1.1rem;}

/* ===== LESSON PLAYER v2 ===== */
#screen-lesson{background:#F0F4F8;flex-direction:column;}

/* ── Cinematic nav bar ── */
.lp2-nav{
  display:flex;align-items:center;gap:12px;
  padding:12px 16px;background:white;
  border-bottom:1px solid rgba(0,0,0,0.06);
  position:sticky;top:0;z-index:50;
  box-shadow:0 2px 12px rgba(0,0,0,0.06);
  flex-shrink:0;
}
.lp2-close{
  width:34px;height:34px;border-radius:10px;border:none;
  background:var(--slate-100);color:var(--slate-500);
  display:flex;align-items:center;justify-content:center;
  font-size:0.9rem;cursor:pointer;flex-shrink:0;
  transition:all 0.18s;font-family:var(--font-body);
}
.lp2-close:hover{background:var(--slate-200);color:var(--slate-900);}
/* Step track — named pills */
.lp2-track{display:flex;gap:4px;flex:1;align-items:center;}
.lp2-step-pip{
  display:flex;align-items:center;justify-content:center;
  height:28px;border-radius:100px;font-size:0.6rem;
  font-weight:800;letter-spacing:0.04em;text-transform:uppercase;
  transition:all 0.35s cubic-bezier(0.34,1.2,0.64,1);
  white-space:nowrap;overflow:hidden;cursor:pointer;
  border:none;font-family:var(--font-body);
}
.lp2-step-pip.pending{
  width:8px;background:var(--slate-200);color:transparent;flex-shrink:0;
}
.lp2-step-pip.done{
  width:28px;background:var(--amber-light);color:var(--amber-dark);flex-shrink:0;
}
.lp2-step-pip.active{
  padding:0 12px;background:var(--slate-900);color:white;
  box-shadow:0 2px 10px rgba(0,0,0,0.2);flex-shrink:0;
}
.lp2-fraction{font-size:0.72rem;font-weight:700;color:var(--slate-400);flex-shrink:0;}

/* ── Scroll container ── */
.lp2-scroll{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;}

/* ── Step hero band ── */
.lp2-band{
  padding:36px 24px 40px;position:relative;overflow:hidden;
}
.lp2-band-grid{
  position:absolute;inset:0;
  background-image:radial-gradient(circle,rgba(255,255,255,0.07) 1px,transparent 1px);
  background-size:22px 22px;pointer-events:none;
}
.lp2-band-glow{
  position:absolute;bottom:-60px;right:-40px;
  width:240px;height:240px;border-radius:50%;
  background:radial-gradient(circle,rgba(255,255,255,0.12),transparent 65%);
  pointer-events:none;
}
/* Per-step band colors */
.lp2-band-read   {background:linear-gradient(150deg,#060D1F,#0F172A 40%,#1E3A5F);}
.lp2-band-understand{background:linear-gradient(150deg,#78350F,#B45309 40%,#D97706);}
.lp2-band-talk   {background:linear-gradient(150deg,#0C4A6E,#0369A1 40%,#0284C7);}
.lp2-band-do     {background:linear-gradient(150deg,#064E3B,#065F46 40%,#059669);}
.lp2-band-reflect{background:linear-gradient(150deg,#3B0764,#6D28D9 40%,#7C3AED);}
.lp2-band-prayer {background:linear-gradient(150deg,#4C0519,#881337 40%,#BE123C);}

.lp2-band-content{position:relative;z-index:2;}
.lp2-step-tag{
  display:inline-flex;align-items:center;gap:6px;
  background:rgba(255,255,255,0.14);border:1px solid rgba(255,255,255,0.22);
  color:white;padding:5px 13px;border-radius:100px;
  font-size:0.65rem;font-weight:800;letter-spacing:0.1em;
  text-transform:uppercase;margin-bottom:14px;
}
.lp2-lesson-title{
  font-family:var(--font-display);font-size:clamp(1.45rem,4.5vw,2rem);
  font-weight:700;color:white;line-height:1.15;margin-bottom:6px;
}
.lp2-lesson-sub{font-size:0.825rem;color:rgba(255,255,255,0.55);line-height:1.5;}

/* ── Content panels ── */
.lp2-content{padding:20px 16px;padding-bottom:20px;}

/* Read — verse card */
.lp2-verse-card{
  background:white;border-radius:22px;
  box-shadow:0 4px 24px rgba(0,0,0,0.1),0 1px 4px rgba(0,0,0,0.06);
  overflow:hidden;margin-bottom:14px;
  animation:lp2CardIn 0.45s cubic-bezier(0.34,1.2,0.64,1) both;
}
@keyframes lp2CardIn{from{opacity:0;transform:translateY(14px);}to{opacity:1;transform:translateY(0);}}
.lp2-verse-header{
  background:linear-gradient(135deg,#0F172A,#1E3A5F);
  padding:22px 22px 20px;position:relative;overflow:hidden;
}
.lp2-verse-header::before{
  content:'❝';position:absolute;top:4px;right:14px;
  font-size:5rem;opacity:0.05;font-family:Georgia;line-height:1;color:white;
}
.lp2-verse-ref-pill{
  display:inline-flex;align-items:center;gap:5px;
  background:rgba(245,158,11,0.2);border:1px solid rgba(245,158,11,0.4);
  color:var(--amber);padding:3px 10px;border-radius:100px;
  font-size:0.65rem;font-weight:800;letter-spacing:0.08em;
  text-transform:uppercase;margin-bottom:12px;
}
.lp2-verse-text{
  font-family:var(--font-display);font-size:1.05rem;line-height:1.8;
  color:rgba(255,255,255,0.95);position:relative;z-index:1;
}
.lp2-verse-footer{padding:14px 22px;border-top:1px solid var(--slate-100);}
.lp2-verse-translation{font-size:0.7rem;color:var(--slate-400);font-style:italic;}

/* Read — summary */
.lp2-summary{
  background:white;border-radius:18px;padding:18px 20px;
  box-shadow:0 2px 12px rgba(0,0,0,0.07);margin-bottom:14px;
  border-left:4px solid var(--amber);
  animation:lp2CardIn 0.45s 0.08s cubic-bezier(0.34,1.2,0.64,1) both;
}
.lp2-summary-label{font-size:0.65rem;font-weight:800;color:var(--gold);text-transform:uppercase;letter-spacing:0.1em;margin-bottom:8px;}
.lp2-summary-text{font-size:0.9rem;line-height:1.75;color:var(--slate-700);}

/* Understand — tier explanation */
.lp2-explain{
  background:linear-gradient(135deg,#FFFBF0,#FEF9EE);
  border-radius:18px;padding:18px 20px;margin-bottom:14px;
  border:1.5px solid rgba(245,158,11,0.25);
  animation:lp2CardIn 0.45s cubic-bezier(0.34,1.2,0.64,1) both;
}
.lp2-explain-tier{font-size:0.65rem;font-weight:800;color:var(--gold);text-transform:uppercase;letter-spacing:0.1em;margin-bottom:8px;}
.lp2-explain-text{font-size:0.9rem;line-height:1.75;color:var(--slate-700);}

/* Generic question cards */
.lp2-q-list{display:flex;flex-direction:column;gap:10px;margin-bottom:14px;}
.lp2-q{
  background:white;border-radius:16px;padding:16px 18px;
  box-shadow:0 2px 10px rgba(0,0,0,0.06);
  border-left:4px solid var(--slate-200);
  transition:border-color 0.2s;
  animation:lp2CardIn 0.4s calc(var(--i,0)*0.07s + 0.05s) cubic-bezier(0.34,1.2,0.64,1) both;
}
.lp2-q:hover{border-left-color:var(--amber);}
.lp2-q-num{font-size:0.62rem;font-weight:800;color:var(--amber-dark);text-transform:uppercase;letter-spacing:0.1em;margin-bottom:5px;}
.lp2-q-text{font-size:0.9rem;line-height:1.6;color:var(--slate-800);}

/* Talk — coaching note */
.lp2-coaching{
  background:linear-gradient(135deg,#EFF6FF,#DBEAFE);
  border-radius:16px;padding:16px 18px;margin-bottom:14px;
  border-left:4px solid #3B82F6;
  animation:lp2CardIn 0.4s 0.2s cubic-bezier(0.34,1.2,0.64,1) both;
}
.lp2-coaching-label{font-size:0.65rem;font-weight:800;color:#1D4ED8;text-transform:uppercase;letter-spacing:0.1em;margin-bottom:6px;}
.lp2-coaching-text{font-size:0.85rem;color:#1E3A5F;line-height:1.65;}

/* Do — mission cards */
.lp2-mission-list{display:flex;flex-direction:column;gap:12px;margin-bottom:16px;}
.lp2-mission{
  background:white;border-radius:18px;padding:18px;
  box-shadow:0 2px 12px rgba(0,0,0,0.07);
  border:2.5px solid transparent;cursor:pointer;
  transition:all 0.22s;
  animation:lp2CardIn 0.4s calc(var(--i,0)*0.08s) cubic-bezier(0.34,1.2,0.64,1) both;
}
.lp2-mission:hover{transform:translateY(-2px);box-shadow:0 8px 28px rgba(0,0,0,0.11);}
.lp2-mission.selected{border-color:var(--emerald);background:linear-gradient(135deg,#F0FDF4,white);}
.lp2-mission-top{display:flex;align-items:flex-start;gap:14px;margin-bottom:8px;}
.lp2-mission-emoji{font-size:2rem;line-height:1;flex-shrink:0;margin-top:2px;}
.lp2-mission-meta{flex:1;}
.lp2-mission-title{font-weight:800;font-size:0.9375rem;color:var(--slate-900);margin-bottom:4px;}
.lp2-mission-check{
  width:24px;height:24px;border-radius:50%;flex-shrink:0;
  border:2.5px solid var(--slate-200);
  display:flex;align-items:center;justify-content:center;
  font-size:0.7rem;color:white;transition:all 0.2s;margin-top:2px;
}
.lp2-mission.selected .lp2-mission-check{background:var(--emerald);border-color:var(--emerald);}
.lp2-mission-desc{font-size:0.83rem;color:var(--slate-600);line-height:1.6;}
.lp2-mission-footer{display:flex;align-items:center;gap:8px;margin-top:10px;padding-top:10px;border-top:1px solid var(--slate-100);}
.lp2-mission-badge{font-size:0.68rem;font-weight:700;padding:3px 9px;border-radius:100px;}
.lp2-badge-easy{background:#D1FAE5;color:#065F46;}
.lp2-badge-medium{background:#FEF3C7;color:#92400E;}
.lp2-badge-hard{background:#FFE4E6;color:#9F1239;}

/* Reflect — mood ring */
.lp2-mood-section{margin-bottom:18px;}
.lp2-mood-label{font-size:0.78rem;font-weight:700;color:var(--slate-700);margin-bottom:12px;}
.lp2-mood-grid{display:flex;gap:10px;flex-wrap:wrap;}
.lp2-mood-btn{
  font-size:1.9rem;cursor:pointer;padding:10px;
  border-radius:16px;border:2.5px solid transparent;
  transition:all 0.2s;background:white;
  box-shadow:0 2px 8px rgba(0,0,0,0.08);line-height:1;
}
.lp2-mood-btn:hover{transform:scale(1.12);}
.lp2-mood-btn.selected{
  border-color:var(--amber);background:var(--amber-light);
  transform:scale(1.2);box-shadow:0 4px 18px rgba(245,158,11,0.35);
}
/* Reflect — journal */
.lp2-journal{background:white;border-radius:18px;padding:18px 20px;box-shadow:0 2px 12px rgba(0,0,0,0.07);margin-bottom:14px;}
.lp2-journal-label{font-size:0.75rem;font-weight:700;color:var(--slate-600);margin-bottom:10px;line-height:1.5;}
.lp2-journal-input{
  width:100%;border:2px solid var(--slate-200);border-radius:12px;
  padding:13px 15px;font-family:var(--font-body);font-size:0.9rem;
  color:var(--slate-900);resize:none;outline:none;
  transition:border-color 0.2s,box-shadow 0.2s;line-height:1.65;
  background:#FAFBFC;
}
.lp2-journal-input:focus{border-color:var(--amber);box-shadow:0 0 0 4px rgba(245,158,11,0.1);background:white;}

/* Prayer builder */
.lp2-prayer-lines{display:flex;flex-direction:column;gap:12px;margin-bottom:18px;}
.lp2-prayer-row{display:flex;align-items:center;gap:12px;}
.lp2-prayer-who{
  display:flex;align-items:center;gap:5px;
  font-size:0.78rem;font-weight:700;color:var(--slate-600);
  min-width:68px;flex-shrink:0;
}
.lp2-prayer-input{
  flex:1;border:2px solid var(--slate-200);border-radius:12px;
  padding:11px 14px;font-family:var(--font-body);font-size:0.85rem;
  color:var(--slate-900);outline:none;
  transition:border-color 0.2s,box-shadow 0.2s;
}
.lp2-prayer-input:focus{border-color:#BE123C;box-shadow:0 0 0 4px rgba(190,18,60,0.08);}
.lp2-prayer-compile-btn{
  width:100%;padding:16px;border-radius:16px;border:none;
  background:linear-gradient(135deg,#881337,#BE123C);
  color:white;font-family:var(--font-body);font-weight:800;
  font-size:0.95rem;cursor:pointer;
  box-shadow:0 6px 20px rgba(136,19,55,0.35);
  transition:all 0.2s;
}
.lp2-prayer-compile-btn:hover{transform:translateY(-2px);box-shadow:0 10px 28px rgba(136,19,55,0.45);}
/* Prayer result */
.lp2-prayer-result{
  background:linear-gradient(150deg,#060D1F,#1E3A5F);
  border-radius:22px;padding:28px 24px;text-align:center;color:white;
  margin-top:18px;animation:lp2CardIn 0.5s cubic-bezier(0.34,1.2,0.64,1) both;
}
.lp2-prayer-result-icon{font-size:2.8rem;margin-bottom:12px;display:block;}
.lp2-prayer-result-title{font-family:var(--font-display);font-size:1.2rem;font-weight:700;margin-bottom:16px;}
.lp2-prayer-result-text{
  font-family:var(--font-display);font-size:0.95rem;
  line-height:1.85;color:rgba(255,255,255,0.88);
  font-style:italic;margin-bottom:16px;
}
.lp2-prayer-amen{font-size:0.85rem;font-weight:800;color:var(--amber);letter-spacing:0.1em;}

/* Complete banner */
.lp2-complete{
  background:linear-gradient(150deg,#064E3B,#059669);
  border-radius:22px;padding:32px 24px;text-align:center;color:white;margin-bottom:16px;
  animation:lp2CardIn 0.5s cubic-bezier(0.34,1.2,0.64,1) both;
}
.lp2-complete-stars{font-size:2.2rem;margin-bottom:8px;letter-spacing:4px;}
.lp2-complete-title{font-family:var(--font-display);font-size:1.5rem;font-weight:700;margin-bottom:6px;}
.lp2-complete-sub{font-size:0.875rem;color:rgba(255,255,255,0.75);line-height:1.6;}

/* Bottom bar */
.lp2-bar{
  padding:12px 16px max(16px,env(safe-area-inset-bottom));
  background:rgba(255,255,255,0.96);backdrop-filter:blur(14px);
  border-top:1px solid rgba(0,0,0,0.06);
  display:flex;gap:10px;flex-shrink:0;
  box-shadow:0 -4px 24px rgba(0,0,0,0.07);
}
.lp2-back-btn{
  padding:14px 20px;border-radius:14px;border:2px solid var(--slate-200);
  background:white;color:var(--slate-600);font-family:var(--font-body);
  font-weight:700;font-size:0.9rem;cursor:pointer;transition:all 0.18s;
  display:none;
}
.lp2-back-btn:hover{background:var(--slate-50);border-color:var(--slate-300);}
.lp2-next-btn{
  flex:1;padding:16px;border-radius:14px;border:none;
  background:var(--slate-900);color:white;
  font-family:var(--font-body);font-weight:800;font-size:1rem;
  cursor:pointer;transition:all 0.2s;
  box-shadow:0 4px 16px rgba(0,0,0,0.18);
}
.lp2-next-btn:hover{background:#0F172A;transform:translateY(-1px);box-shadow:0 8px 24px rgba(0,0,0,0.22);}
.lp2-next-btn.complete{background:linear-gradient(135deg,var(--emerald),#059669);}

/* Step-specific next button colors */
.lp2-next-btn.clr-read   {background:linear-gradient(135deg,#1E3A5F,#0F3460);}
.lp2-next-btn.clr-understand{background:linear-gradient(135deg,#B45309,#D97706);}
.lp2-next-btn.clr-talk   {background:linear-gradient(135deg,#0369A1,#0284C7);}
.lp2-next-btn.clr-do     {background:linear-gradient(135deg,#065F46,#059669);}
.lp2-next-btn.clr-reflect{background:linear-gradient(135deg,#6D28D9,#7C3AED);}
.lp2-next-btn.clr-prayer {background:linear-gradient(135deg,#881337,#BE123C);}

/* Section label */
.lp2-section-label{
  font-size:0.68rem;font-weight:800;color:var(--slate-400);
  text-transform:uppercase;letter-spacing:0.1em;
  margin-bottom:10px;margin-top:4px;
}

/* Step transition */
@keyframes lp2StepIn{from{opacity:0;transform:translateX(16px);}to{opacity:1;transform:translateX(0);}}
.lp2-step-in{animation:lp2StepIn 0.3s cubic-bezier(0.34,1.1,0.64,1) both;}

/* ===== MISSION CHECK-IN ===== */
#screen-checkin{background:#F0F4F8;}

/* Nav */
.ci-nav{
  display:flex;align-items:center;gap:12px;
  padding:12px 16px;background:white;
  border-bottom:1px solid rgba(0,0,0,0.06);
  flex-shrink:0;box-shadow:0 2px 12px rgba(0,0,0,0.05);
}
.ci-close{
  width:34px;height:34px;border-radius:10px;border:none;
  background:var(--slate-100);color:var(--slate-500);
  display:flex;align-items:center;justify-content:center;
  font-size:0.9rem;cursor:pointer;flex-shrink:0;
  transition:all 0.18s;font-family:var(--font-body);
}
.ci-close:hover{background:var(--slate-200);}
.ci-track{flex:1;display:flex;gap:5px;align-items:center;}
.ci-pip{
  flex:1;height:5px;border-radius:100px;background:var(--slate-200);
  transition:all 0.4s cubic-bezier(0.34,1.2,0.64,1);
}
.ci-pip.done{background:var(--emerald);}
.ci-pip.active{background:var(--amber);box-shadow:0 0 8px rgba(245,158,11,0.5);}

.ci-scroll{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;}

/* ── Step 1: Mission confirm ── */
.ci-confirm-hero{
  background:linear-gradient(155deg,#064E3B,#059669 55%,#10B981);
  padding:44px 24px 56px;text-align:center;position:relative;overflow:hidden;
}
.ci-confirm-grid{position:absolute;inset:0;background-image:radial-gradient(circle,rgba(255,255,255,0.07) 1px,transparent 1px);background-size:22px 22px;pointer-events:none;}
.ci-confirm-glow{position:absolute;bottom:-60px;left:50%;transform:translateX(-50%);width:280px;height:280px;border-radius:50%;background:radial-gradient(circle,rgba(255,255,255,0.12),transparent 65%);pointer-events:none;}
.ci-confirm-content{position:relative;z-index:2;}
.ci-confirm-ring{
  width:88px;height:88px;border-radius:50%;
  background:rgba(255,255,255,0.15);border:3px solid rgba(255,255,255,0.3);
  display:flex;align-items:center;justify-content:center;
  font-size:2.8rem;margin:0 auto 20px;
  animation:confirmPop 0.6s cubic-bezier(0.34,1.5,0.64,1) both;
}
@keyframes confirmPop{from{opacity:0;transform:scale(0.4);}to{opacity:1;transform:scale(1);}}
.ci-confirm-tag{display:inline-flex;align-items:center;gap:5px;background:rgba(255,255,255,0.18);border:1px solid rgba(255,255,255,0.25);color:white;padding:4px 12px;border-radius:100px;font-size:0.65rem;font-weight:800;letter-spacing:0.1em;text-transform:uppercase;margin-bottom:12px;}
.ci-confirm-title{font-family:var(--font-display);font-size:1.6rem;font-weight:800;color:white;line-height:1.2;margin-bottom:6px;}
.ci-confirm-mission{font-size:0.875rem;color:rgba(255,255,255,0.7);line-height:1.5;}

.ci-confirm-body{padding:20px 16px;}
.ci-mission-recap{
  background:white;border-radius:20px;padding:18px 20px;
  box-shadow:0 4px 20px rgba(0,0,0,0.09);margin-bottom:14px;
  display:flex;align-items:center;gap:16px;
  animation:lp2CardIn 0.4s cubic-bezier(0.34,1.2,0.64,1) both;
}
.ci-recap-icon{
  width:52px;height:52px;border-radius:16px;
  background:var(--emerald-light);
  display:flex;align-items:center;justify-content:center;
  font-size:1.8rem;flex-shrink:0;
}
.ci-recap-info{flex:1;}
.ci-recap-label{font-size:0.62rem;font-weight:800;color:var(--emerald);text-transform:uppercase;letter-spacing:0.1em;margin-bottom:4px;}
.ci-recap-name{font-weight:800;font-size:0.9375rem;color:var(--slate-900);margin-bottom:2px;}
.ci-recap-desc{font-size:0.78rem;color:var(--slate-500);line-height:1.4;}

/* ── Step 2: Story + mood ── */
.ci-story-hero{
  background:linear-gradient(155deg,#0C4A6E,#0369A1 55%,#0284C7);
  padding:36px 24px 48px;text-align:center;position:relative;overflow:hidden;
}
.ci-story-icon{font-size:3rem;margin-bottom:12px;display:block;animation:confirmPop 0.5s cubic-bezier(0.34,1.4,0.64,1) both;}
.ci-story-title{font-family:var(--font-display);font-size:1.45rem;font-weight:800;color:white;margin-bottom:4px;}
.ci-story-sub{font-size:0.8rem;color:rgba(255,255,255,0.6);}

.ci-story-body{padding:20px 16px;}
.ci-card{
  background:white;border-radius:20px;padding:18px 20px;
  box-shadow:0 3px 16px rgba(0,0,0,0.08);margin-bottom:14px;
}
.ci-card-label{font-size:0.68rem;font-weight:800;color:var(--slate-500);text-transform:uppercase;letter-spacing:0.1em;margin-bottom:12px;}
/* Mood buttons */
.ci-mood-grid{display:flex;gap:10px;flex-wrap:wrap;}
.ci-mood-btn{
  font-size:2rem;cursor:pointer;padding:10px;
  border-radius:16px;border:2.5px solid transparent;
  transition:all 0.2s;background:var(--slate-50);line-height:1;
}
.ci-mood-btn:hover{transform:scale(1.1);}
.ci-mood-btn.selected{
  border-color:var(--amber);background:var(--amber-light);
  transform:scale(1.2);box-shadow:0 4px 16px rgba(245,158,11,0.3);
}
/* Reflection textarea */
.ci-textarea{
  width:100%;border:2px solid var(--slate-200);border-radius:14px;
  padding:14px 16px;font-family:var(--font-body);font-size:0.9rem;
  color:var(--slate-900);resize:none;outline:none;line-height:1.7;
  background:#FAFBFC;transition:border-color 0.2s,box-shadow 0.2s;
}
.ci-textarea:focus{border-color:#0369A1;box-shadow:0 0 0 4px rgba(3,105,161,0.1);background:white;}
.ci-char-count{font-size:0.68rem;color:var(--slate-400);text-align:right;margin-top:6px;}

/* Photo prompt */
.ci-photo-prompt{
  display:flex;align-items:center;gap:14px;
  border:2px dashed var(--slate-200);border-radius:16px;
  padding:16px 18px;cursor:pointer;transition:all 0.2s;
}
.ci-photo-prompt:hover{border-color:var(--slate-300);background:var(--slate-50);}
.ci-photo-icon{font-size:1.8rem;flex-shrink:0;}
.ci-photo-text{font-size:0.82rem;color:var(--slate-500);line-height:1.4;}
.ci-photo-text strong{color:var(--slate-700);display:block;margin-bottom:2px;}

/* ── Step 3: Success ── */
.ci-success{
  display:flex;flex-direction:column;align-items:center;
  justify-content:center;padding:48px 24px;min-height:70vh;text-align:center;
}
.ci-success-ring{
  width:120px;height:120px;border-radius:50%;
  background:linear-gradient(135deg,#D1FAE5,#A7F3D0);
  border:4px solid var(--emerald);
  display:flex;align-items:center;justify-content:center;
  font-size:3.5rem;margin-bottom:24px;
  animation:successRing 0.7s cubic-bezier(0.34,1.6,0.64,1) both;
}
@keyframes successRing{from{opacity:0;transform:scale(0.3) rotate(-15deg);}to{opacity:1;transform:scale(1) rotate(0deg);}}
.ci-success-confetti{font-size:1.8rem;letter-spacing:8px;margin-bottom:16px;animation:confettiFall 0.5s 0.3s ease both;opacity:0;}
@keyframes confettiFall{from{opacity:0;transform:translateY(-10px);}to{opacity:1;transform:translateY(0);}}
.ci-success-title{font-family:var(--font-display);font-size:1.8rem;font-weight:800;color:var(--slate-900);margin-bottom:8px;}
.ci-success-sub{font-size:0.9rem;color:var(--slate-500);line-height:1.65;max-width:280px;margin-bottom:32px;}
/* XP burst */
.ci-xp-burst{
  background:linear-gradient(135deg,var(--amber),#F97316);
  border-radius:20px;padding:16px 28px;margin-bottom:28px;
  display:flex;align-items:center;gap:12px;
  box-shadow:0 8px 28px rgba(245,158,11,0.35);
  animation:xpBurst 0.6s 0.5s cubic-bezier(0.34,1.4,0.64,1) both;opacity:0;
}
@keyframes xpBurst{from{opacity:0;transform:scale(0.7);}to{opacity:1;transform:scale(1);}}
.ci-xp-icon{font-size:1.8rem;}
.ci-xp-text{text-align:left;}
.ci-xp-val{font-family:var(--font-display);font-size:1.3rem;font-weight:900;color:white;line-height:1;}
.ci-xp-lbl{font-size:0.72rem;color:rgba(255,255,255,0.75);font-weight:700;margin-top:2px;}
.ci-success-note{font-size:0.8rem;color:var(--slate-400);margin-bottom:32px;line-height:1.6;}
.ci-done-btn{
  width:100%;max-width:280px;padding:16px;border-radius:16px;border:none;
  background:var(--slate-900);color:white;
  font-family:var(--font-body);font-weight:800;font-size:1rem;
  cursor:pointer;transition:all 0.2s;
  box-shadow:0 4px 16px rgba(0,0,0,0.15);
}
.ci-done-btn:hover{transform:translateY(-2px);box-shadow:0 8px 24px rgba(0,0,0,0.2);}

/* Bottom CTA bar */
.ci-bar{
  padding:12px 16px max(16px,env(safe-area-inset-bottom));
  background:rgba(255,255,255,0.96);backdrop-filter:blur(14px);
  border-top:1px solid rgba(0,0,0,0.06);
  flex-shrink:0;box-shadow:0 -4px 24px rgba(0,0,0,0.07);
}
.ci-next-btn{
  width:100%;padding:16px;border-radius:14px;border:none;
  background:var(--emerald);color:white;
  font-family:var(--font-body);font-weight:800;font-size:1rem;
  cursor:pointer;transition:all 0.2s;
  box-shadow:0 4px 16px rgba(5,150,105,0.35);
}
.ci-next-btn:hover{transform:translateY(-1px);box-shadow:0 8px 24px rgba(5,150,105,0.45);}

/* ===== TEEN JOURNAL ===== */

/* Hero */
.jn-hero{
  background:linear-gradient(155deg,#1E0A3C 0%,#3B0764 45%,#6D28D9 100%);
  padding:32px 20px 44px;position:relative;overflow:hidden;
}
.jn-hero-grid{position:absolute;inset:0;background-image:radial-gradient(circle,rgba(255,255,255,0.06) 1px,transparent 1px);background-size:22px 22px;pointer-events:none;}
.jn-hero-glow{position:absolute;top:-60px;right:-40px;width:260px;height:260px;border-radius:50%;background:radial-gradient(circle,rgba(167,139,250,0.18),transparent 65%);pointer-events:none;}
.jn-hero-content{position:relative;z-index:2;}
.jn-hero-top{display:flex;align-items:center;gap:14px;margin-bottom:20px;}
.jn-hero-icon{width:56px;height:56px;border-radius:18px;background:rgba(167,139,250,0.2);border:1.5px solid rgba(167,139,250,0.35);display:flex;align-items:center;justify-content:center;font-size:1.8rem;flex-shrink:0;}
.jn-hero-name{font-family:var(--font-display);font-size:1.35rem;font-weight:700;color:white;margin-bottom:2px;}
.jn-hero-sub{font-size:0.72rem;color:rgba(255,255,255,0.45);font-weight:600;}
.jn-streak-row{display:flex;gap:8px;}
.jn-stat{flex:1;background:rgba(255,255,255,0.07);border:1px solid rgba(255,255,255,0.1);border-radius:14px;padding:10px 8px;text-align:center;}
.jn-stat-val{font-family:var(--font-display);font-size:1.2rem;font-weight:800;color:white;display:block;line-height:1;}
.jn-stat-lbl{font-size:0.6rem;font-weight:700;color:rgba(255,255,255,0.4);text-transform:uppercase;letter-spacing:0.07em;margin-top:3px;display:block;}

/* Body */
.jn-body{padding:16px 16px 100px;}
.jn-section-hd{display:flex;align-items:center;justify-content:space-between;margin:18px 0 10px;}
.jn-section-title{font-family:var(--font-display);font-size:1rem;font-weight:700;color:var(--slate-900);}
.jn-section-sub{font-size:0.72rem;color:var(--slate-400);font-weight:600;}

/* New entry composer */
.jn-composer{
  background:white;border-radius:22px;
  box-shadow:0 4px 24px rgba(109,40,217,0.1),0 1px 4px rgba(0,0,0,0.06);
  overflow:hidden;margin-bottom:16px;
  animation:lp2CardIn 0.4s cubic-bezier(0.34,1.2,0.64,1) both;
}
.jn-composer-header{
  background:linear-gradient(135deg,#3B0764,#6D28D9);
  padding:16px 20px;display:flex;align-items:center;justify-content:space-between;
}
.jn-composer-title{font-weight:800;font-size:0.9rem;color:white;}
.jn-composer-date{font-size:0.7rem;color:rgba(255,255,255,0.5);}
.jn-composer-body{padding:16px 20px 20px;}

/* AI prompt chip */
.jn-prompt-row{display:flex;gap:8px;margin-bottom:14px;flex-wrap:wrap;}
.jn-prompt-chip{
  display:flex;align-items:center;gap:6px;
  background:linear-gradient(135deg,#EDE9FE,#F5F3FF);
  border:1.5px solid rgba(109,40,217,0.2);
  border-radius:100px;padding:6px 12px;
  font-size:0.72rem;font-weight:700;color:#5B21B6;
  cursor:pointer;transition:all 0.2s;white-space:nowrap;
}
.jn-prompt-chip:hover{background:linear-gradient(135deg,#DDD6FE,#EDE9FE);transform:translateY(-1px);}
.jn-prompt-chip.active{background:linear-gradient(135deg,#6D28D9,#7C3AED);color:white;border-color:transparent;}
.jn-prompt-chip-icon{font-size:0.85rem;}
.jn-prompt-chip-generate{
  background:linear-gradient(135deg,#1E0A3C,#3B0764);
  border-color:transparent;color:rgba(255,255,255,0.8);
}
.jn-prompt-chip-generate:hover{background:linear-gradient(135deg,#3B0764,#6D28D9);color:white;}

/* AI generating state */
.jn-ai-generating{
  display:flex;align-items:center;gap:8px;
  background:linear-gradient(135deg,#EDE9FE,#F5F3FF);
  border-radius:12px;padding:10px 14px;margin-bottom:14px;
  font-size:0.8rem;color:#5B21B6;font-weight:600;
}
.jn-ai-dot{width:6px;height:6px;border-radius:50%;background:#7C3AED;animation:dotPulse 1.2s ease-in-out infinite;}

/* Textarea */
.jn-textarea{
  width:100%;border:2px solid var(--slate-200);border-radius:14px;
  padding:14px 16px;font-family:var(--font-body);font-size:0.9rem;
  color:var(--slate-900);resize:none;outline:none;line-height:1.75;
  background:#FAFBFC;transition:border-color 0.2s,box-shadow 0.2s;
  min-height:120px;
}
.jn-textarea:focus{border-color:#7C3AED;box-shadow:0 0 0 4px rgba(124,58,237,0.1);background:white;}
.jn-composer-footer{display:flex;align-items:center;justify-content:space-between;margin-top:12px;}
.jn-char-count{font-size:0.68rem;color:var(--slate-400);}
.jn-save-btn{
  padding:11px 22px;border-radius:12px;border:none;
  background:linear-gradient(135deg,#6D28D9,#7C3AED);
  color:white;font-family:var(--font-body);font-weight:800;
  font-size:0.875rem;cursor:pointer;transition:all 0.2s;
  box-shadow:0 4px 14px rgba(109,40,217,0.35);
}
.jn-save-btn:hover{transform:translateY(-1px);box-shadow:0 6px 20px rgba(109,40,217,0.45);}
.jn-save-btn:disabled{opacity:0.5;cursor:not-allowed;transform:none;}

/* Past entries */
.jn-entry{
  background:white;border-radius:18px;padding:18px 20px;
  box-shadow:0 2px 12px rgba(0,0,0,0.07);margin-bottom:10px;
  border-left:4px solid #7C3AED;
  animation:lp2CardIn 0.4s calc(var(--i,0)*0.06s) cubic-bezier(0.34,1.2,0.64,1) both;
  cursor:pointer;transition:box-shadow 0.2s;
}
.jn-entry:hover{box-shadow:0 4px 20px rgba(109,40,217,0.12);}
.jn-entry-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;}
.jn-entry-date{font-size:0.68rem;font-weight:700;color:#7C3AED;text-transform:uppercase;letter-spacing:0.08em;}
.jn-entry-mood{font-size:1.2rem;}
.jn-entry-prompt{font-size:0.72rem;color:var(--slate-400);margin-bottom:6px;font-style:italic;}
.jn-entry-text{font-size:0.875rem;color:var(--slate-700);line-height:1.65;}
.jn-entry-text.collapsed{display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden;}
.jn-entry-lesson{display:inline-flex;align-items:center;gap:4px;margin-top:8px;background:var(--slate-100);border-radius:100px;padding:3px 9px;font-size:0.65rem;font-weight:700;color:var(--slate-500);}

/* Empty state */
.jn-empty{background:white;border-radius:22px;padding:36px 24px;text-align:center;box-shadow:0 2px 12px rgba(0,0,0,0.06);}
.jn-empty-icon{font-size:3rem;margin-bottom:12px;display:block;}
.jn-empty-title{font-weight:800;font-size:1rem;color:var(--slate-700);margin-bottom:6px;}
.jn-empty-sub{font-size:0.82rem;color:var(--slate-400);line-height:1.6;}

/* Gemini badge */
.jn-gemini-badge{display:inline-flex;align-items:center;gap:5px;background:linear-gradient(135deg,#1A73E8,#4285F4);border-radius:100px;padding:3px 10px;font-size:0.62rem;font-weight:800;color:white;letter-spacing:0.05em;}


/* Gemini AI deeper explanation */
.lp2-gemini-btn{
  width:100%;padding:13px;border-radius:14px;border:none;
  background:linear-gradient(135deg,#1A73E8,#4285F4);
  color:white;font-family:var(--font-body);font-weight:800;
  font-size:0.875rem;cursor:pointer;transition:all 0.2s;
  box-shadow:0 4px 14px rgba(66,133,244,0.35);
  margin:4px 0 14px;display:flex;align-items:center;justify-content:center;gap:8px;
}
.lp2-gemini-btn:hover{transform:translateY(-1px);box-shadow:0 6px 20px rgba(66,133,244,0.45);}
.lp2-gemini-btn:disabled{opacity:0.6;cursor:not-allowed;transform:none;}
.lp2-gemini-loading{
  display:flex;align-items:center;gap:10px;
  background:linear-gradient(135deg,#EFF6FF,#DBEAFE);
  border-radius:14px;padding:14px 16px;margin-bottom:14px;
  font-size:0.82rem;color:#1D4ED8;font-weight:600;
}
.lp2-gemini-result{
  background:linear-gradient(135deg,#EFF6FF,white);
  border:1.5px solid rgba(66,133,244,0.2);
  border-radius:16px;padding:18px 20px;margin-bottom:14px;
  animation:lp2CardIn 0.4s cubic-bezier(0.34,1.2,0.64,1) both;
}
.lp2-gemini-label{
  display:inline-flex;align-items:center;gap:5px;
  background:linear-gradient(135deg,#1A73E8,#4285F4);
  border-radius:100px;padding:3px 10px;
  font-size:0.62rem;font-weight:800;color:white;
  letter-spacing:0.05em;margin-bottom:10px;
}
.lp2-gemini-text{font-size:0.875rem;line-height:1.75;color:var(--slate-700);}
.lp2-gemini-q{
  background:white;border-radius:12px;padding:12px 14px;
  margin-top:10px;border-left:3px solid #4285F4;
  font-size:0.875rem;color:var(--slate-800);line-height:1.55;
}
.lp2-gemini-q-num{font-size:0.62rem;font-weight:800;color:#1A73E8;text-transform:uppercase;letter-spacing:0.1em;margin-bottom:4px;}

/* ===== APPROVAL FLOW POLISH ===== */
.ap-hero{
  background:linear-gradient(155deg,#064E3B,#059669 55%,#10B981);
  padding:28px 20px 36px;position:relative;overflow:hidden;
}
.ap-hero-grid{position:absolute;inset:0;background-image:radial-gradient(circle,rgba(255,255,255,0.07) 1px,transparent 1px);background-size:20px 20px;pointer-events:none;}
.ap-hero-glow{position:absolute;bottom:-50px;right:-30px;width:220px;height:220px;border-radius:50%;background:radial-gradient(circle,rgba(255,255,255,0.1),transparent 65%);pointer-events:none;}
.ap-hero-content{position:relative;z-index:2;}
.ap-hero-top{display:flex;align-items:center;gap:14px;margin-bottom:18px;}
.ap-hero-icon{width:52px;height:52px;border-radius:16px;background:rgba(255,255,255,0.15);border:1.5px solid rgba(255,255,255,0.25);display:flex;align-items:center;justify-content:center;font-size:1.8rem;flex-shrink:0;}
.ap-hero-title{font-family:var(--font-display);font-size:1.35rem;font-weight:700;color:white;margin-bottom:2px;}
.ap-hero-sub{font-size:0.72rem;color:rgba(255,255,255,0.55);font-weight:600;}
.ap-stats{display:flex;gap:8px;}
.ap-stat{flex:1;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.15);border-radius:12px;padding:10px 8px;text-align:center;}
.ap-stat-val{font-family:var(--font-display);font-size:1.2rem;font-weight:800;color:white;display:block;line-height:1;}
.ap-stat-lbl{font-size:0.6rem;font-weight:700;color:rgba(255,255,255,0.5);text-transform:uppercase;letter-spacing:0.06em;margin-top:3px;display:block;}

/* Approval card */
.ap-body{padding:16px 16px 100px;}
.ap-section-hd{display:flex;align-items:center;justify-content:space-between;margin:18px 0 10px;}
.ap-section-title{font-family:var(--font-display);font-size:1rem;font-weight:700;color:var(--slate-900);}
.ap-section-count{font-size:0.72rem;font-weight:700;color:var(--slate-400);}

.ap-card{
  background:white;border-radius:20px;
  box-shadow:0 4px 20px rgba(0,0,0,0.09);
  overflow:hidden;margin-bottom:12px;
  animation:lp2CardIn 0.4s calc(var(--i,0)*0.07s) cubic-bezier(0.34,1.2,0.64,1) both;
}
.ap-card-banner{
  background:linear-gradient(135deg,#0F172A,#1E3A5F);
  padding:14px 18px;display:flex;align-items:center;gap:12px;
}
.ap-card-avatar{width:40px;height:40px;border-radius:12px;background:rgba(255,255,255,0.1);border:1.5px solid rgba(255,255,255,0.2);display:flex;align-items:center;justify-content:center;font-size:1.4rem;flex-shrink:0;}
.ap-card-who{font-weight:800;font-size:0.9rem;color:white;}
.ap-card-mission{font-size:0.72rem;color:rgba(255,255,255,0.55);margin-top:1px;}
.ap-card-mood{font-size:1.5rem;margin-left:auto;flex-shrink:0;}

.ap-card-body{padding:14px 18px 16px;}
.ap-card-reflection{
  background:var(--slate-50);border-radius:12px;
  padding:12px 14px;margin-bottom:14px;
  font-size:0.85rem;color:var(--slate-700);
  line-height:1.65;font-style:italic;
  border-left:3px solid var(--emerald);
}
.ap-card-date{font-size:0.68rem;color:var(--slate-400);margin-bottom:12px;}

/* Praise message input */
.ap-praise-row{margin-bottom:14px;}
.ap-praise-label{font-size:0.68rem;font-weight:800;color:var(--slate-500);text-transform:uppercase;letter-spacing:0.1em;margin-bottom:7px;}
.ap-praise-input{
  width:100%;border:2px solid var(--slate-200);border-radius:12px;
  padding:11px 14px;font-family:var(--font-body);font-size:0.85rem;
  color:var(--slate-900);outline:none;
  transition:border-color 0.2s,box-shadow 0.2s;background:#FAFBFC;
}
.ap-praise-input:focus{border-color:var(--emerald);box-shadow:0 0 0 4px rgba(5,150,105,0.1);background:white;}
.ap-praise-suggestions{display:flex;gap:6px;flex-wrap:wrap;margin-top:7px;}
.ap-praise-chip{
  background:var(--emerald-light);border:1px solid rgba(5,150,105,0.2);
  border-radius:100px;padding:4px 10px;
  font-size:0.68rem;font-weight:700;color:var(--emerald);
  cursor:pointer;transition:all 0.15s;white-space:nowrap;
}
.ap-praise-chip:hover{background:#A7F3D0;transform:translateY(-1px);}

.ap-card-actions{display:flex;gap:8px;}
.ap-decline-btn{
  padding:12px 18px;border-radius:12px;border:2px solid var(--slate-200);
  background:white;color:var(--slate-500);font-family:var(--font-body);
  font-weight:700;font-size:0.85rem;cursor:pointer;transition:all 0.18s;
}
.ap-decline-btn:hover{border-color:var(--rose);color:var(--rose);}
.ap-approve-btn{
  flex:1;padding:12px;border-radius:12px;border:none;
  background:linear-gradient(135deg,#059669,#10B981);
  color:white;font-family:var(--font-body);font-weight:800;
  font-size:0.9rem;cursor:pointer;transition:all 0.2s;
  box-shadow:0 4px 14px rgba(5,150,105,0.35);
}
.ap-approve-btn:hover{transform:translateY(-1px);box-shadow:0 6px 20px rgba(5,150,105,0.45);}

/* Approved history */
.ap-history{
  background:white;border-radius:16px;padding:14px 16px;
  box-shadow:0 2px 10px rgba(0,0,0,0.06);margin-bottom:8px;
  display:flex;align-items:center;gap:12px;
}
.ap-history-check{width:36px;height:36px;border-radius:10px;background:var(--emerald-light);display:flex;align-items:center;justify-content:center;font-size:1rem;flex-shrink:0;color:var(--emerald);font-weight:900;}
.ap-history-info{flex:1;}
.ap-history-name{font-weight:700;font-size:0.875rem;color:var(--slate-900);}
.ap-history-meta{font-size:0.7rem;color:var(--slate-400);margin-top:2px;}
.ap-history-praise{font-size:0.75rem;color:var(--emerald);font-style:italic;margin-top:3px;}

/* Empty state */
.ap-empty{background:white;border-radius:22px;padding:40px 24px;text-align:center;box-shadow:0 2px 12px rgba(0,0,0,0.06);}
/* ===== PWA ===== */
@keyframes slideUpBanner{from{opacity:0;transform:translateY(20px);}to{opacity:1;transform:translateY(0);}}

/* ===== VIEW SWITCHER ===== */
/* Parent app header — richer */
.parent-topbar{
  display:flex;align-items:center;justify-content:space-between;
  padding:0 20px;height:60px;
  background:white;border-bottom:1px solid var(--slate-200);
  position:sticky;top:0;z-index:100;
  box-shadow:0 1px 8px rgba(0,0,0,0.04);
  flex-shrink:0;
}
.parent-topbar-logo{display:flex;align-items:center;gap:8px;text-decoration:none;}
.parent-topbar-logo-icon{width:32px;height:32px;background:linear-gradient(135deg,var(--amber),var(--amber-dark));border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:16px;}
.parent-topbar-logo-text{font-family:var(--font-display);font-size:1.1rem;font-weight:700;color:var(--slate-900);}
.parent-topbar-right{display:flex;align-items:center;gap:8px;}
/* Kid switcher pill inside parent topbar */
.kid-switcher{
  display:flex;align-items:center;gap:4px;
  background:var(--slate-100);border-radius:100px;padding:4px;
  max-width:220px;overflow-x:auto;scrollbar-width:none;
}
.kid-switcher::-webkit-scrollbar{display:none;}
.kid-switcher-pill{
  display:flex;align-items:center;gap:5px;
  padding:5px 12px;border-radius:100px;
  font-size:0.75rem;font-weight:600;cursor:pointer;
  white-space:nowrap;transition:all 0.18s;
  border:none;background:transparent;font-family:var(--font-body);color:var(--slate-600);
}
.kid-switcher-pill:hover{background:rgba(0,0,0,0.06);color:var(--slate-900);}
.kid-switcher-pill.active{background:white;color:var(--slate-900);box-shadow:0 1px 6px rgba(0,0,0,0.1);}
.kid-switcher-avatar{font-size:1rem;line-height:1;}

/* Kid app — mode banner at top */
.kid-mode-bar{
  display:flex;align-items:center;justify-content:space-between;
  padding:0 16px;height:48px;
  background:var(--slate-900);
  flex-shrink:0;
}
.kid-mode-left{display:flex;align-items:center;gap:8px;}
.kid-mode-logo{font-family:var(--font-display);font-size:0.9rem;font-weight:700;color:rgba(255,255,255,0.7);}
.kid-mode-sep{color:rgba(255,255,255,0.3);font-size:0.75rem;}
.kid-mode-name{font-size:0.875rem;font-weight:700;color:white;display:flex;align-items:center;gap:6px;}
/* Multi-kid switcher row inside kid app */
.kid-profile-switcher{
  display:flex;gap:6px;overflow-x:auto;scrollbar-width:none;
  background:rgba(255,255,255,0.08);padding:6px 16px;
}
.kid-profile-switcher::-webkit-scrollbar{display:none;}
.kid-profile-pill{
  display:flex;align-items:center;gap:6px;
  padding:6px 14px;border-radius:100px;
  font-size:0.78rem;font-weight:600;cursor:pointer;
  white-space:nowrap;transition:all 0.18s;
  border:2px solid transparent;color:rgba(255,255,255,0.6);
  background:transparent;font-family:var(--font-body);
}
.kid-profile-pill:hover{color:white;border-color:rgba(255,255,255,0.2);}
.kid-profile-pill.active{background:rgba(255,255,255,0.15);color:white;border-color:rgba(255,255,255,0.3);}
/* Back to parent button in kid mode */
.back-to-parent-btn{
  display:flex;align-items:center;gap:6px;
  padding:6px 14px;border-radius:100px;
  background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);
  color:rgba(255,255,255,0.8);font-size:0.75rem;font-weight:600;
  cursor:pointer;font-family:var(--font-body);transition:all 0.18s;
}
.back-to-parent-btn:hover{background:rgba(255,255,255,0.2);color:white;}
/* Transition animation */
@keyframes slideInRight{from{opacity:0;transform:translateX(12px);}to{opacity:1;transform:translateX(0);}}
@keyframes slideInLeft{from{opacity:0;transform:translateX(-12px);}to{opacity:1;transform:translateX(0);}}
.slide-in-right{animation:slideInRight 0.25s ease both;}
.slide-in-left{animation:slideInLeft 0.25s ease both;}
/* ===== KID REWARDS SCREEN ===== */

/* Hero trophy zone */
.rw-hero{
  background:linear-gradient(155deg,#060D1F 0%,#0C1F3F 45%,#1A3A5C 100%);
  padding:32px 20px 44px;position:relative;overflow:hidden;
}
.rw-hero-stars{position:absolute;inset:0;pointer-events:none;}
.rw-hero-star{position:absolute;border-radius:50%;background:white;animation:starTwinkle var(--dur,3s) ease-in-out infinite;}
.rw-hero-glow{position:absolute;top:-60px;right:-40px;width:240px;height:240px;border-radius:50%;background:radial-gradient(circle,rgba(245,158,11,0.16),transparent 65%);pointer-events:none;}
.rw-hero-content{position:relative;z-index:2;}
.rw-hero-top{display:flex;align-items:center;gap:16px;margin-bottom:22px;}
.rw-trophy{
  width:64px;height:64px;border-radius:20px;
  background:linear-gradient(135deg,rgba(245,158,11,0.25),rgba(245,158,11,0.1));
  border:1.5px solid rgba(245,158,11,0.35);
  display:flex;align-items:center;justify-content:center;font-size:2.2rem;
  flex-shrink:0;
}
.rw-hero-name{font-family:var(--font-display);font-size:1.45rem;font-weight:700;color:white;margin-bottom:2px;}
.rw-hero-level{font-size:0.75rem;color:rgba(255,255,255,0.5);font-weight:600;}
.rw-xp-section{}
.rw-xp-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;}
.rw-xp-label{font-size:0.68rem;font-weight:800;color:rgba(255,255,255,0.4);text-transform:uppercase;letter-spacing:0.12em;}
.rw-xp-val{font-size:0.78rem;font-weight:800;color:var(--amber);}
.rw-xp-track{height:8px;background:rgba(255,255,255,0.1);border-radius:100px;overflow:hidden;}
.rw-xp-fill{height:100%;background:linear-gradient(90deg,var(--amber),#F97316);border-radius:100px;transition:width 1.2s cubic-bezier(0.34,1.2,0.64,1);}
.rw-xp-next{font-size:0.68rem;color:rgba(255,255,255,0.35);margin-top:6px;}

/* Stats pills row */
.rw-stats{display:flex;gap:8px;margin-top:20px;}
.rw-stat{
  flex:1;background:rgba(255,255,255,0.07);border:1px solid rgba(255,255,255,0.1);
  border-radius:14px;padding:12px 8px;text-align:center;
}
.rw-stat-val{font-family:var(--font-display);font-size:1.3rem;font-weight:800;color:white;display:block;line-height:1;}
.rw-stat-lbl{font-size:0.62rem;font-weight:700;color:rgba(255,255,255,0.4);text-transform:uppercase;letter-spacing:0.07em;margin-top:4px;display:block;}

/* Body */
.rw-body{padding:16px 16px 100px;}

/* Section header */
.rw-section-hd{display:flex;align-items:center;justify-content:space-between;margin:20px 0 12px;}
.rw-section-title{font-family:var(--font-display);font-size:1rem;font-weight:700;color:var(--slate-900);}
.rw-section-count{font-size:0.72rem;font-weight:700;color:var(--slate-400);}

/* Badge grid */
.rw-badge-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;}

/* Earned badge */
.rw-badge{
  background:white;border-radius:18px;padding:16px 10px 14px;
  text-align:center;border:2px solid transparent;
  box-shadow:0 2px 10px rgba(0,0,0,0.07);
  transition:all 0.22s;cursor:default;position:relative;
}
.rw-badge.earned{
  background:linear-gradient(150deg,#FFFBF0,white);
  border-color:rgba(245,158,11,0.3);
  box-shadow:0 4px 18px rgba(245,158,11,0.15);
  animation:badgeIn 0.45s calc(var(--i,0)*0.06s) cubic-bezier(0.34,1.3,0.64,1) both;
}
.rw-badge.earned:hover{transform:translateY(-3px) scale(1.02);box-shadow:0 8px 24px rgba(245,158,11,0.22);}
@keyframes badgeIn{from{opacity:0;transform:scale(0.75);}to{opacity:1;transform:scale(1);}}
.rw-badge.locked{
  background:var(--slate-50);border-color:var(--slate-100);opacity:0.55;
}
.rw-badge-shine{
  position:absolute;top:6px;right:8px;
  font-size:0.55rem;font-weight:900;
  background:var(--amber);color:white;
  padding:2px 5px;border-radius:100px;
  letter-spacing:0.05em;
}
.rw-badge-icon{font-size:2.2rem;display:block;margin-bottom:8px;line-height:1;}
.rw-badge.locked .rw-badge-icon{filter:grayscale(1);opacity:0.4;}
.rw-badge-name{font-size:0.72rem;font-weight:800;color:var(--slate-800);margin-bottom:2px;line-height:1.3;}
.rw-badge.locked .rw-badge-name{color:var(--slate-400);}
.rw-badge-req{font-size:0.62rem;color:var(--slate-400);line-height:1.4;}

/* Next unlock card */
.rw-next-unlock{
  background:linear-gradient(135deg,#0F172A,#1E3A5F);
  border-radius:20px;padding:18px 20px;
  display:flex;align-items:center;gap:16px;
  margin-bottom:4px;
}
.rw-next-icon{font-size:2rem;width:52px;height:52px;border-radius:14px;
  background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.15);
  display:flex;align-items:center;justify-content:center;flex-shrink:0;filter:grayscale(1);opacity:0.5;}
.rw-next-info{flex:1;}
.rw-next-label{font-size:0.62rem;font-weight:800;color:var(--amber);text-transform:uppercase;letter-spacing:0.1em;margin-bottom:4px;}
.rw-next-name{font-weight:800;font-size:0.9375rem;color:white;margin-bottom:2px;}
.rw-next-desc{font-size:0.75rem;color:rgba(255,255,255,0.5);}

/* Streak card */
.rw-streak-card{
  background:linear-gradient(135deg,#FF6B1A,#F59E0B);
  border-radius:20px;padding:20px;
  display:flex;align-items:center;gap:16px;
  margin-bottom:10px;
}
.rw-streak-flame{font-size:2.4rem;animation:flamePulse 1.8s ease-in-out infinite;flex-shrink:0;}
.rw-streak-info{flex:1;}
.rw-streak-num{font-family:var(--font-display);font-size:1.8rem;font-weight:800;color:white;line-height:1;}
.rw-streak-label{font-size:0.78rem;font-weight:700;color:rgba(255,255,255,0.75);}
.rw-streak-sub{font-size:0.7rem;color:rgba(255,255,255,0.55);margin-top:2px;}

/* Legacy compat */
.badge-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;}
.badge-item{background:white;border-radius:var(--radius);padding:20px 16px;text-align:center;box-shadow:var(--shadow);}
.badge-item.earned{background:linear-gradient(135deg,var(--amber-light),#FFF7ED);}
.badge-item.locked{opacity:0.5;filter:grayscale(0.6);}
.badge-emoji{font-size:2.5rem;display:block;margin-bottom:8px;}
.badge-name{font-size:0.8125rem;font-weight:600;margin-bottom:4px;}
.badge-desc{font-size:0.7rem;color:var(--slate-500);line-height:1.4;}

/* ===== LIBRARY ===== */
.library-list{display:flex;flex-direction:column;gap:12px;}
.library-item{background:white;border-radius:var(--radius);padding:16px 20px;box-shadow:var(--shadow);display:flex;align-items:center;gap:14px;cursor:pointer;transition:all 0.2s;}
.library-item:hover{transform:translateY(-1px);box-shadow:var(--shadow-lg);}
.library-check{width:36px;height:36px;border-radius:50%;background:var(--emerald-light);display:flex;align-items:center;justify-content:center;color:var(--emerald);font-size:1.1rem;flex-shrink:0;}
.library-info{flex:1;}
.library-title{font-weight:600;font-size:0.9375rem;}
.library-meta{font-size:0.8125rem;color:var(--slate-500);margin-top:2px;}

/* ===== SUBSCRIPTION ===== */
.plan-card{border-radius:var(--radius-lg);padding:28px;margin-bottom:16px;}
.current-plan{background:linear-gradient(135deg,#1E293B,#0F3460);color:white;}
.upgrade-cta{background:linear-gradient(135deg,var(--amber-light),#FFF7ED);border:2px solid var(--amber-dark);}

/* ===== SETTINGS ===== */
.settings-section{margin-bottom:32px;}
.settings-item{display:flex;align-items:center;justify-content:space-between;padding:16px;background:white;border-radius:var(--radius);margin-bottom:8px;box-shadow:var(--shadow);}
.settings-item-info{}
.settings-item-label{font-weight:600;font-size:0.9375rem;}
.settings-item-desc{font-size:0.8125rem;color:var(--slate-500);margin-top:2px;}
.settings-toggle{width:44px;height:24px;background:var(--slate-300);border-radius:100px;cursor:pointer;position:relative;transition:background 0.2s;}
.settings-toggle.on{background:var(--emerald);}
.settings-toggle::after{content:'';position:absolute;top:4px;left:4px;width:16px;height:16px;background:white;border-radius:50%;transition:transform 0.2s;box-shadow:0 1px 4px rgba(0,0,0,0.2);}
.settings-toggle.on::after{transform:translateX(20px);}

/* ===== APPROVALS ===== */
.approval-card{background:white;border-radius:var(--radius);padding:20px;box-shadow:var(--shadow);margin-bottom:16px;}
.approval-header{display:flex;align-items:center;gap:12px;margin-bottom:12px;}
.approval-body{background:var(--slate-50);border-radius:var(--radius-sm);padding:14px;margin-bottom:14px;}
.approval-reflection{font-size:0.875rem;line-height:1.6;color:var(--slate-700);font-style:italic;}
.approval-actions{display:flex;gap:10px;}

/* ===== DEMO TOUR ===== */
.tour-modal .modal{background:linear-gradient(160deg,#1E293B,#0F3460);color:white;border-radius:24px 24px 0 0;}
.tour-modal .modal-handle{background:rgba(255,255,255,0.2);}
.tour-step-icon{font-size:3rem;text-align:center;margin-bottom:16px;}
.tour-step-title{font-family:var(--font-display);font-size:1.4rem;font-weight:600;color:white;text-align:center;margin-bottom:12px;}
.tour-step-text{font-size:0.9375rem;color:rgba(255,255,255,0.8);line-height:1.7;text-align:center;}
.tour-dots{display:flex;justify-content:center;gap:8px;margin:20px 0;}
.tour-dot{width:8px;height:8px;border-radius:50%;background:rgba(255,255,255,0.3);}
.tour-dot.active{background:var(--amber);width:20px;border-radius:4px;}

/* ===== PATH COLORS ===== */
.path-jesus .path-header{background:linear-gradient(135deg,#1E3A5F,#0F3460);}
.path-fruit .path-header{background:linear-gradient(135deg,#065F46,#059669);}
.path-courage .path-header{background:linear-gradient(135deg,#7C3AED,#6D28D9);}
.path-words .path-header{background:linear-gradient(135deg,#B45309,#D97706);}
.path-prayer .path-header{background:linear-gradient(135deg,#0369A1,#0284C7);}

/* ===== ANIMATIONS ===== */
@keyframes fadeUp{from{opacity:0;transform:translateY(16px);}to{opacity:1;transform:translateY(0);}}
@keyframes pulseGlow{0%,100%{box-shadow:0 0 0 0 rgba(245,158,11,0.4);}50%{box-shadow:0 0 0 12px rgba(245,158,11,0);}}
.anim-in{animation:fadeUp 0.4s ease both;}
.pulse-cta{animation:pulseGlow 2s infinite;}

/* ===== LANDING NAVBAR — always dark/branded ===== */
.landing-nav{
  position:sticky;top:0;left:0;right:0;z-index:200;padding:0 24px;
  background:rgba(13,20,38,0.82);
  backdrop-filter:blur(18px);-webkit-backdrop-filter:blur(18px);
  border-bottom:1px solid rgba(255,255,255,0.07);
  box-shadow:0 2px 32px rgba(0,0,0,0.25);
}
.landing-nav-inner{max-width:1100px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;height:68px;}

/* Logo */
.lnav-logo{display:flex;align-items:center;gap:10px;text-decoration:none;transition:opacity 0.2s;}
.lnav-logo:hover{opacity:0.85;}
.lnav-logo-icon{
  width:36px;height:36px;
  background:linear-gradient(135deg,var(--amber),var(--amber-dark));
  border-radius:10px;display:flex;align-items:center;justify-content:center;
  font-size:18px;box-shadow:0 2px 10px rgba(245,158,11,0.45);
}
.lnav-logo-text{font-family:var(--font-display);font-size:1.2rem;font-weight:700;color:white;}

/* Nav links */
.lnav-links{display:flex;align-items:center;gap:2px;}
.lnav-link{
  padding:8px 15px;border-radius:8px;font-size:0.875rem;font-weight:500;
  color:rgba(255,255,255,0.65);cursor:pointer;transition:all 0.18s;
  background:none;border:none;font-family:var(--font-body);letter-spacing:0.01em;
}
.lnav-link:hover{background:rgba(255,255,255,0.09);color:white;}

/* Actions */
.lnav-actions{display:flex;align-items:center;gap:10px;}
.lnav-signin{
  padding:9px 20px;border-radius:100px;font-size:0.875rem;font-weight:600;cursor:pointer;
  background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);
  color:rgba(255,255,255,0.85);font-family:var(--font-body);transition:all 0.18s;
}
.lnav-signin:hover{background:rgba(255,255,255,0.18);color:white;border-color:rgba(255,255,255,0.35);}
.lnav-cta{
  padding:10px 22px;border-radius:100px;font-size:0.875rem;font-weight:700;cursor:pointer;
  background:linear-gradient(135deg,var(--amber),var(--amber-dark));border:none;
  color:white;font-family:var(--font-body);
  box-shadow:0 3px 14px rgba(245,158,11,0.45);transition:all 0.18s;
}
.lnav-cta:hover{transform:translateY(-1px);box-shadow:0 6px 22px rgba(245,158,11,0.55);}

/* Mobile hamburger */
.lnav-mobile-menu{display:none;flex-direction:column;gap:4px;cursor:pointer;padding:6px;border-radius:8px;transition:background 0.2s;}
.lnav-mobile-menu:hover{background:rgba(255,255,255,0.1);}
.lnav-mobile-menu span{display:block;width:22px;height:2px;background:rgba(255,255,255,0.75);border-radius:2px;transition:all 0.25s;}
.lnav-mobile-menu.open span:nth-child(1){transform:translateY(6px) rotate(45deg);}
.lnav-mobile-menu.open span:nth-child(2){opacity:0;transform:scaleX(0);}
.lnav-mobile-menu.open span:nth-child(3){transform:translateY(-6px) rotate(-45deg);}

@media(max-width:768px){
  .lnav-links{display:none;}
  .lnav-actions .lnav-signin{display:none;}
  .lnav-mobile-menu{display:flex;}
}

/* Mobile drawer — matches dark brand */
.lnav-drawer{
  position:sticky;top:68px;left:0;right:0;z-index:199;
  background:rgba(13,20,38,0.97);
  backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);
  border-bottom:1px solid rgba(255,255,255,0.08);
  box-shadow:0 12px 40px rgba(0,0,0,0.4);
  display:none;
  animation:drawerSlideIn 0.28s cubic-bezier(0.34,1.2,0.64,1) both;
}
.lnav-drawer.open{display:block;}
@keyframes drawerSlideIn{from{opacity:0;transform:translateY(-8px);}to{opacity:1;transform:translateY(0);}}
.lnav-drawer-inner{padding:12px 20px 24px;display:flex;flex-direction:column;gap:2px;}
.lnav-drawer-link{
  padding:13px 16px;border-radius:10px;font-size:0.9375rem;font-weight:500;
  color:rgba(255,255,255,0.7);cursor:pointer;transition:all 0.18s;
  border:none;background:none;font-family:var(--font-body);text-align:left;
}
.lnav-drawer-link:hover{background:rgba(255,255,255,0.08);color:white;}
.lnav-drawer-divider{height:1px;background:rgba(255,255,255,0.08);margin:10px 0;}

/* Ensure hero has top padding for fixed nav */
#screen-landing{overflow-y:auto;height:100vh;}
#screen-landing .landing-hero{padding-top:80px;padding-bottom:80px;}

/* ===== SOCIAL PROOF BAR ===== */
.proof-bar{background:white;border-bottom:1px solid var(--slate-200);padding:0 24px;overflow:hidden;}
.proof-bar-inner{max-width:900px;margin:0 auto;display:flex;align-items:stretch;justify-content:center;flex-wrap:wrap;}
.proof-stat{display:flex;align-items:center;gap:10px;padding:20px 28px;border-right:1px solid var(--slate-200);flex:1;min-width:150px;justify-content:center;}
.proof-stat:last-child{border-right:none;}
.proof-stat-icon{font-size:1.4rem;flex-shrink:0;}
.proof-stat-text{}
.proof-stat-value{font-family:var(--font-display);font-size:1.2rem;font-weight:700;color:var(--slate-900);display:block;line-height:1.1;}
.proof-stat-label{font-size:0.75rem;color:var(--slate-500);font-weight:500;}
@media(max-width:480px){.proof-stat{border-right:none;border-bottom:1px solid var(--slate-200);}.proof-stat:last-child{border-bottom:none;}}

/* ===== LESSON PREVIEW SECTION ===== */
.lesson-preview-section{background:linear-gradient(170deg,#0F172A 0%,#1E3A5F 60%,#0F3460 100%);padding:80px 24px 100px;overflow:visible;position:relative;}
.lesson-preview-section::before{content:'';position:absolute;inset:0;background-image:radial-gradient(circle,rgba(255,255,255,0.04) 1px,transparent 1px);background-size:32px 32px;}
.lp-container{max-width:960px;margin:0 auto;display:grid;grid-template-columns:1fr 1fr;gap:60px;align-items:center;position:relative;z-index:1;}
@media(max-width:700px){.lp-container{grid-template-columns:1fr;gap:40px;}}
.lp-text{}
.lp-eyebrow{display:inline-block;background:rgba(245,158,11,0.2);border:1px solid rgba(245,158,11,0.4);color:var(--amber);padding:6px 16px;border-radius:100px;font-size:0.75rem;font-weight:700;letter-spacing:0.06em;text-transform:uppercase;margin-bottom:20px;}
.lp-title{font-family:var(--font-display);font-size:clamp(1.8rem,4vw,2.6rem);font-weight:700;color:white;line-height:1.15;margin-bottom:16px;}
.lp-desc{font-size:0.9375rem;color:rgba(255,255,255,0.7);line-height:1.75;margin-bottom:32px;}
.lp-steps-list{display:flex;flex-direction:column;gap:12px;margin-bottom:32px;}
.lp-step-row{display:flex;align-items:center;gap:12px;cursor:pointer;padding:10px 14px;border-radius:12px;border:1px solid transparent;transition:all 0.2s;}
.lp-step-row:hover,.lp-step-row.active{background:rgba(255,255,255,0.08);border-color:rgba(255,255,255,0.15);}
.lp-step-row.active{border-color:rgba(245,158,11,0.5);}
.lp-step-dot{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:0.875rem;flex-shrink:0;background:rgba(255,255,255,0.1);}
.lp-step-row.active .lp-step-dot{background:var(--amber);color:white;}
.lp-step-label{font-size:0.9rem;font-weight:600;color:rgba(255,255,255,0.7);}
.lp-step-row.active .lp-step-label{color:white;}
.lp-mockup{position:relative;}
.lp-phone{background:white;border-radius:28px;box-shadow:0 32px 80px rgba(0,0,0,0.5),0 0 0 8px rgba(255,255,255,0.08);overflow:hidden;max-width:300px;margin:0 auto;}
.lp-phone-bar{height:10px;background:var(--slate-900);display:flex;align-items:center;justify-content:center;gap:4px;}
.lp-phone-dot{width:6px;height:6px;border-radius:50%;background:rgba(255,255,255,0.2);}
.lp-phone-content{padding:0;min-height:400px;transition:opacity 0.15s ease;}
.lp-preview-card{padding:20px;}
.lp-preview-step-label{font-size:0.65rem;font-weight:700;color:var(--amber-dark);text-transform:uppercase;letter-spacing:0.08em;margin-bottom:4px;}
.lp-preview-title{font-family:var(--font-display);font-size:1.1rem;font-weight:700;color:var(--slate-900);margin-bottom:12px;line-height:1.3;}
.lp-preview-verse{background:linear-gradient(135deg,#1E293B,#0F3460);border-radius:12px;padding:14px;margin-bottom:12px;}
.lp-preview-verse-ref{font-size:0.65rem;font-weight:600;color:var(--amber);text-transform:uppercase;letter-spacing:0.08em;margin-bottom:6px;}
.lp-preview-verse-text{font-family:var(--font-display);font-size:0.8rem;line-height:1.6;color:rgba(255,255,255,0.9);}
.lp-preview-q{background:var(--slate-50);border-radius:10px;padding:12px 14px;margin-bottom:8px;}
.lp-preview-q-label{font-size:0.65rem;font-weight:700;color:var(--amber-dark);text-transform:uppercase;letter-spacing:0.06em;margin-bottom:4px;}
.lp-preview-q-text{font-size:0.8rem;line-height:1.5;color:var(--slate-700);}
.lp-preview-mission{border:2px solid var(--emerald);border-radius:10px;padding:12px 14px;margin-bottom:8px;background:var(--emerald-light);}
.lp-preview-mission-label{font-size:0.65rem;font-weight:700;color:#065F46;text-transform:uppercase;letter-spacing:0.06em;margin-bottom:4px;}
.lp-preview-mission-title{font-size:0.875rem;font-weight:700;color:var(--slate-900);margin-bottom:3px;}
.lp-preview-mission-desc{font-size:0.75rem;color:var(--slate-600);line-height:1.4;}
.lp-preview-emoji-row{display:flex;gap:8px;margin-bottom:10px;}
.lp-preview-emoji{font-size:1.4rem;padding:6px;background:white;border-radius:8px;box-shadow:0 1px 4px rgba(0,0,0,0.08);}
.lp-preview-emoji.sel{background:var(--amber-light);box-shadow:0 0 0 2px var(--amber);}
.lp-preview-progress{height:4px;background:var(--slate-200);border-radius:100px;margin-bottom:14px;overflow:hidden;}
.lp-preview-progress-fill{height:100%;background:linear-gradient(90deg,var(--amber),var(--amber-dark));border-radius:100px;}

/* ===== RICH FOOTER ===== */
.rich-footer{background:var(--slate-900);color:white;padding:72px 24px 0;}
.rich-footer-inner{max-width:1000px;margin:0 auto;}
.rich-footer-top{display:grid;grid-template-columns:2fr 1fr 1fr 1fr;gap:48px;padding-bottom:56px;border-bottom:1px solid rgba(255,255,255,0.08);}
@media(max-width:768px){.rich-footer-top{grid-template-columns:1fr 1fr;gap:32px;}}
@media(max-width:480px){.rich-footer-top{grid-template-columns:1fr;}}
.rf-brand{}
.rf-brand-logo{display:flex;align-items:center;gap:10px;margin-bottom:16px;}
.rf-brand-icon{width:40px;height:40px;background:linear-gradient(135deg,var(--amber),var(--amber-dark));border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:20px;}
.rf-brand-name{font-family:var(--font-display);font-size:1.3rem;font-weight:700;color:white;}
.rf-tagline{font-size:0.875rem;color:rgba(255,255,255,0.55);line-height:1.7;margin-bottom:24px;max-width:280px;}
.rf-social{display:flex;gap:10px;}
.rf-social-btn{width:36px;height:36px;border-radius:10px;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.1);display:flex;align-items:center;justify-content:center;font-size:0.875rem;cursor:pointer;transition:all 0.2s;text-decoration:none;color:white;}
.rf-social-btn:hover{background:rgba(245,158,11,0.2);border-color:rgba(245,158,11,0.4);}
.rf-col-title{font-size:0.75rem;font-weight:700;letter-spacing:0.1em;text-transform:uppercase;color:rgba(255,255,255,0.4);margin-bottom:16px;}
.rf-links{display:flex;flex-direction:column;gap:10px;}
.rf-link{font-size:0.875rem;color:rgba(255,255,255,0.6);text-decoration:none;cursor:pointer;transition:color 0.2s;}
.rf-link:hover{color:var(--amber);}
.rf-badge-row{display:flex;flex-direction:column;gap:8px;margin-top:4px;}
.rf-trust-badge{display:flex;align-items:center;gap:8px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.08);border-radius:8px;padding:8px 12px;}
.rf-trust-icon{font-size:1rem;}
.rf-trust-text{font-size:0.75rem;color:rgba(255,255,255,0.6);line-height:1.3;}
.rich-footer-bottom{display:flex;align-items:center;justify-content:space-between;padding:20px 0 32px;flex-wrap:wrap;gap:12px;}
.rf-copyright{font-size:0.8rem;color:rgba(255,255,255,0.35);}
.rf-legal{display:flex;gap:16px;}
.rf-legal a{font-size:0.8rem;color:rgba(255,255,255,0.35);text-decoration:none;transition:color 0.2s;}
.rf-legal a:hover{color:var(--amber);}
.rf-scripture-note{font-size:0.7rem;color:rgba(255,255,255,0.25);text-align:center;padding-bottom:12px;}

/* RESPONSIVE */
@media(min-width:640px){
  .pricing-grid{max-width:680px;}
  .hero-cta-row .btn-lg{padding:20px 48px;}
}
@media(max-width:400px){
  .stats-row{grid-template-columns:1fr 1fr;}
  .badge-grid{grid-template-columns:repeat(2,1fr);}
}
</style>
</head>
<body>

<div id="toast"></div>

<!-- ===== LANDING ===== -->
<div id="screen-landing" class="screen active">

<!-- ===== LANDING NAV ===== -->
<nav class="landing-nav" id="landingNav">
  <div class="landing-nav-inner">
    <a class="lnav-logo" href="#">
      <div class="lnav-logo-icon">✝️</div>
      <span class="lnav-logo-text">FaithQuest</span>
    </a>
    <div class="lnav-links">
      <button class="lnav-link" onclick="scrollToSection('how-it-works')">How It Works</button>
      <button class="lnav-link" onclick="scrollToSection('paths-section')">Paths</button>
      <button class="lnav-link" onclick="scrollToSection('lesson-preview')">Preview</button>
      <button class="lnav-link" onclick="scrollToSection('pricing')">Pricing</button>
    </div>
    <div class="lnav-actions">
      <button class="lnav-signin" onclick="gotoAuth('signin')">Sign In</button>
      <button class="lnav-cta" onclick="gotoAuth('signup')">Start Free</button>
    </div>
    <div class="lnav-mobile-menu" onclick="toggleMobileNav()" id="mobileMenuBtn">
      <span></span><span></span><span></span>
    </div>
  </div>
</nav>
<div class="lnav-drawer" id="lnavDrawer">
  <div class="lnav-drawer-inner">
    <button class="lnav-drawer-link" onclick="scrollToSection('how-it-works');closeMobileNav()">📖 How It Works</button>
    <button class="lnav-drawer-link" onclick="scrollToSection('paths-section');closeMobileNav()">📚 Learning Paths</button>
    <button class="lnav-drawer-link" onclick="scrollToSection('lesson-preview');closeMobileNav()">👀 See a Lesson</button>
    <button class="lnav-drawer-link" onclick="scrollToSection('pricing');closeMobileNav()">💳 Pricing</button>
    <div class="lnav-drawer-divider"></div>
    <button class="lnav-drawer-link" onclick="gotoAuth('signin')">Sign In</button>
    <button class="btn btn-primary btn-full" onclick="gotoAuth('signup')">Start Free Today →</button>
  </div>
</div>

  <div class="landing-hero">
    <div class="hero-stars"></div>
    <div class="hero-glow"></div>
    <div class="hero-content">
      <div class="hero-eyebrow">✨ Faith-based learning for every family</div>
      <h1 class="hero-title">Where Scripture Becomes <span>Living Adventure</span></h1>
      <p class="hero-sub">FaithQuest guides families through Bible stories, real-world missions, and meaningful conversations—with safe, age-tailored AI support.</p>
      <div class="hero-cta-row">
        <button class="btn btn-primary btn-lg" onclick="gotoAuth('signup')">Start Free Today</button>
        <button class="btn btn-secondary btn-lg" onclick="scrollToSection('how-it-works')">See How It Works</button>
      </div>
      <div class="hero-trust">
        <div class="trust-item"><span class="trust-icon">🔒</span>Kid-Safe AI</div>
        <div class="trust-item"><span class="trust-icon">📖</span>35+ Lessons</div>
        <div class="trust-item"><span class="trust-icon">👨‍👩‍👧‍👦</span>Family-Centered</div>
        <div class="trust-item"><span class="trust-icon">🌍</span>Offline Missions</div>
      </div>
    </div>
  </div>

  <!-- SOCIAL PROOF BAR -->
  <div class="proof-bar">
    <div class="proof-bar-inner">
      <div class="proof-stat"><span class="proof-stat-icon">👨‍👩‍👧‍👦</span><div class="proof-stat-text"><span class="proof-stat-value">12,400+</span><span class="proof-stat-label">Families using FaithQuest</span></div></div>
      <div class="proof-stat"><span class="proof-stat-icon">⭐</span><div class="proof-stat-text"><span class="proof-stat-value">4.9 / 5</span><span class="proof-stat-label">Average family rating</span></div></div>
      <div class="proof-stat"><span class="proof-stat-icon">📖</span><div class="proof-stat-text"><span class="proof-stat-value">248,000+</span><span class="proof-stat-label">Lessons completed</span></div></div>
      <div class="proof-stat"><span class="proof-stat-icon">🎯</span><div class="proof-stat-text"><span class="proof-stat-value">91,000+</span><span class="proof-stat-label">Real-world missions done</span></div></div>
    </div>
  </div>

  <div class="section" id="how-it-works">
    <div class="section-header">
      <div class="section-eyebrow">How It Works</div>
      <h2 class="display-md">Scripture → Understanding → Action</h2>
      <p class="body-lg muted" style="max-width:520px;margin:16px auto 0">Every lesson flows through five thoughtful stages designed for lasting impact.</p>
    </div>
    <div class="how-grid">
      <div class="card how-card"><span class="how-icon">📖</span><div class="how-title">Read</div><p class="how-desc">Short public-domain verse with context—perfectly sized for young attention spans.</p></div>
      <div class="card how-card"><span class="how-icon">🤔</span><div class="how-title">Understand</div><p class="how-desc">AI-tailored explanations for each age tier. No theological jargon for kids.</p></div>
      <div class="card how-card"><span class="how-icon">💬</span><div class="how-title">Talk Together</div><p class="how-desc">Guided family discussion questions that spark real conversation at the table.</p></div>
      <div class="card how-card"><span class="how-icon">🚀</span><div class="how-title">Faith-in-Action</div><p class="how-desc">Offline missions that bring Scripture to life in everyday moments.</p></div>
      <div class="card how-card"><span class="how-icon">🙏</span><div class="how-title">Reflect & Pray</div><p class="how-desc">Kids share how they felt. Families build a prayer together, line by line.</p></div>
    </div>
  </div>

  <div style="background:#F8FAFC;padding:80px 24px;" id="paths-section">
    <div class="section-header" style="text-align:center;">
      <div class="section-eyebrow">Learning Paths</div>
      <h2 class="display-md">5 Curated Paths, 35 Lessons</h2>
      <p class="body-lg muted" style="max-width:480px;margin:16px auto 0">Structured journeys through the Bible's most transformative teachings.</p>
    </div>
    <div class="paths-grid" style="max-width:900px;margin:0 auto;">
      <div class="path-card-landing path-jesus" onclick="gotoAuth('signup')"><div class="path-header"><span class="path-emoji">✝️</span><div class="path-title-text">Jesus &amp; Me</div></div><div class="path-body"><p class="path-desc">Discover who Jesus is through stories, miracles, and His teachings for everyday life.</p><span class="badge badge-sky">7 lessons</span></div></div>
      <div class="path-card-landing path-fruit" onclick="gotoAuth('signup')"><div class="path-header"><span class="path-emoji">🍎</span><div class="path-title-text">Fruit of the Spirit</div></div><div class="path-body"><p class="path-desc">Love, joy, peace, patience—learn to grow these character qualities in real life.</p><span class="badge badge-emerald">7 lessons</span></div></div>
      <div class="path-card-landing path-courage" onclick="gotoAuth('signup')"><div class="path-header"><span class="path-emoji">🦁</span><div class="path-title-text">Courage &amp; Anxiety</div></div><div class="path-body"><p class="path-desc">Biblical tools for facing fears, worry, and hard situations with faith and calm.</p><span class="badge badge-purple">7 lessons</span></div></div>
      <div class="path-card-landing path-words" onclick="gotoAuth('signup')"><div class="path-header"><span class="path-emoji">💬</span><div class="path-title-text">Words &amp; Actions</div></div><div class="path-body"><p class="path-desc">Honesty, kindness in speech, and how our words shape the world around us.</p><span class="badge badge-amber">7 lessons</span></div></div>
      <div class="path-card-landing path-prayer" onclick="gotoAuth('signup')"><div class="path-header"><span class="path-emoji">🙏</span><div class="path-title-text">Prayer &amp; Gratitude</div></div><div class="path-body"><p class="path-desc">Learn to talk with God—how to pray, what to pray for, and why gratitude changes everything.</p><span class="badge badge-sky">7 lessons</span></div></div>
    </div>
  </div>

  <div class="testimonials">
    <div class="section-header" style="text-align:center;margin-bottom:48px;">
      <div style="display:inline-block;background:rgba(245,158,11,0.2);color:var(--amber);padding:6px 16px;border-radius:100px;font-size:0.75rem;font-weight:700;letter-spacing:0.06em;text-transform:uppercase;margin-bottom:16px;">What Families Say</div>
      <h2 class="display-md" style="color:white;">Real Stories, Real Growth</h2>
    </div>
    <div class="testimonial-grid">
      <div class="testimonial-card"><p class="testimonial-text">"Our 8-year-old actually asks to do FaithQuest before dinner now. The missions make faith feel tangible and fun."</p><div class="testimonial-author"><div class="testimonial-avatar">👩</div><div><div class="testimonial-name">Sarah M.</div><div class="testimonial-role">Mother of 2, Texas</div></div></div></div>
      <div class="testimonial-card"><p class="testimonial-text">"The family discussion questions opened conversations we never knew how to start. Deeply grateful."</p><div class="testimonial-author"><div class="testimonial-avatar">👨</div><div><div class="testimonial-name">James K.</div><div class="testimonial-role">Father of 3, Georgia</div></div></div></div>
      <div class="testimonial-card"><p class="testimonial-text">"As a parent I love that I can see insights and know my kids are safe. The AI never feels pushy or weird."</p><div class="testimonial-author"><div class="testimonial-avatar">🧑</div><div><div class="testimonial-name">Priya D.</div><div class="testimonial-role">Mother of 1, California</div></div></div></div>
    </div>
  </div>

  <!-- LESSON PREVIEW SECTION -->
  <div class="lesson-preview-section" id="lesson-preview">
    <div class="lp-container">
      <div class="lp-text">
        <div class="lp-eyebrow">Interactive Preview</div>
        <h2 class="lp-title">See a Real Lesson in Action</h2>
        <p class="lp-desc">Every FaithQuest lesson flows through 6 thoughtful steps. Click a step below to preview what your family will experience.</p>
        <div class="lp-steps-list" id="lpStepsList">
          <div class="lp-step-row active" id="lpStep0" onclick="selectLpStep(0)"><div class="lp-step-dot">📖</div><span class="lp-step-label">Read</span></div>
          <div class="lp-step-row" id="lpStep1" onclick="selectLpStep(1)"><div class="lp-step-dot">🤔</div><span class="lp-step-label">Understand</span></div>
          <div class="lp-step-row" id="lpStep2" onclick="selectLpStep(2)"><div class="lp-step-dot">💬</div><span class="lp-step-label">Talk Together</span></div>
          <div class="lp-step-row" id="lpStep3" onclick="selectLpStep(3)"><div class="lp-step-dot">🚀</div><span class="lp-step-label">Faith-in-Action</span></div>
          <div class="lp-step-row" id="lpStep4" onclick="selectLpStep(4)"><div class="lp-step-dot">💭</div><span class="lp-step-label">Reflect</span></div>
          <div class="lp-step-row" id="lpStep5" onclick="selectLpStep(5)"><div class="lp-step-dot">🙏</div><span class="lp-step-label">Prayer Builder</span></div>
        </div>
        <button class="btn btn-primary" onclick="gotoAuth('signup')">Try It Free — No Card Needed →</button>
      </div>
      <div class="lp-mockup">
        <div class="lp-phone">
          <div class="lp-phone-bar"><div class="lp-phone-dot"></div><div class="lp-phone-dot"></div><div class="lp-phone-dot"></div></div>
          <div class="lp-phone-content" id="lpPhoneContent">
            <div class="lp-preview-card">
              <div class="lp-preview-progress"><div class="lp-preview-progress-fill" style="width:16%;"></div></div>
              <div class="lp-preview-step-label">📖 Read</div>
              <div class="lp-preview-title">Jesus, the Good Shepherd</div>
              <div class="lp-preview-verse">
                <div class="lp-preview-verse-ref">John 10:11 · WEB</div>
                <div class="lp-preview-verse-text">"I am the good shepherd. The good shepherd lays down his life for the sheep."</div>
              </div>
              <p style="font-size:0.78rem;color:var(--slate-600);line-height:1.6;">Jesus compares himself to a shepherd who truly cares for and protects his sheep—even at great cost to himself.</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>


  <div class="pricing-section" id="pricing">
    <div class="section-header" style="text-align:center;margin-bottom:32px;">
      <div class="section-eyebrow">Pricing</div>
      <h2 class="display-md">Simple, Family-Friendly Plans</h2>
    </div>
    <div class="pricing-toggle" id="pricingToggle">
      <span class="toggle-label">Monthly</span>
      <div class="toggle-track" id="billingToggle" onclick="toggleBilling()"><div class="toggle-thumb"></div></div>
      <span class="toggle-label">Yearly <span style="background:var(--emerald-light);color:var(--emerald);padding:2px 8px;border-radius:100px;font-size:0.7rem;font-weight:700;margin-left:4px;">Save 20%</span></span>
    </div>
    <div class="pricing-grid">
      <div class="pricing-card">
        <div class="pricing-plan-name">Free</div>
        <div class="pricing-price"><sup>$</sup>0</div>
        <div class="pricing-period">Forever</div>
        <ul class="pricing-features">
          <li><span class="pricing-check">✓</span>1 Learning Path</li>
          <li><span class="pricing-check">✓</span>Up to 2 family members</li>
          <li><span class="pricing-check">✓</span>Basic lesson player</li>
          <li><span class="pricing-check">✓</span>Offline missions</li>
          <li style="opacity:0.4"><span>✗</span>Full path library</li>
          <li style="opacity:0.4"><span>✗</span>Parent insights dashboard</li>
          <li style="opacity:0.4"><span>✗</span>Teen journaling</li>
        </ul>
        <button class="btn btn-secondary btn-full" onclick="gotoAuth('signup')">Get Started Free</button>
      </div>
      <div class="pricing-card featured">
        <div class="pricing-badge">Most Popular</div>
        <div class="pricing-plan-name" style="color:white;">Premium Family</div>
        <div class="pricing-price" style="color:white;" id="premiumPrice"><sup>$</sup>9.99</div>
        <div class="pricing-period" id="premiumPeriod">per month</div>
        <ul class="pricing-features" style="color:rgba(255,255,255,0.85);">
          <li><span class="pricing-featured-check">★</span>All 5 Learning Paths</li>
          <li><span class="pricing-featured-check">★</span>Unlimited family members</li>
          <li><span class="pricing-featured-check">★</span>Full AI lesson engine</li>
          <li><span class="pricing-featured-check">★</span>Parent insights + heatmap</li>
          <li><span class="pricing-featured-check">★</span>Teen journaling</li>
          <li><span class="pricing-featured-check">★</span>Mission approvals workflow</li>
          <li><span class="pricing-featured-check">★</span>Prayer builder</li>
        </ul>
        <button class="btn btn-primary btn-full pulse-cta" onclick="gotoAuth('signup')">Start 14-Day Trial</button>
      </div>
    </div>
  </div>

  <div class="faq-section">
    <div class="section-header" style="text-align:center;margin-bottom:40px;">
      <div class="section-eyebrow">FAQ</div>
      <h2 class="display-sm">Common Questions</h2>
    </div>
    <div id="faqList"></div>
  </div>

  <!-- RICH FOOTER -->
  <footer class="rich-footer">
    <div class="rich-footer-inner">
      <div class="rich-footer-top">
        <div class="rf-brand">
          <div class="rf-brand-logo">
            <div class="rf-brand-icon">✝️</div>
            <span class="rf-brand-name">FaithQuest</span>
          </div>
          <p class="rf-tagline">Scripture into understanding, family conversation, real-world action, and lasting faith—safely designed for every age.</p>
          <div class="rf-social">
            <a class="rf-social-btn" href="#" title="Instagram">📸</a>
            <a class="rf-social-btn" href="#" title="Facebook">📘</a>
            <a class="rf-social-btn" href="#" title="YouTube">▶️</a>
            <a class="rf-social-btn" href="#" title="Twitter/X">🐦</a>
            <a class="rf-social-btn" href="#" title="Email">✉️</a>
          </div>
        </div>
        <div>
          <div class="rf-col-title">Product</div>
          <div class="rf-links">
            <span class="rf-link" onclick="scrollToSection('how-it-works')">How It Works</span>
            <span class="rf-link" onclick="scrollToSection('paths-section')">Learning Paths</span>
            <span class="rf-link" onclick="scrollToSection('lesson-preview')">Lesson Preview</span>
            <span class="rf-link" onclick="scrollToSection('pricing')">Pricing</span>
            <span class="rf-link" onclick="gotoAuth('signup')">Start Free</span>
          </div>
        </div>
        <div>
          <div class="rf-col-title">Company</div>
          <div class="rf-links">
            <span class="rf-link">About Us</span>
            <span class="rf-link">Our Mission</span>
            <span class="rf-link">Blog</span>
            <span class="rf-link">Partnerships</span>
            <span class="rf-link">Contact</span>
          </div>
        </div>
        <div>
          <div class="rf-col-title">Trust & Safety</div>
          <div class="rf-badge-row">
            <div class="rf-trust-badge"><span class="rf-trust-icon">🔒</span><span class="rf-trust-text">Kid-Safe AI — no open chat, no personal data requests</span></div>
            <div class="rf-trust-badge"><span class="rf-trust-icon">📖</span><span class="rf-trust-text">WEB & KJV — public domain Scripture only</span></div>
            <div class="rf-trust-badge"><span class="rf-trust-icon">⛪</span><span class="rf-trust-text">Doctrinally neutral across mainstream Christian traditions</span></div>
            <div class="rf-trust-badge"><span class="rf-trust-icon">👨‍👩‍👧</span><span class="rf-trust-text">Parent approval required for every mission submission</span></div>
          </div>
        </div>
      </div>
      <div class="rich-footer-bottom">
        <span class="rf-copyright">© 2025 FaithQuest, Inc. All rights reserved.</span>
        <div class="rf-legal">
          <a href="#">Privacy Policy</a>
          <a href="#">Terms of Service</a>
          <a href="#">Cookie Policy</a>
          <a href="#">Accessibility</a>
        </div>
      </div>
      <p class="rf-scripture-note">Scripture quotations from the World English Bible (WEB) and King James Version (KJV), both in the public domain.</p>
    </div>
  </footer>
</div>

<!-- ===== AUTH ===== -->
<div id="screen-auth" class="screen">
  <!-- Left panel: brand / feature callouts -->
  <div class="auth-panel-left">
    <div class="auth-panel-left-glow"></div>
    <div class="auth-left-content">
      <div class="auth-left-logo">
        <div class="auth-left-logo-icon">✝️</div>
        <span class="auth-left-logo-text">FaithQuest</span>
      </div>
      <h2 class="auth-left-heading">Faith comes alive <span>for your whole family.</span></h2>
      <p class="auth-left-sub">35 guided lessons. Real-world missions. Age-safe AI. Built to turn Scripture into something your kids will actually live.</p>
      <div class="auth-left-features">
        <div class="auth-left-feature"><div class="auth-feature-icon">🔒</div><div class="auth-feature-text"><strong>Kid-safe by design.</strong> No open AI chat. No personal data collected from children.</div></div>
        <div class="auth-left-feature"><div class="auth-feature-icon">👨‍👩‍👧</div><div class="auth-feature-text"><strong>Parent controls everything.</strong> Approve missions, view insights, manage every profile.</div></div>
        <div class="auth-left-feature"><div class="auth-feature-icon">📖</div><div class="auth-feature-text"><strong>Public domain Scripture.</strong> World English Bible &amp; KJV — no licensing restrictions.</div></div>
        <div class="auth-left-feature"><div class="auth-feature-icon">🌍</div><div class="auth-feature-text"><strong>Offline-friendly missions.</strong> Faith-in-action happens in the real world, not just the app.</div></div>
      </div>
    </div>
    <div class="auth-left-footer">Trusted by 12,400+ families · 4.9 ★ average rating</div>
  </div>

  <!-- Right panel: form -->
  <div class="auth-panel-right" id="authPanelRight">
    <button class="auth-right-back" onclick="showScreen('screen-landing')">← Back to home</button>

    <!-- Sign In -->
    <div id="auth-signin-form">
      <h1 class="auth-right-heading">Welcome back</h1>
      <p class="auth-right-sub">New to FaithQuest? <a onclick="switchAuthTab('signup')">Create a free account →</a></p>
      <div class="auth-input-group">
        <label class="auth-input-label">Email address</label>
        <input type="email" class="auth-input" id="signin-email" placeholder="you@example.com" autocomplete="email">
      </div>
      <div class="auth-input-group" style="position:relative;">
        <label class="auth-input-label">Password</label>
        <input type="password" class="auth-input" id="signin-password" placeholder="••••••••" autocomplete="current-password">
        <span class="auth-pass-toggle" onclick="togglePass('signin-password',this)" title="Show/hide">👁</span>
      </div>
      <a class="auth-forgot" onclick="doForgotPassword()">Forgot password?</a>
      <button class="btn btn-primary btn-full" style="margin-top:8px;" onclick="doSignIn()">Sign In →</button>
      <div class="auth-divider"><div class="auth-divider-line"></div><div class="auth-divider-text">or</div><div class="auth-divider-line"></div></div>
      <button class="btn btn-secondary btn-full" style="gap:8px;justify-content:center;" onclick="doGoogleSignIn()">
        <svg width="18" height="18" viewBox="0 0 18 18" style="flex-shrink:0"><path fill="#4285F4" d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844c-.209 1.125-.843 2.078-1.796 2.716v2.259h2.908c1.702-1.567 2.684-3.875 2.684-6.615z"/><path fill="#34A853" d="M9 18c2.43 0 4.467-.806 5.956-2.184l-2.908-2.259c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.711H.957v2.332A8.997 8.997 0 0 0 9 18z"/><path fill="#FBBC05" d="M3.964 10.706A5.41 5.41 0 0 1 3.682 9c0-.593.102-1.17.282-1.706V4.962H.957A8.996 8.996 0 0 0 0 9c0 1.452.348 2.827.957 4.038l3.007-2.332z"/><path fill="#EA4335" d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0A8.997 8.997 0 0 0 .957 4.962L3.964 7.294C4.672 5.163 6.656 3.58 9 3.58z"/></svg>
        Continue with Google
      </button>
      <div id="auth-error-banner" style="display:none;background:#FEF2F2;border:1px solid #FECACA;border-radius:10px;padding:12px 16px;margin-bottom:16px;font-size:0.85rem;color:#DC2626;font-weight:600;"></div>
      <div class="auth-demo-hint">
        <span class="auth-demo-hint-icon">💡</span>
        <span class="auth-demo-hint-text" id="authDemoHintText"><strong>Demo mode:</strong> Firebase not configured. Enter any email + password to explore.</span>
      </div>
    </div>

    <!-- Sign Up -->
    <div id="auth-signup-form" class="hidden">
      <h1 class="auth-right-heading">Start your family's quest</h1>
      <p class="auth-right-sub">Already have an account? <a onclick="switchAuthTab('signin')">Sign in →</a></p>
      <div class="auth-input-group">
        <label class="auth-input-label">Your first name</label>
        <input type="text" class="auth-input" id="signup-name" placeholder="e.g. Sarah" autocomplete="given-name">
      </div>
      <div class="auth-input-group">
        <label class="auth-input-label">Email address</label>
        <input type="email" class="auth-input" id="signup-email" placeholder="you@example.com" autocomplete="email">
      </div>
      <div class="auth-input-group" style="position:relative;">
        <label class="auth-input-label">Create a password</label>
        <input type="password" class="auth-input" id="signup-password" placeholder="At least 6 characters" autocomplete="new-password" oninput="checkStrength(this.value)">
        <span class="auth-pass-toggle" onclick="togglePass('signup-password',this)" title="Show/hide">👁</span>
        <div class="auth-strength" id="strengthBars">
          <div class="auth-strength-bar" id="sb1"></div>
          <div class="auth-strength-bar" id="sb2"></div>
          <div class="auth-strength-bar" id="sb3"></div>
          <div class="auth-strength-bar" id="sb4"></div>
        </div>
      </div>
      <button class="btn btn-primary btn-full" style="margin-top:4px;" onclick="doSignUp()">Create Free Account →</button>
      <p class="auth-terms">By creating an account you agree to our <a href="#">Terms of Service</a> and <a href="#">Privacy Policy</a>. FaithQuest never shares family data with third parties.</p>
    </div>
  </div>
</div>

<!-- ===== ONBOARDING ===== -->
<div id="screen-onboarding" class="screen" style="flex-direction:column;">
  <!-- Progress rail (top chrome) -->
  <div class="ob-rail">
    <button class="ob-rail-back" onclick="onboardBack()">←</button>
    <div class="ob-rail-segs" id="obSegBar"></div>
    <button class="ob-rail-skip" id="obSkip" onclick="onboardSkip()" style="display:none;">Skip</button>
  </div>
  <!-- Illustration card -->
  <div class="ob-card">
    <div class="ob-card-bg ob-bg-family" id="obHero">
      <div class="ob-card-dot-grid"></div>
      <div class="ob-card-glow"></div>
      <div class="ob-card-content" id="obHeroText"></div>
    </div>
  </div>
  <!-- Scrollable form body -->
  <div class="ob-body ob-slide" id="obBody"></div>
  <!-- Sticky CTA footer -->
  <div class="ob-footer">
    <button class="ob-cta-btn" id="onboardNext" onclick="onboardNextStep()">Continue →</button>
    <div class="ob-footer-note" id="obFooterNote"></div>
  </div>
</div>

<!-- ===== PARENT APP ===== -->
<div id="screen-parent" class="screen" style="flex-direction:column;">
  <div class="parent-topbar" id="parentTopbar">
    <a class="parent-topbar-logo" href="#">
      <div class="parent-topbar-logo-icon">✝️</div>
      <span class="parent-topbar-logo-text">FaithQuest</span>
    </a>
    <div class="parent-topbar-right">
      <!-- Kid quick-switch pills — rendered by JS -->
      <div class="kid-switcher" id="parentKidSwitcher"></div>
      <span class="badge badge-amber" id="planBadge" style="flex-shrink:0;">Free</span>
      <button class="btn btn-ghost btn-sm" onclick="doSignOut()" style="font-size:0.8rem;padding:6px 10px;flex-shrink:0;">Out</button>
    </div>
  </div>
  <div class="app-content" id="parentContent"></div>
  <nav class="bottom-nav">
    <button class="bottom-nav-item active" id="pnav-home" onclick="parentNav('home')"><span class="bottom-nav-icon">🏠</span><span class="bottom-nav-label">Home</span></button>
    <button class="bottom-nav-item" id="pnav-family" onclick="parentNav('family')"><span class="bottom-nav-icon">👨‍👩‍👧</span><span class="bottom-nav-label">Family</span></button>
    <button class="bottom-nav-item" id="pnav-paths" onclick="parentNav('paths')"><span class="bottom-nav-icon">📚</span><span class="bottom-nav-label">Paths</span></button>
    <button class="bottom-nav-item" id="pnav-approvals" onclick="parentNav('approvals')"><span class="bottom-nav-icon">✅</span><span class="bottom-nav-label">Approvals</span></button>
    <button class="bottom-nav-item" id="pnav-insights" onclick="parentNav('insights')"><span class="bottom-nav-icon">📊</span><span class="bottom-nav-label">Insights</span></button>
  </nav>
</div>

<!-- ===== KID APP ===== -->
<div id="screen-kid" class="screen" style="flex-direction:column;background:#F0F4FF;">
  <!-- Dark mode-bar at very top -->
  <div class="kid-mode-bar">
    <div class="kid-mode-left">
      <span class="kid-mode-logo">FaithQuest</span>
      <span class="kid-mode-sep">›</span>
      <span class="kid-mode-name" id="kidModeNameLabel">Loading...</span>
    </div>
    <button class="back-to-parent-btn" onclick="showParentApp()">⬆ Parent View</button>
  </div>
  <!-- Kid profile switcher (if multiple kids) -->
  <div class="kid-profile-switcher" id="kidProfileSwitcher" style="display:none;"></div>
  <!-- Main scrollable content -->
  <div style="flex:1;overflow-y:auto;" id="kidContentWrap">
    <div id="kidContent"></div>
  </div>
  <nav class="bottom-nav">
    <button class="bottom-nav-item active" id="knav-home" onclick="kidNav('home')"><span class="bottom-nav-icon">🏠</span><span class="bottom-nav-label">Home</span></button>
    <button class="bottom-nav-item" id="knav-rewards" onclick="kidNav('rewards')"><span class="bottom-nav-icon">🏆</span><span class="bottom-nav-label">Rewards</span></button>
    <button class="bottom-nav-item" id="knav-journal" onclick="kidNav('journal')" style="display:none;"><span class="bottom-nav-icon">✍️</span><span class="bottom-nav-label">Journal</span></button>
    <button class="bottom-nav-item" id="knav-library" onclick="kidNav('library')"><span class="bottom-nav-icon">📖</span><span class="bottom-nav-label">Library</span></button>
    <button class="bottom-nav-item" id="knav-profile" onclick="kidNav('profile')"><span class="bottom-nav-icon">😊</span><span class="bottom-nav-label">Me</span></button>
  </nav>
</div>

<!-- ===== LESSON PLAYER ===== -->
<div id="screen-lesson" class="screen" style="flex-direction:column;">
  <!-- Cinematic nav bar -->
  <div class="lp2-nav" id="lp2Nav">
    <button class="lp2-close" onclick="exitLesson()">✕</button>
    <div class="lp2-track" id="lp2Track"></div>
    <div class="lp2-fraction" id="lp2Fraction">1/6</div>
  </div>
  <!-- Scrollable content -->
  <div class="lp2-scroll" id="lessonScroll">
    <div id="lessonBody"></div>
  </div>
  <!-- Bottom action bar -->
  <div class="lp2-bar" id="lessonBottomBar">
    <button class="lp2-back-btn" id="lessonPrevBtn" onclick="lessonPrev()">← Back</button>
    <button class="lp2-next-btn" id="lessonNextBtn" onclick="lessonNext()">Continue →</button>
  </div>
</div>

<!-- ===== MISSION CHECK-IN ===== -->
<div id="screen-checkin" class="screen" style="flex-direction:column;">
  <!-- Cinematic nav -->
  <div class="ci-nav" id="ciNav">
    <button class="ci-close" onclick="exitCheckin()">✕</button>
    <div class="ci-track" id="ciTrack"></div>
    <div style="width:34px;"></div>
  </div>
  <!-- Scrollable content -->
  <div class="ci-scroll" id="ciScroll">
    <div id="checkinContent"></div>
  </div>
</div>

<!-- ===== MODALS ===== -->
<div class="modal-overlay" id="modal-add-member">
  <div class="modal">
    <div class="modal-handle"></div>
    <h2 class="modal-title">Add Family Member</h2>
    <p style="font-size:0.875rem;color:var(--slate-500);margin-bottom:24px;">Create a profile for your child or teen.</p>
    <div class="form-group"><label class="form-label">Display Name</label><input type="text" class="form-input" id="new-member-name" placeholder="e.g. Emma"></div>
    <div class="form-group"><label class="form-label">Age Tier</label>
      <select class="form-input" id="new-member-tier">
        <option value="younger">Little Explorer (4–6)</option>
        <option value="kid" selected>Kid (6–10)</option>
        <option value="teen">Teen (11–17)</option>
      </select>
    </div>
    <div class="form-group"><label class="form-label">Avatar</label>
      <div class="avatar-grid" id="newMemberAvatarGrid"></div>
    </div>
    <div style="display:flex;gap:12px;margin-top:8px;">
      <button class="btn btn-secondary" style="flex:1;" onclick="closeModal('modal-add-member')">Cancel</button>
      <button class="btn btn-primary" style="flex:1;" onclick="addMember()">Add Member</button>
    </div>
  </div>
</div>

<div class="modal-overlay tour-modal" id="modal-tour">
  <div class="modal" style="background:linear-gradient(160deg,#1E293B,#0F3460);border-radius:24px 24px 0 0;">
    <div class="modal-handle" style="background:rgba(255,255,255,0.2);"></div>
    <div id="tourContent"></div>
  </div>
</div>

<div class="modal-overlay" id="modal-ask-parent">
  <div class="modal">
    <div class="modal-handle"></div>
    <h2 class="modal-title">Ask a Parent</h2>
    <p style="font-size:0.9rem;color:var(--slate-600);line-height:1.7;margin-bottom:24px;">This is a great question! The best way to explore it is with your parent or guardian. They can help you understand more and answer your specific questions together.</p>
    <div style="background:var(--amber-light);border-radius:var(--radius);padding:16px;margin-bottom:24px;display:flex;gap:12px;">
      <span style="font-size:1.5rem;">💛</span>
      <p style="font-size:0.875rem;color:var(--gold);line-height:1.6;">FaithQuest is designed for families to learn together. Deep questions are best explored with your trusted adults!</p>
    </div>
    <button class="btn btn-primary btn-full" onclick="closeModal('modal-ask-parent')">Got it!</button>
  </div>
</div>

<!-- ===== FIREBASE BOOTSTRAP (must run before module) ===== -->
<script>
// Create the ready-gate BEFORE the module script loads
window._fbReady = new Promise(function(resolve){
  window._fbReadyResolve = resolve;
  // Safety timeout: resolve false after 6s so auth buttons never hang
  setTimeout(function(){ if(window._fbReadyResolve){ window._fbReadyResolve(false); window._fbReadyResolve=null; } }, 6000);
});
</script>

<!-- ===== FIREBASE SDK ===== -->
<script type="module">
// ─────────────────────────────────────────────────────────────────────────────
//  FIREBASE CONFIGURATION
//  Replace the placeholder values below with your Firebase project credentials.
//  Get them from: Firebase Console → Project Settings → Your apps → SDK setup
// ─────────────────────────────────────────────────────────────────────────────
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
import {
  getAuth, onAuthStateChanged,
  createUserWithEmailAndPassword, signInWithEmailAndPassword,
  signOut, sendPasswordResetEmail,
  GoogleAuthProvider, signInWithPopup, signInWithRedirect, getRedirectResult,
  updateProfile
} from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
import {
  getFirestore, doc, setDoc, getDoc, onSnapshot
} from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

const FIREBASE_CONFIG = {
  apiKey:            'AIzaSyCMue2lzNL73jok0wFku9K7lAy9BJsimyU',
  authDomain:        'faithquest-389f2.firebaseapp.com',
  projectId:         'faithquest-389f2',
  storageBucket:     'faithquest-389f2.firebasestorage.app',
  messagingSenderId: '1010380728213',
  appId:             '1:1010380728213:web:c4dec7d8bcfb58fa22789c',
};

const _fbConfigured = !FIREBASE_CONFIG.apiKey.startsWith('YOUR_');
let _fbApp, _fbAuth, _fbDb, _googleProvider, _unsubSnapshot;

if(_fbConfigured){
  try {
  _fbApp          = initializeApp(FIREBASE_CONFIG);
  _fbAuth         = getAuth(_fbApp);
  _fbDb           = getFirestore(_fbApp);
  _googleProvider = new GoogleAuthProvider();

  // ── Handle Google redirect result on page load ────────────────────────────
  getRedirectResult(_fbAuth).then(result => {
    if(result?.user) console.log('[FQ] Google redirect sign-in succeeded:', result.user.email);
  }).catch(e => {
    if(e.code !== 'auth/no-current-user') console.error('[FQ] Redirect result error:', e);
  });

  // ── Auth state listener ────────────────────────────────────────────────────
  onAuthStateChanged(_fbAuth, async (fbUser) => {
    // Signal that Firebase is live and ready
    if(window._fbReadyResolve){ window._fbReadyResolve(true); window._fbReadyResolve=null; }
    if(fbUser){
      window._fbUser = fbUser;
      state.currentUser = {
        id: fbUser.uid,
        name: fbUser.displayName || fbUser.email.split('@')[0],
        email: fbUser.email,
        photoURL: fbUser.photoURL || null,
      };
      await _fbLoadUserData(fbUser.uid);
      // Subscribe to real-time updates
      if(_unsubSnapshot) _unsubSnapshot();
      _unsubSnapshot = onSnapshot(doc(_fbDb,'users',fbUser.uid), snap => {
        if(snap.exists() && window._fbUser){
          const d = snap.data();
          state.family       = d.family       || state.family;
          state.members      = d.members      || state.members;
          state.completions  = d.completions  || state.completions;
          state.checkins     = d.checkins     || state.checkins;
          state.subscription = d.subscription || state.subscription;
          state.selectedPath = d.selectedPath || state.selectedPath;
          // Quietly refresh current visible tab
          _quietRefresh();
        }
      });
      try {
        routeAfterAuth();
      } catch(e) {
        console.error('[FQ] routeAfterAuth crashed:', e);
        // routeAfterAuth missing or broken — navigate manually
        if(!state.family){ startOnboarding(); }
        else {
          const parent = state.members.find(m => m.role === 'parent');
          if(parent){ showParentApp(); } else { showKidApp(); }
        }
      }
    } else {
      window._fbUser = null;
      if(_unsubSnapshot){ _unsubSnapshot(); _unsubSnapshot = null; }
      if(document.querySelector('.screen.active')?.id !== 'screen-landing'){
        showScreen('screen-landing');
      }
    }
    const ov = document.getElementById('fq-loading-overlay');
    if(ov) ov.style.display = 'none';
    // Re-enable any stuck auth buttons
    document.querySelectorAll('#auth-signin-form .btn-primary, #auth-signup-form .btn-primary').forEach(b => {
      b.disabled = false;
    });
  });
  } catch(e) {
    console.error('[FaithQuest] Firebase init error:', e);
    const ov = document.getElementById('fq-loading-overlay');
    if(ov) ov.style.display = 'none';
  }
} else {
  // No Firebase — hide overlay immediately, stay in demo mode
  const ov = document.getElementById('fq-loading-overlay');
  if(ov) ov.style.display = 'none';
  console.info('[FaithQuest] Running in demo mode — Firebase not configured.');
}

// ── Firestore read ──────────────────────────────────────────────────────────
async function _fbLoadUserData(uid){
  try {
    const snap = await getDoc(doc(_fbDb, 'users', uid));
    if(snap.exists()){
      const d = snap.data();
      state.family       = d.family       || null;
      state.members      = d.members      || [];
      state.completions  = d.completions  || [];
      state.checkins     = d.checkins     || [];
      state.journals     = d.journals     || [];
      state.subscription = d.subscription || {plan:'free'};
      state.selectedPath = d.selectedPath || 'jesus';
      state.selectedMember = d.selectedMember || null;
    } else {
      // New user — also try migrating from localStorage
      const local = JSON.parse(localStorage.getItem('fq_data_'+uid)||'null');
      if(local){
        state.family       = local.family       || null;
        state.members      = local.members      || [];
        state.completions  = local.completions  || [];
        state.checkins     = local.checkins     || [];
        state.subscription = local.subscription || {plan:'free'};
        state.selectedPath = local.selectedPath || 'jesus';
        state.selectedMember = local.selectedMember || null;
        // Migrate to Firestore
        await _fbSaveUserData(uid);
        showToast('Data migrated to cloud sync ☁️');
      }
    }
  } catch(e){
    console.error('[FaithQuest] Firestore read failed:', e);
    // Fallback to localStorage
    const local = JSON.parse(localStorage.getItem('fq_data_'+uid)||'null');
    if(local){ Object.assign(state, local); }
  }
}

// ── Firestore write ─────────────────────────────────────────────────────────
async function _fbSaveUserData(uid){
  try {
    await setDoc(doc(_fbDb,'users',uid||state.currentUser?.id), {
      family:        state.family,
      members:       state.members,
      completions:   state.completions,
      checkins:      state.checkins,
      journals:      state.journals||[],
      subscription:  state.subscription,
      selectedPath:  state.selectedPath,
      selectedMember:state.selectedMember,
      updatedAt:     new Date().toISOString(),
    }, {merge:true});
  } catch(e){
    console.error('[FaithQuest] Firestore write failed:', e);
  }
}

// ── Quiet refresh ───────────────────────────────────────────────────────────
function _quietRefresh(){
  const activeTab = state.parentTab || state.kidTab;
  if(!activeTab) return;
  const parentEl = document.getElementById('parentContent');
  const kidEl    = document.getElementById('kidContent');
  if(parentEl && document.getElementById('screen-parent')?.classList.contains('active')){
    parentNav(state.parentTab||'home');
  } else if(kidEl && document.getElementById('screen-kid')?.classList.contains('active')){
    kidNav(state.kidTab||'home');
  }
}

// ── Expose Firebase functions to global scope ─────────────────────────────
window._fb = {
  configured: _fbConfigured,
  auth: () => _fbAuth,
  db:   () => _fbDb,
  save: _fbSaveUserData,
  load: _fbLoadUserData,
  signIn:  async (email, pass) => signInWithEmailAndPassword(_fbAuth, email, pass),
  signUp:  async (email, pass, name) => {
    const cred = await createUserWithEmailAndPassword(_fbAuth, email, pass);
    if(name) await updateProfile(cred.user, {displayName: name});
    return cred;
  },
  signOut: async () => signOut(_fbAuth),
  resetPw: async (email) => sendPasswordResetEmail(_fbAuth, email),
  googleSignIn: async () => {
    // Try popup first; fall back to redirect if blocked
    try {
      return await signInWithPopup(_fbAuth, _googleProvider);
    } catch(e) {
      if(e.code === 'auth/popup-blocked' || e.code === 'auth/popup-cancelled-by-user') {
        return signInWithRedirect(_fbAuth, _googleProvider);
      }
      throw e;
    }
  },
};
</script>

<script>
// ===================== DATA =====================
const PATHS = [
  {id:'jesus',emoji:'✝️',color:'path-jesus',title:'Jesus & Me',desc:'Discover who Jesus is through stories, miracles, and His teachings.',tier:'free',lessons:[
    {id:'j1',title:'Jesus, the Good Shepherd',verseRef:'John 10:11',excerpt:'"I am the good shepherd. The good shepherd lays down his life for the sheep." — John 10:11 (WEB)',summary:'Jesus compares himself to a shepherd who truly cares for and protects his sheep—even at great cost.',questions:['What does it mean to you that Jesus calls himself your shepherd?','How does a good shepherd act differently from someone who doesn\'t care about the sheep?','Where in your week could you be a "good shepherd" to a friend?'],missions:[{emoji:'🐑',title:'Protect a Friend',desc:'This week, stand up for someone who is being left out or picked on. Be their shepherd.',level:'Easy'},{emoji:' ✉️',title:'Write a Care Note',desc:'Write or draw a note for someone who might feel alone. Deliver it in person.',level:'Medium'},{emoji:'🙏',title:'Prayer Vigil',desc:'Keep a list of 3 people you want to pray for every day this week.',level:'Medium'}],reflectPrompts:['How did doing this mission feel?','What was hard about it?','How do you think God felt watching you?']},
    {id:'j2',title:'Jesus Calms the Storm',verseRef:'Mark 4:39',excerpt:'"He awoke, and rebuked the wind, and said to the sea, \'Peace! Be still!\' The wind ceased, and there was a great calm." — Mark 4:39 (WEB)',summary:'When a fierce storm scared the disciples, Jesus spoke peace into the chaos—reminding us he has authority over what frightens us.',questions:['Have you ever felt like you were in a "storm"—a scary or overwhelming situation?','Why do you think the disciples were afraid even though Jesus was in the boat?','What does it look like to trust Jesus in a stormy moment?'],missions:[{emoji:'🌊',title:'Peace Partner',desc:'Help calm a tense moment at home. If someone is arguing or upset, be the peacemaker.',level:'Medium'},{emoji:'✍️',title:'Storm Journal',desc:'Write or draw a "storm" in your life and then write "Peace, be still!" over it.',level:'Easy'},{emoji:'🤝',title:'Be the Anchor',desc:'Check in on someone who seems stressed or worried. Offer to sit with them.',level:'Easy'}],reflectPrompts:['What was your personal storm this week?','How did leaning on faith help (or feel hard)?','What would you do differently next time?']},
    {id:'j3',title:'The Prodigal Son',verseRef:'Luke 15:20',excerpt:'"He arose, and came to his father. But while he was yet far off, his father saw him, and was moved with compassion, and ran, and fell on his neck, and kissed him." — Luke 15:20 (WEB)',summary:'A son wastes his father\'s money but returns in shame—and the father runs to embrace him. This is how God feels about us.',questions:['Why did the father run to his son instead of waiting for an apology?','Is there someone you need to forgive or make up with?','How does it feel to know God welcomes you back no matter what?'],missions:[{emoji:'🫂',title:'Make It Right',desc:'Apologize to someone you\'ve hurt or drifted from. Mean it.',level:'Hard'},{emoji:'🍽️',title:'Welcome Table',desc:'Invite someone who often eats alone to share your lunch or dinner.',level:'Medium'},{emoji:'📜',title:'Grace Letter',desc:'Write a letter to yourself from God\'s perspective of welcome and love.',level:'Medium'}],reflectPrompts:['How did apologizing (or being forgiven) feel?','What did you learn about grace this week?','How has God\'s welcome changed how you treat others?']},
    {id:'j4',title:'The Sermon on the Mount',verseRef:'Matthew 5:3',excerpt:'"Blessed are the poor in spirit, for theirs is the Kingdom of Heaven." — Matthew 5:3 (WEB)',summary:'Jesus starts his most famous sermon by turning worldly values upside down—blessing those who feel humble, broken, or overlooked.',questions:['Which Beatitude speaks most to you right now and why?','What does it mean to be "poor in spirit"?','How can we build our lives on these blessings instead of what the world values?'],missions:[{emoji:'🌿',title:'Humble Servant',desc:'Do one household chore or service task without being asked and without telling anyone.',level:'Easy'},{emoji:'💧',title:'Comfort Someone',desc:'Find someone who is sad or grieving. Offer your presence and kind words.',level:'Medium'},{emoji:'☮️',title:'Peacemaker Day',desc:'Go one whole day without speaking negatively about anyone.',level:'Hard'}],reflectPrompts:['Which beatitude did you live out this week?','Was it hard? What made it hard?','How did you see God in that moment?']},
    {id:'j5',title:'Jesus & the Children',verseRef:'Mark 10:14',excerpt:'"Suffer the little children to come to me; forbid them not: for of such is the kingdom of God." — Mark 10:14 (KJV)',summary:'When people tried to keep children away from Jesus, he welcomed them and said the Kingdom of Heaven belongs to such as these.',questions:['How does it feel knowing Jesus made time especially for children?','What childlike qualities do you think Jesus was pointing to—curiosity, wonder, trust?','How can your family bring that kind of childlike faith to your daily life?'],missions:[{emoji:'🧸',title:'Kid Expert',desc:'Teach an adult something you know well—a game, a fact, a skill.',level:'Easy'},{emoji:'🌟',title:'Wonder Walk',desc:'Go outside and find 5 things that make you say "wow." Thank God for each.',level:'Easy'},{emoji:'🙌',title:'Welcome Others',desc:'At school or church, be the first to welcome someone new or shy.',level:'Medium'}],reflectPrompts:['What wonder did you notice this week?','How did your family practice childlike faith together?','What surprised you about God this week?']},
    {id:'j6',title:'The Last Supper',verseRef:'Luke 22:19',excerpt:'"He took bread, and when he had given thanks, he broke it, and gave it to them, saying, \'This is my body which is given for you. Do this in memory of me.\'" — Luke 22:19 (WEB)',summary:'Jesus shared one final meal with his disciples, turning a simple dinner into a moment of remembrance, love, and covenant.',questions:['Why do you think Jesus chose a meal to remember him by?','What does it mean to do something "in memory of" someone you love?','How can your family meals become more intentional and meaningful?'],missions:[{emoji:'🍞',title:'Gratitude Meal',desc:'At dinner, have everyone share one thing they\'re grateful for before eating.',level:'Easy'},{emoji:'🕯️',title:'Table Talk',desc:'Put away all devices at one family meal this week. Just talk.',level:'Medium'},{emoji:'✝️',title:'Serve First',desc:'At every meal this week, serve someone else\'s plate before your own.',level:'Medium'}],reflectPrompts:['What changed about your meals this week?','How did gratitude change the atmosphere?','What does Jesus\' sacrifice mean to you personally?']},
    {id:'j7',title:'The Resurrection',verseRef:'John 20:15',excerpt:'"Jesus said to her, \'Woman, why do you weep? Who are you looking for?\'" — John 20:15 (WEB)',summary:'Mary Magdalene discovers the empty tomb and encounters the risen Jesus—one of history\'s most stunning moments of hope defeating despair.',questions:['Why do you think Jesus appeared first to Mary, not to important religious leaders?','Easter changes everything—but how does the resurrection matter for Monday mornings?','What "empty tomb" moments—times despair turned to hope—have you experienced?'],missions:[{emoji:'🌅',title:'Sunrise Reflection',desc:'Wake up early one day this week. Watch the sunrise and think about new beginnings.',level:'Medium'},{emoji:'📣',title:'Share Good News',desc:'Tell one person this week something genuinely good and hopeful.',level:'Easy'},{emoji:'🌱',title:'Plant Something',desc:'Plant a seed (in soil, a cup, or outside) as a symbol of new life.',level:'Easy'}],reflectPrompts:['How did resurrection hope show up in your week?','What "new life" are you hoping for right now?','How does knowing Jesus rose change how you face tomorrow?']}
  ]},
  {id:'fruit',emoji:'🍎',color:'path-fruit',title:'Fruit of the Spirit',desc:'Love, joy, peace, patience—learn to grow these character qualities.',tier:'premium',lessons:[
    {id:'f1',title:'Love: The Greatest Fruit',verseRef:'1 Corinthians 13:4',excerpt:'"Love is patient and is kind; love doesn\'t envy. Love doesn\'t brag, is not proud." — 1 Corinthians 13:4 (WEB)',summary:'Paul\'s famous love definition sets the gold standard—it\'s about actions and choices, not just feelings.',questions:['Which part of this love definition is hardest for you?','How is love a "choice" more than just a feeling?','Who in your life needs to experience this kind of love from you this week?'],missions:[{emoji:'❤️',title:'Love Letter',desc:'Write a genuine thank-you or encouragement note to someone in your family.',level:'Easy'},{emoji:'😤',title:'Patience Test',desc:'When you feel impatient today, pause and take 3 deep breaths before reacting.',level:'Hard'},{emoji:'🎁',title:'Kind Act',desc:'Do one unexpected kind act for a stranger or neighbor.',level:'Medium'}],reflectPrompts:['Which part of 1 Cor 13 did you live out?','What made it hard?','What did love look like in action this week?']},
    {id:'f2',title:'Joy: More Than Happiness',verseRef:'Nehemiah 8:10',excerpt:'"The joy of Yahweh is your strength." — Nehemiah 8:10 (WEB)',summary:'Joy in scripture isn\'t about circumstances—it\'s a deep-rooted strength that comes from knowing God is with you.',questions:['What\'s the difference between joy and just feeling happy?','When has your family had joy even in a hard time?','What practices or habits help you stay joyful?'],missions:[{emoji:'😂',title:'Laugh Together',desc:'Watch a funny video or tell jokes as a family for 15 minutes tonight.',level:'Easy'},{emoji:'📔',title:'Joy List',desc:'Each day, write 3 things that gave you joy. Share one at dinner.',level:'Easy'},{emoji:'🙏',title:'Joy Prayer',desc:'Pray specifically for someone who has lost their joy.',level:'Medium'}],reflectPrompts:['What gave you the most joy this week?','How is joy different from what you expected?','How did you pass joy on to someone else?']},
    {id:'f3',title:'Peace: More Than Quiet',verseRef:'Philippians 4:7',excerpt:'"The peace of God, which surpasses all understanding, will guard your hearts and your minds in Christ Jesus." — Philippians 4:7 (WEB)',summary:'Paul wrote this from prison—showing that peace is not about easy circumstances but a supernatural guard for your heart.',questions:['How can someone have peace in a hard situation?','What steals your peace most often?','What would change if you truly believed God was guarding your heart?'],missions:[{emoji:'🌿',title:'Peace Zone',desc:'Create a quiet corner in your room. Spend 5 mins there in silence each day.',level:'Medium'},{emoji:'⚔️',title:'Peace Keeper',desc:'When conflict arises in your home, be the first to work toward peace.',level:'Hard'},{emoji:'📖',title:'Memorize Philippians 4:7',desc:'Memorize this verse this week and share it with someone who needs it.',level:'Medium'}],reflectPrompts:['Where did you find unexpected peace?','What still steals your peace?','How are you growing in trusting God\'s peace?']},
    {id:'f4',title:'Patience: The Long Game',verseRef:'Romans 5:3-4',excerpt:'"Tribulation produces perseverance; and perseverance, proven character; and proven character, hope." — Romans 5:3–4 (WEB)',summary:'Paul explains that patience isn\'t passive waiting—it\'s active trust that builds strength of character over time.',questions:['What is something you\'re waiting for right now?','How do you think waiting builds character?','Can you think of a time when being patient paid off?'],missions:[{emoji:'⏳',title:'No Rush Day',desc:'For one whole day, practice not rushing. Move slower and notice more.',level:'Hard'},{emoji:'🌱',title:'Long-Term Project',desc:'Start something that won\'t finish for weeks (garden, puzzle, craft, skill).',level:'Medium'},{emoji:'🤝',title:'Wait for Others',desc:'Deliberately let others go first in lines, decisions, or conversations.',level:'Medium'}],reflectPrompts:['Where did you practice patience this week?','What was the hardest moment?','How did patience change the outcome?']},
    {id:'f5',title:'Kindness: Every Day Acts',verseRef:'Ephesians 4:32',excerpt:'"Be kind to one another, tenderhearted, forgiving each other, just as God also in Christ forgave you." — Ephesians 4:32 (WEB)',summary:'Kindness is linked directly to forgiveness—we give it because we\'ve received it. It\'s a response to grace, not just etiquette.',questions:['Is it easier to be kind to strangers or to people you know well? Why?','How does knowing God forgave you change how you forgive others?','Who in your world needs an unexpected act of kindness this week?'],missions:[{emoji:'💌',title:'Kindness Cards',desc:'Make 3 cards with kind messages and leave them somewhere they\'ll be found.',level:'Easy'},{emoji:'🧹',title:'Service Day',desc:'Clean up a space—a park, a neighbor\'s yard, the church parking lot.',level:'Medium'},{emoji:'🤗',title:'Warm Welcome',desc:'Greet every person you pass today with eye contact and a smile.',level:'Medium'}],reflectPrompts:['How did random kindness change your day?','Was it easy or awkward? Why?','What would happen if you did this every week?']},
    {id:'f6',title:'Goodness: Character Inside Out',verseRef:'Psalm 23:6',excerpt:'"Surely goodness and loving kindness shall follow me all the days of my life." — Psalm 23:6 (WEB)',summary:'Goodness isn\'t just doing good things—it\'s developing a good character from the inside, so right actions flow naturally.',questions:['What\'s the difference between acting good and being good?','What habits are building goodness in you right now?','How does God\'s goodness inspire your own?'],missions:[{emoji:'🌟',title:'Character Check',desc:'Ask a trusted friend: "What\'s one way I could grow in goodness?" Listen without defending.',level:'Hard'},{emoji:'📖',title:'Goodness Biography',desc:'Read about a person of great character. Share one thing that inspired you.',level:'Medium'},{emoji:'🧩',title:'Integrity Test',desc:'Do the right thing in one situation this week when no one is watching.',level:'Hard'}],reflectPrompts:['What did you learn about goodness this week?','Where did your character show up clearly?','How are you becoming more good from the inside?']},
    {id:'f7',title:'Self-Control: The Master Key',verseRef:'Proverbs 25:28',excerpt:'"Like a city that is broken down and without walls is a man whose spirit is without restraint." — Proverbs 25:28 (WEB)',summary:'Ancient cities relied on strong walls—the Bible says self-control is your inner wall, protecting everything good inside you.',questions:['What "walls" do you need in your own life—habits or limits that protect you?','What area is hardest for you to control: words, screen time, food, anger?','How does self-control actually make you more free, not less?'],missions:[{emoji:'📵',title:'Screen Sabbath',desc:'Take one day off from screens (except school needs). Fill the time with something real.',level:'Hard'},{emoji:'🏋️',title:'Discipline Streak',desc:'Do one healthy habit every day for 7 days: walk, pray, read, journal.',level:'Medium'},{emoji:'🤐',title:'Filter Challenge',desc:'Before speaking when upset, ask: "Is this True, Helpful, Kind?" This week, pause 3 times.',level:'Hard'}],reflectPrompts:['What habit of self-control did you practice?','What surprised you about it?','How is self-control making you stronger?']}
  ]},
  {id:'courage',emoji:'🦁',color:'path-courage',title:'Courage & Anxiety',desc:'Biblical tools for facing fears and worry with faith.',tier:'premium',lessons:[
    {id:'c1',title:"Don't Be Afraid",verseRef:'Isaiah 41:10',excerpt:'"Don\'t be afraid, for I am with you. Don\'t be dismayed, for I am your God." — Isaiah 41:10 (WEB)',summary:'God spoke this to Israel in exile—not a promise of no problems, but a promise of His constant presence.',questions:['What are you currently afraid of?','How does knowing God is present change how you face fear?','What would you do differently this week if you truly believed God was with you?'],missions:[{emoji:'🦁',title:'Brave Act',desc:'Do one thing this week that scares you a little. Then reflect on it.',level:'Hard'},{emoji:'🗣️',title:'Tell Your Fear',desc:'Share one fear with a trusted family member. Ask them to pray for you.',level:'Medium'},{emoji:'📜',title:'Memorize It',desc:'Memorize Isaiah 41:10 and say it out loud when fear comes.',level:'Easy'}],reflectPrompts:['What did you face with courage?','Was God\'s presence real to you in that moment?','How has your fear changed?']},
    {id:'c2',title:'When You Feel Anxious',verseRef:'Philippians 4:6',excerpt:'"In nothing be anxious, but in everything, by prayer and petition with thanksgiving, let your requests be made known to God." — Philippians 4:6 (WEB)',summary:'Paul\'s remedy for anxiety is startlingly simple: replace worry with prayer and gratitude. Research now confirms this practice reduces anxiety.',questions:['What do you worry about most? Does worrying change it?','How is prayer different from just "positive thinking"?','What can you be genuinely grateful for even when things are hard?'],missions:[{emoji:'📓',title:'Anxiety Journal',desc:'Write down your worries, then cross them out and write a prayer over each one.',level:'Medium'},{emoji:'🙏',title:'Gratitude Swap',desc:'Each time you catch yourself worrying, name 3 things you\'re grateful for instead.',level:'Hard'},{emoji:'🤲',title:'Pray Together',desc:'Share one worry with your family and pray over it together tonight.',level:'Easy'}],reflectPrompts:['How did replacing worry with prayer feel?','Was it hard? What helped?','How has your anxiety changed this week?']},
    {id:'c3',title:'David & Goliath',verseRef:'1 Samuel 17:45',excerpt:'"David said to the Philistine, \'You come to me with a sword, with a spear, and with a javelin, but I come to you in the name of Yahweh of Armies.\'" — 1 Samuel 17:45 (WEB)',summary:'A teenage shepherd defeated a giant warrior—not because he was strongest, but because he trusted God\'s power over his own.',questions:['What is your "Goliath"—the big, scary challenge you\'re facing right now?','David ran toward the giant. What would running toward your fear look like?','How does bringing God into a scary situation change it?'],missions:[{emoji:'⚔️',title:'Face Your Giant',desc:'Identify one "Goliath" situation. Take one small brave step toward it this week.',level:'Hard'},{emoji:'🪨',title:'5 Smooth Stones',desc:'Write 5 strengths or gifts God has given you. Remember them when afraid.',level:'Easy'},{emoji:'📣',title:'Courage Cheer',desc:'Encourage someone who is facing their own giant. Send a message or tell them in person.',level:'Medium'}],reflectPrompts:['What giant did you face?','How did God show up?','What would you say to someone facing the same giant?']},
    {id:'c4',title:'Elijah\'s Burnout',verseRef:'1 Kings 19:5',excerpt:'"An angel touched him, and said to him, \'Arise and eat.\'" — 1 Kings 19:5 (WEB)',summary:'After a great victory, Elijah collapsed in exhaustion and despair. God\'s first response was sleep and food—rest is part of courage.',questions:['Have you ever felt completely burnt out or exhausted?','Why do you think God focused on Elijah\'s physical needs first?','What does it tell us about God that he cares about our rest?'],missions:[{emoji:'😴',title:'Rest Practice',desc:'Go to bed 30 minutes earlier every night this week.',level:'Medium'},{emoji:'🍽️',title:'Nourish Well',desc:'Pay attention to what you eat this week. Choose one nourishing habit to add.',level:'Easy'},{emoji:'🚶',title:'Still Walk',desc:'Take a 15-minute walk in nature with no phone. Just breathe and notice.',level:'Easy'}],reflectPrompts:['How did intentional rest change your energy?','Where did you feel God\'s care this week?','What burnout habits do you want to change?']},
    {id:'c5',title:'Joshua\'s Commission',verseRef:'Joshua 1:9',excerpt:'"Be strong and courageous. Don\'t be afraid, and don\'t be dismayed, for Yahweh your God is with you wherever you go." — Joshua 1:9 (WEB)',summary:'God spoke this before Joshua faced the impossible task of leading a nation. Courage was commanded—not just hoped for.',questions:['If courage is a command, what does that tell us about how to develop it?','What task feels impossible to you right now?','How can your family build courage in each other?'],missions:[{emoji:'🗺️',title:'New Territory',desc:'Try something completely new this week—a new skill, food, conversation, or place.',level:'Medium'},{emoji:'🧭',title:'Lead Something',desc:'Take initiative to organize or lead a family activity this week.',level:'Medium'},{emoji:'📢',title:'Speak Up',desc:'Say something true but difficult this week. Speak up when you see something wrong.',level:'Hard'}],reflectPrompts:['What new territory did you enter?','How did leading feel?','Where did you speak courage this week?']},
    {id:'c6',title:'Peace Like a River',verseRef:'Isaiah 48:18',excerpt:'"Oh that you had listened to my commandments! Then your peace would have been like a river." — Isaiah 48:18 (WEB)',summary:'Isaiah paints peace as a flowing river—constant, natural, and life-giving when we\'re connected to God\'s way of living.',questions:['What does "peace like a river" look like in real life?','What disrupts the flow of peace in your life most often?','What one choice could you make this week to flow more toward peace?'],missions:[{emoji:'💧',title:'Peace Practice',desc:'Spend 10 minutes each morning in quiet before screens. Do this 5 of 7 days.',level:'Hard'},{emoji:'🕊️',title:'Be the Peace',desc:'In one tense situation this week, choose peace instead of escalation.',level:'Hard'},{emoji:'🎵',title:'Worship Therapy',desc:'When anxiety rises, play worship music for 5 minutes and sing along.',level:'Easy'}],reflectPrompts:['When did peace flow most naturally?','What blocked the river this week?','How is your relationship with peace growing?']},
    {id:'c7',title:'The Armor of God',verseRef:'Ephesians 6:11',excerpt:'"Put on the whole armor of God, that you may be able to stand against the wiles of the devil." — Ephesians 6:11 (WEB)',summary:'Paul describes six pieces of spiritual armor—each representing a dimension of our inner life that needs to be protected and strengthened.',questions:['Which piece of armor do you think you most need right now?','How is prayer described as a weapon, not just a spiritual discipline?','What would "putting on the armor" look like practically every morning?'],missions:[{emoji:'🛡️',title:'Morning Armor',desc:'Each morning this week, say: "I put on truth, righteousness, peace, faith, salvation, and God\'s Word."',level:'Easy'},{emoji:'⚔️',title:'Scripture Sword',desc:'Memorize one verse this week and use it when temptation or fear comes.',level:'Medium'},{emoji:'🙏',title:'Intercessor',desc:'Pray for three people in spiritual battles: someone sick, someone doubting, someone straying.',level:'Medium'}],reflectPrompts:['Which piece of armor did you use?','How did having a "prepared mind" change your day?','What spiritual battle did God help you win?']}
  ]},
  {id:'words',emoji:'💬',color:'path-words',title:'Words & Actions',desc:'Honesty, kindness in speech, and how words shape the world.',tier:'premium',lessons:[
    {id:'w1',title:'The Power of the Tongue',verseRef:'Proverbs 18:21',excerpt:'"Death and life are in the power of the tongue; and those who love it will eat its fruit." — Proverbs 18:21 (WEB)',summary:'Solomon recognized what neuroscience now confirms: words have enormous power to build up or tear down.',questions:['Think of a time someone\'s words greatly impacted you—positively or negatively.','Why do you think the Bible compares the tongue to life and death?','What one change to your speech would make the biggest difference this week?'],missions:[{emoji:'🗣️',title:'Word Fast',desc:'Go one day without speaking negatively, complaining, or gossiping.',level:'Hard'},{emoji:'💬',title:'Life Words',desc:'Intentionally speak words of life to 3 different people today.',level:'Easy'},{emoji:'📝',title:'Speech Audit',desc:'At the end of each day this week, reflect: did my words give life or bring harm today?',level:'Medium'}],reflectPrompts:['When did your words give life this week?','When did you struggle to control your tongue?','What changed when you spoke more intentionally?']},
    {id:'w2',title:'Honesty Over Everything',verseRef:'Proverbs 12:22',excerpt:'"Lying lips are an abomination to Yahweh, but those who act faithfully are his delight." — Proverbs 12:22 (WEB)',summary:'Honesty is not just a rule—it\'s fundamental to God\'s character and to trust in all relationships.',questions:['Why is honesty so important in a family?','Is it ever right to tell a "kind lie"? How do you navigate that?','What makes it hard to be fully honest sometimes?'],missions:[{emoji:'🎯',title:'Truth Day',desc:'For one whole day, commit to saying only what is completely true. Notice what changes.',level:'Hard'},{emoji:'🤝',title:'Honesty Conversation',desc:'Have a genuinely honest conversation with a family member about something important.',level:'Hard'},{emoji:'✋',title:'Kindly Correct',desc:'Gently and kindly correct a misunderstanding you\'ve let slide for too long.',level:'Medium'}],reflectPrompts:['How did choosing honesty feel?','What was hard about it?','How did honesty affect your relationships this week?']},
    {id:'w3',title:'Gossip & What It Costs',verseRef:'Proverbs 26:20',excerpt:'"For lack of wood, a fire goes out. Without a gossip, a quarrel dies down." — Proverbs 26:20 (WEB)',summary:'Gossip is the fuel of conflict—remove it and many fights simply die. Solomon\'s wisdom is practical and protective.',questions:['Why do you think gossip is tempting even when we know it\'s harmful?','Have you ever been the subject of gossip? How did it feel?','What is one practical rule you could set for your family or friend group about gossip?'],missions:[{emoji:'🤫',title:'Secret Keeper',desc:'This week, if someone tells you private information, keep it completely private.',level:'Medium'},{emoji:'🔥',title:'Fire Extinguisher',desc:'When gossip starts in a group, gently change the subject or say something positive about the person.',level:'Hard'},{emoji:'📣',title:'Speak Well',desc:'Whenever you mention someone who isn\'t present, only say things you\'d say to their face.',level:'Hard'}],reflectPrompts:['Where did you fight the gossip temptation?','How did keeping confidences feel?','What did you notice about conversation dynamics?']},
    {id:'w4',title:'Words That Heal',verseRef:'Proverbs 16:24',excerpt:'"Pleasant words are like a honeycomb: sweet to the soul, and health to the bones." — Proverbs 16:24 (WEB)',summary:'Kind, well-chosen words are literally compared to medicine—they have the power to heal and restore.',questions:['Who in your life needs healing words right now?','What stops you from saying encouraging things when you feel them?','How can your family make encouragement a daily practice?'],missions:[{emoji:'🍯',title:'Honey Words',desc:'Tell someone something genuinely encouraging that you\'ve been holding back.',level:'Easy'},{emoji:'✍️',title:'Healing Note',desc:'Write a note to someone who is hurting. Focus only on encouragement and love.',level:'Easy'},{emoji:'📅',title:'Daily Compliment',desc:'Give one genuine compliment per day for 7 days to different people.',level:'Medium'}],reflectPrompts:['How did speaking healing words feel?','Who responded most meaningfully?','How are you growing in encouragement?']},
    {id:'w5',title:'The Way You Ask Matters',verseRef:'Proverbs 15:1',excerpt:'"A gentle answer turns away wrath, but a harsh word stirs up anger." — Proverbs 15:1 (WEB)',summary:'How we say something often matters more than what we say. A gentle tone can de-escalate any conflict.',questions:['Think of a recent disagreement. How did your tone affect the outcome?','What techniques help you respond gently when you\'re upset?','How can your family practice this together?'],missions:[{emoji:'🕊️',title:'Tone Challenge',desc:'In one difficult conversation this week, lower your voice and soften your tone intentionally.',level:'Hard'},{emoji:'🔁',title:'Restate & Listen',desc:'Before responding in an argument, restate what the other person said first.',level:'Hard'},{emoji:'📱',title:'Calm Text',desc:'Before sending any upset text or message, wait 10 minutes and reread it.',level:'Medium'}],reflectPrompts:['When did your tone help or hurt this week?','What was the hardest moment to respond gently?','How is your communication style growing?']},
    {id:'w6',title:'Actions Speak Louder',verseRef:'1 John 3:18',excerpt:'"My little children, let\'s not love in word only, or with the tongue only, but in deed and truth." — 1 John 3:18 (WEB)',summary:'John cuts through verbal niceness—real love shows up in what we do, not just what we say.',questions:['Think of someone whose love you feel through their actions. What do they do?','Where might you be saying loving things but not backing them up?','What is one concrete action you can take this week to show love?'],missions:[{emoji:'🛠️',title:'Fix Something',desc:'Do a practical act of service that someone close to you needs.',level:'Medium'},{emoji:'🤲',title:'Show Up',desc:'Be physically present for someone who needs support—visit, sit with, be there.',level:'Medium'},{emoji:'🎁',title:'Action Gift',desc:'Give your time instead of a thing. Offer 30 minutes of undivided attention.',level:'Easy'}],reflectPrompts:['What action did you take to show love?','How was it received?','How does doing feel different from saying?']},
    {id:'w7',title:'Speaking Truth in Love',verseRef:'Ephesians 4:15',excerpt:'"But speaking truth in love, we may grow up in all things into him, who is the head, Christ." — Ephesians 4:15 (WEB)',summary:'Truth without love is brutal. Love without truth is hollow. The Bible calls us to hold them together.',questions:['When is it loving to tell someone a hard truth?','How do you tell when "honesty" is actually just unkindness with an excuse?','What is a truth you need to share with someone in love this week?'],missions:[{emoji:'💌',title:'Loving Truth',desc:'Share something true but kind with someone who needs to hear it. Do it with gentleness.',level:'Hard'},{emoji:'👂',title:'Loving Listen',desc:'Ask someone: "Can I tell you one honest thing I\'ve noticed about you?"—and listen to their reaction.',level:'Hard'},{emoji:'🪞',title:'Self Check',desc:'Ask: "Am I speaking truth with love, or am I just speaking?"—check your last 5 conversations.',level:'Medium'}],reflectPrompts:['How did speaking truth in love go?','What made it hard?','How are truth and love growing together in you?']}
  ]},
  {id:'prayer',emoji:'🙏',color:'path-prayer',title:'Prayer & Gratitude',desc:'Learn to talk with God—how to pray and why gratitude changes everything.',tier:'premium',lessons:[
    {id:'p1',title:'How to Pray',verseRef:'Matthew 6:9',excerpt:'"Pray like this: \'Our Father in heaven, may your name be kept holy. Let your Kingdom come.\'" — Matthew 6:9 (WEB)',summary:'Jesus gave his followers a simple prayer template—not a spell to recite, but a structure that covers everything we need.',questions:['What do you notice about how Jesus starts prayer—"Our Father"?','What does it mean to pray for God\'s Kingdom to come?','How can the Lord\'s Prayer shape your own prayer life?'],missions:[{emoji:'📿',title:'Lord\'s Prayer Week',desc:'Pray the Lord\'s Prayer every morning this week. Notice something new each day.',level:'Easy'},{emoji:'✍️',title:'Personal Prayer',desc:'Write your own prayer based on the Lord\'s Prayer structure.',level:'Medium'},{emoji:'🤲',title:'Pray Together',desc:'Lead your family in prayer one evening this week.',level:'Medium'}],reflectPrompts:['What did you notice new in the Lord\'s Prayer?','How did your own prayer grow?','What was hardest about leading prayer?']},
    {id:'p2',title:'God Hears You',verseRef:'Psalm 34:17',excerpt:'"The righteous cry, and Yahweh hears, and delivers them out of all their troubles." — Psalm 34:17 (WEB)',summary:'David wrote this from personal experience of deliverance. Prayer is not shouting into void—it connects to a God who listens.',questions:['Have you ever felt like your prayers weren\'t heard? What was that like?','Why do you think God sometimes seems silent even when we pray?','What would change if you truly believed God heard every prayer you prayed?'],missions:[{emoji:'📔',title:'Prayer Log',desc:'Keep a simple log of prayers and answers this week. Even small ones count.',level:'Easy'},{emoji:'🙏',title:'Persistent Prayer',desc:'Pick one prayer you\'ve given up on. Bring it back to God this week.',level:'Medium'},{emoji:'🎙️',title:'Pray Out Loud',desc:'Pray out loud once this week—alone or with family. Notice how it feels different.',level:'Medium'}],reflectPrompts:['What did you notice God doing this week?','Did you see any prayer answers?','How has your confidence in prayer changed?']},
    {id:'p3',title:'Gratitude Changes Your Brain',verseRef:'1 Thessalonians 5:18',excerpt:'"In everything give thanks, for this is the will of God in Christ Jesus toward you." — 1 Thessalonians 5:18 (WEB)',summary:'Science and scripture agree: gratitude rewires us toward joy. Paul\'s "give thanks in everything" is not naivety—it\'s a practiced discipline.',questions:['Is it possible to be grateful even in a hard situation? How?','What is something you often take for granted?','How could your family build a daily gratitude habit?'],missions:[{emoji:'📔',title:'Gratitude Journal',desc:'Write 3 specific things you\'re grateful for every day this week.',level:'Easy'},{emoji:'📞',title:'Gratitude Call',desc:'Call or text someone specifically to thank them for something.',level:'Easy'},{emoji:'🍽️',title:'Grateful Meals',desc:'Start every dinner with two minutes of sharing what you\'re grateful for.',level:'Easy'}],reflectPrompts:['What surprised you in your gratitude list?','How did gratitude change your mood or perspective?','What will you keep doing after this lesson?']},
    {id:'p4',title:'Praying for Others',verseRef:'James 5:16',excerpt:'"Confess your offenses to one another, and pray for one another, that you may be healed." — James 5:16 (WEB)',summary:'Intercession—praying for others—is one of the most powerful things Christians do for each other and for the world.',questions:['Who do you regularly pray for? Who should you add to that list?','Why might praying for someone change your feelings toward them?','How can your family become a praying family for your community?'],missions:[{emoji:'🗒️',title:'Prayer List',desc:'Make a prayer list of 7 people (one per day). Pray for each one specifically.',level:'Easy'},{emoji:'✉️',title:'Tell Someone',desc:'Tell one person you\'ve been praying for them. Watch their reaction.',level:'Medium'},{emoji:'🏘️',title:'Neighborhood Prayer',desc:'Walk around your neighborhood or school and pray silently for the people who live/work there.',level:'Medium'}],reflectPrompts:['How did praying for others change YOU?','Did anyone respond to knowing you prayed?','How has your circle of concern grown?']},
    {id:'p5',title:'Fasting & Focus',verseRef:'Matthew 6:17-18',excerpt:'"But when you fast, anoint your head, and wash your face; so that you are not seen by men to be fasting." — Matthew 6:17–18 (WEB)',summary:'Jesus assumed his followers would fast—not if, but when. A disciplined practice of going without something to focus on God.',questions:['What is fasting, and why would going without something help you focus on God?','What could you "fast" from this week that isn\'t food? (screens, negativity, social media)','How does denying ourselves small things build larger spiritual strength?'],missions:[{emoji:'📵',title:'Tech Fast',desc:'Fast from one digital thing (social media, games, TV) for one full day.',level:'Hard'},{emoji:'🍽️',title:'Meal Fast',desc:'Skip one meal this week. Use that time to pray instead of eat.',level:'Hard'},{emoji:'🤫',title:'Quiet Fast',desc:'Take 30 minutes of complete silence. No music, no talking, no screens. Just pray.',level:'Medium'}],reflectPrompts:['What did fasting teach you?','What was hardest to go without?','How did the focus time with God feel?']},
    {id:'p6',title:'When Prayer Feels Hard',verseRef:'Romans 8:26',excerpt:'"The Spirit also helps our weaknesses, for we don\'t know how to pray as we ought. But the Spirit himself makes intercession for us with groanings which can\'t be uttered." — Romans 8:26 (WEB)',summary:'When you don\'t know how to pray—when words fail—the Holy Spirit prays through you. You never pray alone.',questions:['Have you had seasons when prayer felt empty or hard? What caused it?','What does it mean that the Spirit prays when we can\'t find words?','What helps you reconnect with prayer when you\'ve drifted?'],missions:[{emoji:'🎵',title:'Musical Prayer',desc:'Listen to a worship song and let it be your prayer. Then sit in silence for 3 minutes.',level:'Easy'},{emoji:'🌅',title:'Nature Prayer',desc:'Go outside and pray out loud to creation—notice what you feel.',level:'Easy'},{emoji:'✍️',title:'Prayer Letter',desc:'Write a letter to God about everything you\'re feeling right now—no filters.',level:'Medium'}],reflectPrompts:['What helped your prayer feel more real this week?','Did the Spirit meet you in your weakness?','How is your prayer life different than a week ago?']},
    {id:'p7',title:'A Life of Prayer',verseRef:'1 Thessalonians 5:17',excerpt:'"Pray without ceasing." — 1 Thessalonians 5:17 (WEB)',summary:'Paul\'s shortest command is one of his biggest invitations—to make prayer not a task but a way of being.',questions:['What would "praying without ceasing" look like in a normal school or work day?','How can your family weave prayer into ordinary moments?','What one habit would most help you become a person of prayer?'],missions:[{emoji:'🔔',title:'Prayer Alarm',desc:'Set 3 alarms per day this week. Each time one goes off, pause for a 30-second prayer.',level:'Easy'},{emoji:'🚗',title:'Car Prayers',desc:'Turn every car ride this week into prayer time as a family.',level:'Easy'},{emoji:'🛏️',title:'Bookend Prayers',desc:'Pray first thing after waking and last thing before sleep for one full week.',level:'Medium'}],reflectPrompts:['How many prayers did you pray this week?','What changed about your ordinary moments?','How is prayer becoming part of who you are?']}
  ]}
];

const FAQS = [
  {q:'Is FaithQuest safe for children?',a:'Yes. Kids cannot access open AI chat. All AI interactions are structured within lesson flows, never request personal info, and have a built-in "Ask Parent" button. Parents have full visibility.'},
  {q:'What Bible version do you use?',a:'We primarily use the World English Bible (WEB) and King James Version (KJV), both public domain, ensuring completely free, legitimate use of Scripture.'},
  {q:'Can I try it before paying?',a:'Yes! The Free plan gives you full access to the first Learning Path (Jesus & Me, 7 lessons) and basic features forever. No credit card required.'},
  {q:'Is it denominationally specific?',a:'FaithQuest stays within mainstream Christian orthodoxy, celebrating what all Christians agree on. We avoid denomination-specific doctrines or contested theological positions.'},
  {q:'Can I use it offline?',a:'Yes. Lesson content and missions are available offline. AI features require a connection, but all core lesson material is cached locally.'},
  {q:'How many children can I add?',a:'Free plan: up to 2 profiles. Premium Family: unlimited members.'}
];

// ===================== STATE =====================
let state = {
  currentUser: null,
  family: null,
  members: [],
  completions: [],
  checkins: [],
  journals: [],
  subscription: {plan:'free'},
  selectedPath: null,
  selectedMember: null,
  onboardStep: 0,
  onboardData: {},
  parentTab: 'home',
  kidTab: 'home',
  lessonState: {path:null,lessonIndex:0,step:0,selectedMission:null,selectedEmoji:null,reflectText:''},
  checkinState: {mission:null,member:null},
};

const AVATARS = ['😊','🦁','🐯','🦊','🐻','🦋','🌟','🚀','🌈','🎯','🦅','🐘','🌺','⚡','🎪'];

// ===================== UTILS =====================
function showScreen(id){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  const el=document.getElementById(id);
  if(el){el.classList.add('active');el.scrollTop=0;}
  // Close mobile nav drawer when leaving landing
  if(id!=='screen-landing'){
    document.getElementById('lnavDrawer')?.classList.remove('open');
  }
}
function showToast(msg,dur=2500){
  const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),dur);
}
function openModal(id){document.getElementById(id).classList.add('open');}
function closeModal(id){document.getElementById(id).classList.remove('open');}
function getPath(id){return PATHS.find(p=>p.id===id);}
function getLesson(pathId,idx){const p=getPath(pathId);return p?p.lessons[idx]:null;}
function isLessonComplete(memberId,lessonId){return state.completions.some(c=>c.memberId===memberId&&c.lessonId===lessonId);}
function getCurrentMember(){return state.members.find(m=>m.id===state.selectedMember)||state.members[0];}

// ===================== LANDING =====================
function buildFAQ(){
  const el=document.getElementById('faqList');
  if(!el)return;
  el.innerHTML=FAQS.map((f,i)=>`
    <div class="faq-item">
      <div class="faq-question" onclick="toggleFaq(${i})">
        <span>${f.q}</span>
        <span id="faq-arrow-${i}">▾</span>
      </div>
      <div class="faq-answer" id="faq-ans-${i}">${f.a}</div>
    </div>`).join('');
}
function toggleFaq(i){
  const el=document.getElementById(`faq-ans-${i}`);
  el.classList.toggle('open');
}
function scrollToSection(id){
  const target=document.getElementById(id);
  if(!target)return;
  // Scroll within the landing screen container (which has overflow-y:auto)
  const container=document.getElementById('screen-landing');
  if(container){
    const offset=target.getBoundingClientRect().top - container.getBoundingClientRect().top + container.scrollTop;
    container.scrollTo({top:offset,behavior:'smooth'});
  } else {
    target.scrollIntoView({behavior:'smooth'});
  }
}
let billingYearly=false;
function toggleBilling(){
  billingYearly=!billingYearly;
  document.getElementById('billingToggle').classList.toggle('on',billingYearly);
  document.getElementById('premiumPrice').innerHTML=billingYearly?'<sup>$</sup>95.88':'<sup>$</sup>9.99';
  document.getElementById('premiumPeriod').textContent=billingYearly?'per year ($7.99/mo)':'per month';
}

// ===================== AUTH =====================
function gotoAuth(tab){
  showScreen('screen-auth');
  switchAuthTab(tab);
}
function togglePass(inputId,iconEl){
  const input=document.getElementById(inputId);
  if(!input)return;
  input.type=input.type==='password'?'text':'password';
  iconEl.textContent=input.type==='password'?'👁':'🙈';
}
function checkStrength(val){
  const bars=['sb1','sb2','sb3','sb4'];
  const len=val.length;
  let score=0;
  if(len>=6)score++;
  if(len>=10)score++;
  if(/[A-Z]/.test(val)||/[0-9]/.test(val))score++;
  if(/[^A-Za-z0-9]/.test(val))score++;
  const cls=score<=1?'weak':score<=2?'medium':'strong';
  bars.forEach((id,i)=>{
    const el=document.getElementById(id);
    if(el){el.className='auth-strength-bar '+(i<score?cls:'');}
  });
}
function switchAuthTab(tab){
  document.getElementById('auth-signin-form').classList.toggle('hidden',tab!=='signin');
  document.getElementById('auth-signup-form').classList.toggle('hidden',tab!=='signup');
}
// _fbReady is initialized in the bootstrap script above the module
function _fbGate(){ return window._fbReady || Promise.resolve(false); }

function showAuthError(msg){
  showToast(msg);
  var banner = document.getElementById('auth-error-banner');
  if(banner){ banner.textContent = '⚠️ ' + msg; banner.style.display = 'block'; }
}
function clearAuthError(){
  var banner = document.getElementById('auth-error-banner');
  if(banner) banner.style.display = 'none';
}

function doSignIn(){
  const email=document.getElementById('signin-email').value.trim();
  const pass=document.getElementById('signin-password').value;
  if(!email||!pass){showToast('Please enter email and password');return;}
  const btn=document.querySelector('#auth-signin-form .btn-primary');
  if(btn){btn.textContent='Signing in…';btn.disabled=true;}
  clearAuthError();

  _fbGate().then(function(configured){
    if(configured && window._fb?.signIn){
      window._fb.signIn(email,pass)
        .then(function(){/* onAuthStateChanged handles routing */})
        .catch(function(err){
          if(btn){btn.textContent='Sign In →';btn.disabled=false;}
          const msg={
            'auth/user-not-found':'No account found — create one below!',
            'auth/wrong-password':'Incorrect password.',
            'auth/invalid-email':'Please enter a valid email address.',
            'auth/too-many-requests':'Too many attempts. Try again later.',
            'auth/invalid-credential':'Email or password is incorrect.',
            'auth/network-request-failed':'Network error — check your connection.',
          }[err.code]||('Sign-in error: '+err.message);
          showAuthError(msg);
          console.error('[FQ] signIn error', err.code, err.message);
          if(err.code==='auth/user-not-found'){
            switchAuthTab('signup');
            document.getElementById('signup-email').value=email;
          }
        });
    } else {
      if(btn){btn.textContent='Sign In →';btn.disabled=false;}
      const saved=JSON.parse(localStorage.getItem('fq_users')||'[]');
      const user=saved.find(function(u){return u.email===email;});
      if(user){state.currentUser=user;loadUserData();routeAfterAuth();}
      if(btn){btn.textContent='Sign In →';btn.disabled=false;}
      else{showToast('No account found. Create one!');switchAuthTab('signup');document.getElementById('signup-email').value=email;}
    }
  });
}

function doSignUp(){
  const name=document.getElementById('signup-name').value.trim();
  const email=document.getElementById('signup-email').value.trim();
  const pass=document.getElementById('signup-password').value;
  if(!name){showToast('Please enter your name');return;}
  if(!email){showToast('Please enter your email');return;}
  if(!pass||pass.length<6){showToast('Password must be at least 6 characters');return;}
  const btn=document.querySelector('#auth-signup-form .btn-primary');
  if(btn){btn.textContent='Creating account…';btn.disabled=true;}
  clearAuthError();

  _fbGate().then(function(configured){
    if(configured && window._fb?.signUp){
      window._fb.signUp(email,pass,name)
        .then(function(){
          state.family=null;state.members=[];state.completions=[];
          state.checkins=[];state.subscription={plan:'free'};
        })
        .catch(function(err){
          if(btn){btn.textContent='Create Free Account →';btn.disabled=false;}
          const msg={
            'auth/email-already-in-use':'That email is already registered. Sign in instead.',
            'auth/invalid-email':'Please enter a valid email address.',
            'auth/weak-password':'Password must be at least 6 characters.',
            'auth/network-request-failed':'Network error — check your connection.',
          }[err.code]||('Sign-up error: '+err.message);
          showAuthError(msg);
          console.error('[FQ] signUp error', err.code, err.message);
          if(err.code==='auth/email-already-in-use') switchAuthTab('signin');
        });
    } else {
      if(btn){btn.textContent='Create Free Account →';btn.disabled=false;}
      const user={id:'u_'+Date.now(),name:name,email:email,createdAt:new Date().toISOString()};
      const saved=JSON.parse(localStorage.getItem('fq_users')||'[]');
      saved.push(user);
      localStorage.setItem('fq_users',JSON.stringify(saved));
      state.currentUser=user;state.family=null;state.members=[];
      state.completions=[];state.checkins=[];state.subscription={plan:'free'};
      startOnboarding();
    }
  });
}

function doGoogleSignIn(){
  _fbGate().then(function(configured){
    if(!configured||!window._fb?.googleSignIn){
      showToast('Google sign-in unavailable — try email/password');
      console.warn('[FQ] Google sign-in: Firebase not ready');
      return;
    }
    window._fb.googleSignIn()
      .catch(function(err){
        if(err.code==='auth/popup-blocked'){
          showToast('Popup blocked — allow popups for this site and try again');
        } else if(err.code==='auth/unauthorized-domain'){
          showToast('Add this domain to Firebase Console → Auth → Authorized Domains');
          console.error('[FQ] Unauthorized domain:', location.hostname);
        } else if(err.code!=='auth/popup-closed-by-user'){
          showToast('Google sign-in failed: '+err.message);
          console.error('[FQ] Google signIn error', err.code, err.message);
        }
      });
  });
}

function doForgotPassword(){
  const email=document.getElementById('signin-email').value.trim();
  if(!email){showToast('Enter your email address first');return;}
  _fbGate().then(function(configured){
    if(!configured||!window._fb?.resetPw){showToast('Password reset requires Firebase');return;}
    window._fb.resetPw(email)
      .then(function(){showToast('Password reset email sent! Check your inbox 📧');})
      .catch(function(err){
        const msg={'auth/user-not-found':'No account with that email.','auth/invalid-email':'Enter a valid email.'}[err.code]||'Failed to send reset email.';
        showToast(msg);
      });
  });
}

function doSignOut(){
  _fbGate().then(function(configured){
    if(configured&&window._fb?.signOut){
      window._fb.signOut().then(function(){
        state.currentUser=null;state.family=null;state.members=[];
        state.completions=[];state.checkins=[];
        showScreen('screen-landing');showToast('Signed out');
      });
    } else {
      state.currentUser=null;state.family=null;state.members=[];
      showScreen('screen-landing');showToast('Signed out');
    }
  });
}

function loadUserData(){
  // Demo mode only — Firebase uses _fbLoadUserData in module
  const data=JSON.parse(localStorage.getItem('fq_data_'+state.currentUser?.id)||'null');
  if(data){
    state.family=data.family||null;
    state.members=data.members||[];
    state.completions=data.completions||[];
    state.checkins=data.checkins||[];
    state.journals=data.journals||[];
    state.subscription=data.subscription||{plan:'free'};
    state.selectedPath=data.selectedPath||'jesus';
    state.selectedMember=data.selectedMember||null;
  }
}

function saveUserData(){
  if(!state.currentUser)return;
  const payload={
    family:state.family,members:state.members,completions:state.completions,
    checkins:state.checkins,journals:state.journals||[],subscription:state.subscription,
    selectedPath:state.selectedPath,selectedMember:state.selectedMember,
  };
  // Always write localStorage as offline cache
  localStorage.setItem('fq_data_'+state.currentUser.id,JSON.stringify(payload));
  // Also write to Firestore if configured
  if(window._fb?.configured) window._fb.save();
}

function routeAfterAuth(){
  if(!state.family){ startOnboarding(); }
  else {
    const parent = state.members.find(m => m.role === 'parent');
    if(parent){ showParentApp(); } else { showKidApp(); }
  }
}

// ===================== ONBOARDING =====================
const ONBOARD_STEPS=['family','member','avatar','path','launch'];

const OB_META={
  family:{bg:'ob-bg-family',icon:'👨‍👩‍👧‍👦',step:'Step 1 of 5',label:'Your Family',title:'Name your family',sub:'This is how you will appear throughout FaithQuest.',cta:'Continue →',skipable:false},
  member:{bg:'ob-bg-child',icon:'🧒',step:'Step 2 of 5',label:'First Child',title:'Tell us about your child',sub:'We tailor every lesson to their age and stage.',cta:'Continue →',skipable:false},
  avatar:{bg:'ob-bg-avatar',icon:'🎨',step:'Step 3 of 5',label:'Choose an Avatar',title:'Pick an avatar',sub:'Your child will see this every day on their home screen.',cta:'Looks good →',skipable:true},
  path:{bg:'ob-bg-path',icon:'📚',step:'Step 4 of 5',label:'Learning Path',title:'Choose your first path',sub:'Start with one and switch any time from your dashboard.',cta:'Choose this path →',skipable:false},
  launch:{bg:'ob-bg-launch',icon:'🎉',step:'Step 5 of 5',label:'All Set',title:'Your quest begins now',sub:'Everything is ready. Your family journey starts here.',cta:'Enter FaithQuest 🚀',skipable:false},
};

function startOnboarding(){
  state.onboardStep=0;
  state.onboardData={avatar:'😊',tier:'kid',selectedPath:'jesus'};
  showScreen('screen-onboarding');
  renderOnboardStep();
}

function renderOnboardStep(){
  const stepName=ONBOARD_STEPS[state.onboardStep];
  const meta=OB_META[stepName];
  const idx=state.onboardStep;

  // ── Rail segments ──
  document.getElementById('obSegBar').innerHTML=
    ONBOARD_STEPS.map((_,i)=>`<div class="ob-rail-seg${i<idx?' done':i===idx?' active':''}"></div>`).join('');

  // ── Skip button ──
  document.getElementById('obSkip').style.display=meta.skipable?'block':'none';

  // ── Illustration card ──
  const hero=document.getElementById('obHero');
  hero.className='ob-card-bg '+meta.bg;
  document.getElementById('obHeroText').innerHTML=`
    <div class="ob-card-step-label"><span class="ob-card-step-dot"></span>${meta.step} · ${meta.label}</div>
    <span class="ob-card-icon">${meta.icon}</span>
    <div class="ob-card-title">${meta.title}</div>
    <p class="ob-card-sub">${meta.sub}</p>`;

  // ── CTA label ──
  document.getElementById('onboardNext').textContent=meta.cta;

  // ── Body with slide animation ──
  const body=document.getElementById('obBody');
  body.classList.remove('ob-slide');
  void body.offsetWidth;
  body.classList.add('ob-slide');

  const noteEl=document.getElementById('obFooterNote');

  if(stepName==='family'){
    body.innerHTML=`
      <label class="ob-field-label">Family name</label>
      <input class="ob-input" id="ob-family-name" type="text" placeholder="The Johnson Family" value="${state.onboardData.familyName||''}" autocomplete="off">
      <label class="ob-field-label">Your first name (parent)</label>
      <input class="ob-input" id="ob-parent-name" type="text" placeholder="Your name" value="${state.onboardData.parentName||state.currentUser?.name||''}" autocomplete="off">`;
    noteEl.textContent='You can edit these any time in Family Settings.';

  } else if(stepName==='member'){
    const tiers=[
      {id:'younger',icon:'🌱',name:'Little Explorer',range:'Ages 4–6',desc:'Simplified words, bright visuals, short 5-min lessons.'},
      {id:'kid',    icon:'⭐',name:'Kid',            range:'Ages 6–10',desc:'Clear explanations, fun questions, real-world missions.'},
      {id:'teen',   icon:'🚀',name:'Teen',           range:'Ages 11–17',desc:'Deeper dives, journaling prompts, theological context.'},
    ];
    body.innerHTML=`
      <label class="ob-field-label">Child's first name</label>
      <input class="ob-input" id="ob-kid-name" type="text" placeholder="e.g. Emma" value="${state.onboardData.kidName||''}" autocomplete="off">
      <label class="ob-field-label" style="margin-bottom:10px;">Age group</label>
      <div class="age-tier-grid">
        ${tiers.map(t=>`
          <div class="age-tier-card${state.onboardData.tier===t.id?' selected':''}" onclick="selectTier('${t.id}')">
            <div class="age-tier-visual">${t.icon}</div>
            <div class="age-tier-info">
              <div class="age-tier-name">${t.name}<span class="age-tier-range">${t.range}</span></div>
              <div class="age-tier-desc">${t.desc}</div>
            </div>
            <div class="age-tier-check">${state.onboardData.tier===t.id?'✓':''}</div>
          </div>`).join('')}
      </div>`;
    noteEl.textContent='You can add more children after setup.';

  } else if(stepName==='avatar'){
    body.innerHTML=`
      <div class="ob-avatar-preview" id="obAvatarPreview">${state.onboardData.avatar}</div>
      <div class="avatar-grid">
        ${AVATARS.map(a=>`<div class="avatar-option${state.onboardData.avatar===a?' selected':''}" onclick="selectObAvatar('${a}')">${a}</div>`).join('')}
      </div>`;
    noteEl.textContent='You can change this later in your profile.';

  } else if(stepName==='path'){
    const swatchMap={jesus:'sw-jesus',fruit:'sw-fruit',courage:'sw-courage',words:'sw-words',prayer:'sw-prayer'};
    const descMap={
      jesus:'Who Jesus is — stories, miracles, and everyday faith.',
      fruit:'Love, joy, peace, patience — growing lasting character.',
      courage:'Biblical tools for anxiety, fear, and hard situations.',
      words:'Honesty, kindness in speech, and the power of words.',
      prayer:'How to pray, why it matters, and a life of gratitude.',
    };
    const isFree=state.subscription.plan==='free';
    body.innerHTML=`
      <div class="ob-path-list">
        ${PATHS.map(p=>{
          const locked=isFree&&p.id!=='jesus';
          return `<div class="ob-path-row${state.onboardData.selectedPath===p.id?' selected':''}${locked?' locked':''}" onclick="selectObPath('${p.id}')">
            <div class="ob-path-swatch ${swatchMap[p.id]||''}">${p.emoji}</div>
            <div class="ob-path-body">
              <div class="ob-path-title">${p.title}${locked?' 🔒':''}</div>
              <div class="ob-path-meta">${descMap[p.id]||''} &middot; ${p.lessons?.length||7} lessons</div>
            </div>
            <div class="ob-path-check">${state.onboardData.selectedPath===p.id&&!locked?'✓':''}</div>
          </div>`;
        }).join('')}
      </div>`;
    noteEl.innerHTML=isFree?'Free plan includes <strong>Jesus &amp; Me</strong>. <span style="color:var(--amber-dark);cursor:pointer;font-weight:600;" onclick="upgradePlan()">Upgrade for all 5 →</span>':'All 5 paths included in your Premium plan. ✓';

  } else if(stepName==='launch'){
    const path=PATHS.find(p=>p.id===state.onboardData.selectedPath);
    body.innerHTML=`
      <div class="ob-confirm-card">
        <div class="ob-confirm-avatar-ring">${state.onboardData.avatar}</div>
        <div class="ob-confirm-name">${state.onboardData.kidName||'Your Child'}</div>
        <div class="ob-confirm-sub">${state.onboardData.tier==='teen'?'Teen':'Kid'} &middot; ${state.onboardData.familyName||'Your Family'}</div>
        <div class="ob-confirm-row">
          <span class="ob-confirm-row-icon">📚</span>
          <div class="ob-confirm-row-text">Starting path: <strong>${path?.title}</strong> &mdash; ${path?.lessons?.length||7} lessons ready</div>
        </div>
        <div class="ob-confirm-row">
          <span class="ob-confirm-row-icon">🔒</span>
          <div class="ob-confirm-row-text"><strong>Kid-safe AI</strong> &mdash; all content reviewed, no open chat</div>
        </div>
        <div class="ob-confirm-row">
          <span class="ob-confirm-row-icon">✅</span>
          <div class="ob-confirm-row-text"><strong>Parent approval</strong> required for every mission submission</div>
        </div>
      </div>`;
    noteEl.textContent='You can add more children and change paths at any time.';
  }
}

function selectTier(t){
  state.onboardData.tier=t;
  // In-place DOM update — no full re-render
  document.querySelectorAll('.age-tier-card').forEach(el=>{
    const id=el.getAttribute('onclick')?.match(/'(\w+)'/)?.[1];
    el.classList.toggle('selected',id===t);
    const chk=el.querySelector('.age-tier-check');
    if(chk)chk.textContent=id===t?'✓':'';
    const vis=el.querySelector('.age-tier-visual');
    if(vis)vis.style.background=id===t?'#FEF3C7':'var(--slate-100)';
  });
}
function selectObAvatar(a){
  state.onboardData.avatar=a;
  const prev=document.getElementById('obAvatarPreview');
  if(prev){prev.style.transform='scale(1.25)';prev.textContent=a;setTimeout(()=>prev.style.transform='',220);}
  document.querySelectorAll('.avatar-option').forEach(el=>el.classList.toggle('selected',el.textContent===a));
}
function selectObPath(id){
  if(state.subscription.plan==='free'&&id!=='jesus'){showToast('Upgrade to Premium for all paths');return;}
  state.onboardData.selectedPath=id;
  document.querySelectorAll('.ob-path-row').forEach((el,i)=>{
    const pid=PATHS[i]?.id;
    el.classList.toggle('selected',pid===id);
    const chk=el.querySelector('.ob-path-check');
    if(chk)chk.textContent=pid===id?'✓':'';
  });
  document.getElementById('onboardNext').textContent=OB_META.path.cta;
}

function onboardSkip(){
  state.onboardStep++;
  renderOnboardStep();
}
function onboardNextStep(){
  const step=ONBOARD_STEPS[state.onboardStep];
  if(step==='family'){
    const fn=document.getElementById('ob-family-name')?.value.trim();
    const pn=document.getElementById('ob-parent-name')?.value.trim();
    if(!fn){showToast('Please enter a family name');return;}
    state.onboardData.familyName=fn;
    state.onboardData.parentName=pn||state.currentUser?.name||'Parent';
  } else if(step==='member'){
    const kn=document.getElementById('ob-kid-name')?.value.trim();
    if(!kn){showToast("Please enter your child's name");return;}
    state.onboardData.kidName=kn;
  } else if(step==='launch'){
    finalizeOnboarding();return;
  }
  state.onboardStep++;
  renderOnboardStep();
}
function onboardBack(){
  if(state.onboardStep===0){showScreen('screen-landing');}
  else{state.onboardStep--;renderOnboardStep();}
}
function finalizeOnboarding(){
  state.family={id:'fam_'+Date.now(),name:state.onboardData.familyName};
  const parent={id:'m_parent',name:state.onboardData.parentName,role:'parent',avatar:'👤',tier:'parent'};
  const kid={id:'m_'+Date.now(),name:state.onboardData.kidName,role:state.onboardData.tier==='teen'?'teen':'kid',avatar:state.onboardData.avatar,tier:state.onboardData.tier};
  state.members=[parent,kid];
  state.selectedPath=state.onboardData.selectedPath;
  state.selectedMember=kid.id;
  saveUserData();
  showParentApp();
  setTimeout(()=>showTour(),500);
}

// ===================== TOUR =====================
const TOUR_STEPS=[
  {icon:'🏠',title:'Welcome to FaithQuest!',text:'This is the Parent Dashboard. You can see your family\'s progress, manage profiles, and track missions from here.'},
  {icon:'📚',title:'Browse Learning Paths',text:'Head to Paths to explore 35 lessons across 5 journeys. Assign paths to your kids and track their progress.'},
  {icon:'🚀',title:'Kid\'s Daily Lesson',text:'Switch to your child\'s view to see today\'s lesson. It takes 7–10 minutes and flows through 6 engaging steps.'},
  {icon:'✅',title:'Mission Approvals',text:'After your child submits a Faith-in-Action mission, you will get a notification to review and approve it here.'},
  {icon:'📊',title:'Insights Dashboard',text:'Track kindness, honesty, service, and prayer across your whole family. See who\'s streaking and who needs encouragement.'}
];
let tourStep=0;
function showTour(){
  tourStep=0;renderTourStep();openModal('modal-tour');
}
function renderTourStep(){
  const s=TOUR_STEPS[tourStep];
  document.getElementById('tourContent').innerHTML=`
    <div class="tour-step-icon">${s.icon}</div>
    <div class="tour-step-title">${s.title}</div>
    <p class="tour-step-text">${s.text}</p>
    <div class="tour-dots">${TOUR_STEPS.map((_,i)=>`<div class="tour-dot${i===tourStep?' active':''}"></div>`).join('')}</div>
    <div style="display:flex;gap:12px;margin-top:8px;">
      ${tourStep>0?`<button class="btn btn-secondary" style="flex:1;background:rgba(255,255,255,0.1);color:white;border-color:rgba(255,255,255,0.2);" onclick="tourPrev()">← Back</button>`:''}
      <button class="btn btn-primary" style="flex:1;" onclick="tourNext()">${tourStep===TOUR_STEPS.length-1?'Start Exploring!':'Next →'}</button>
    </div>`;
}
function tourNext(){if(tourStep<TOUR_STEPS.length-1){tourStep++;renderTourStep();}else{closeModal('modal-tour');}}
function tourPrev(){if(tourStep>0){tourStep--;renderTourStep();}}

// ===================== PARENT APP =====================
function showParentApp(){
  document.getElementById('planBadge').textContent=state.subscription.plan==='free'?'Free':'Premium';
  renderParentKidSwitcher();
  showScreen('screen-parent');
  parentNav('home');
}
function renderParentKidSwitcher(){
  const el=document.getElementById('parentKidSwitcher');
  if(!el)return;
  const kids=state.members.filter(m=>m.role!=='parent');
  if(kids.length===0){el.style.display='none';return;}
  el.style.display='flex';
  el.innerHTML=kids.map(k=>`
    <button class="kid-switcher-pill${state.selectedMember===k.id?' active':''}" onclick="switchToKid('${k.id}')">
      <span class="kid-switcher-avatar">${k.avatar}</span>${k.name.split(' ')[0]}
    </button>`).join('');
}
function parentNav(tab){
  state.parentTab=tab;
  document.querySelectorAll('[id^="pnav-"]').forEach(el=>el.classList.remove('active'));
  const btn=document.getElementById(`pnav-${tab}`);
  if(btn)btn.classList.add('active');
  const el=document.getElementById('parentContent');
  el.innerHTML='';
  if(tab==='home')renderParentHome(el);
  else if(tab==='family')renderParentFamily(el);
  else if(tab==='paths')renderParentPaths(el);
  else if(tab==='approvals')renderParentApprovals(el);
  else if(tab==='insights')renderParentInsights(el);
}
function renderParentHome(el){
  const kids=state.members.filter(m=>m.role!=='parent');
  const parent=state.members.find(m=>m.role==='parent');
  const totalLessons=state.completions.length;
  const pendingCount=state.checkins.filter(c=>!c.approved).length;
  const approvedMissions=state.checkins.filter(c=>c.approved).length;
  const familyStreak=kids.length?Math.max(...kids.map(k=>getStreak(k.id)),0):0;
  const today=new Date().toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric'});
  el.innerHTML=`
    <div class="pd-hero">
      <div class="pd-hero-glow"></div>
      <div class="pd-hero-content">
        <div class="pd-hero-greeting">Parent Dashboard</div>
        <div class="pd-hero-name">Welcome back, ${parent?.name||'Parent'} 👋</div>
        <div class="pd-hero-date">${state.family?.name||'Your Family'} &middot; ${today}</div>
        <div class="pd-kpi-row">
          <div class="pd-kpi highlight">
            <span class="pd-kpi-val">🔥 ${familyStreak}</span>
            <span class="pd-kpi-lbl">Streak</span>
          </div>
          <div class="pd-kpi">
            <span class="pd-kpi-val">${totalLessons}</span>
            <span class="pd-kpi-lbl">Lessons</span>
          </div>
          <div class="pd-kpi${pendingCount>0?' highlight':''}">
            <span class="pd-kpi-val">${pendingCount}</span>
            <span class="pd-kpi-lbl">Pending</span>
          </div>
        </div>
      </div>
    </div>
    <div class="pd-body">
      <div style="display:flex;gap:8px;margin:4px 0 8px;">
        <button class="btn btn-primary btn-sm" style="flex:1;border-radius:12px;" onclick="switchToKid('${state.selectedMember||kids[0]?.id}')">Open Kid View →</button>
        ${pendingCount>0?`<button class="btn btn-secondary btn-sm" style="position:relative;border-radius:12px;" onclick="parentNav('approvals')">Approvals<span style="position:absolute;top:-5px;right:-5px;background:var(--rose);color:white;border-radius:50%;width:18px;height:18px;font-size:0.6rem;display:flex;align-items:center;justify-content:center;font-weight:700;">${pendingCount}</span></button>`:''}
      </div>
      <div class="pd-section-hd">
        <span class="pd-section-title">Family Members</span>
        <button class="pd-section-action" onclick="parentNav('family')">Manage →</button>
      </div>
      <div class="pd-members">
        ${kids.map(k=>{
          const done=state.completions.filter(c=>c.memberId===k.id).length;
          const pct=Math.min(100,Math.round((done/35)*100));
          const streak=getStreak(k.id);
          const missions=state.checkins.filter(c=>c.memberId===k.id&&c.approved).length;
          const isActive=state.selectedMember===k.id;
          return `<div class="pd-member-card${isActive?' active-member':''}" onclick="switchToKid('${k.id}')">
            <div class="pd-member-avatar" style="background:${isActive?'var(--amber-light)':'var(--slate-100)'};">${k.avatar}</div>
            <div class="pd-member-info">
              <div class="pd-member-name">${k.name}${isActive?'<span style="font-size:0.62rem;background:var(--amber);color:white;padding:2px 7px;border-radius:100px;font-weight:700;margin-left:6px;">Active</span>':''}</div>
              <div class="pd-member-meta">${k.tier==='teen'?'Teen':'Kid'}</div>
              <div class="pd-member-stats">
                <span class="pd-member-stat-pill">🔥 ${streak}</span>
                <span class="pd-member-stat-pill">📖 ${done}</span>
                <span class="pd-member-stat-pill">🎯 ${missions}</span>
              </div>
              <div class="pd-member-progress">
                <div class="pd-member-prog-bar"><div class="pd-member-prog-fill" style="width:${pct}%"></div></div>
                <div class="pd-member-prog-label">${done} of 35 lessons &middot; ${pct}%</div>
              </div>
            </div>
          </div>`;
        }).join('')}
        <button class="btn btn-secondary btn-full" onclick="openAddMember()" style="border-radius:14px;margin-top:2px;">+ Add Family Member</button>
      </div>
      ${pendingCount>0?`
      <div class="pd-section-hd">
        <span class="pd-section-title">Needs Review<span style="background:var(--rose);color:white;font-size:0.65rem;padding:2px 8px;border-radius:100px;margin-left:8px;">${pendingCount}</span></span>
        <button class="pd-section-action" onclick="parentNav('approvals')">All →</button>
      </div>
      ${state.checkins.filter(c=>!c.approved).slice(0,2).map(c=>{
        const member=state.members.find(m=>m.id===c.memberId);
        return `<div class="pd-approval">
          <div class="pd-approval-top">
            <div class="pd-approval-avatar">${member?.avatar||'🧒'}</div>
            <div class="pd-approval-meta">
              <div class="pd-approval-who">${member?.name}</div>
              <div class="pd-approval-mission">📌 ${c.missionTitle}</div>
            </div>
          </div>
          ${c.reflection?`<div class="pd-approval-reflection">"${c.reflection.slice(0,100)}${c.reflection.length>100?'...':''}"</div>`:''}
          <div class="pd-approval-actions">
            <button class="btn btn-secondary btn-sm" onclick="rejectCheckin('${c.id}')">Decline</button>
            <button class="btn btn-emerald btn-sm" style="flex:1;" onclick="approveCheckin('${c.id}')">✓ Approve</button>
          </div>
        </div>`;
      }).join('')}`:''}
      <div class="pd-section-hd">
        <span class="pd-section-title">Insights</span>
        <button class="pd-section-action" onclick="parentNav('insights')">Full report →</button>
      </div>
      <div class="pd-insights-kpi">
        <div class="pd-ins-card"><span class="pd-ins-icon">📖</span><span class="pd-ins-val">${totalLessons}</span><span class="pd-ins-lbl">Lessons done</span></div>
        <div class="pd-ins-card"><span class="pd-ins-icon">🎯</span><span class="pd-ins-val">${approvedMissions}</span><span class="pd-ins-lbl">Missions done</span></div>
        <div class="pd-ins-card"><span class="pd-ins-icon">🔥</span><span class="pd-ins-val">${familyStreak}</span><span class="pd-ins-lbl">Best streak</span></div>
        <div class="pd-ins-card"><span class="pd-ins-icon">👨‍👩‍👧</span><span class="pd-ins-val">${kids.length}</span><span class="pd-ins-lbl">Members</span></div>
      </div>
    </div>`;
}

function renderParentFamily(el){
  const kids=state.members.filter(m=>m.role!=='parent');
  const parent=state.members.find(m=>m.role==='parent');
  el.innerHTML=`
    <div class="pd-body">
      <div class="pd-section-hd" style="margin-top:8px;"><span class="pd-section-title">Family Members</span></div>
      <div class="pd-members">
        ${parent?`<div class="pd-member-card">
          <div class="pd-member-avatar" style="background:var(--sky-light);">${parent.avatar||'👤'}</div>
          <div class="pd-member-info">
            <div class="pd-member-name">${parent.name}<span style="font-size:0.62rem;background:var(--sky);color:white;padding:2px 7px;border-radius:100px;font-weight:700;margin-left:6px;">Parent</span></div>
            <div class="pd-member-meta">Admin &middot; Manages all profiles</div>
          </div>
        </div>`:''}
        ${kids.map(k=>{
          const done=state.completions.filter(c=>c.memberId===k.id).length;
          const pct=Math.min(100,Math.round((done/35)*100));
          return `<div class="pd-member-card${state.selectedMember===k.id?' active-member':''}" onclick="switchToKid('${k.id}')">
            <div class="pd-member-avatar" style="background:var(--amber-light);">${k.avatar}</div>
            <div class="pd-member-info">
              <div class="pd-member-name">${k.name}</div>
              <div class="pd-member-meta">${k.tier==='teen'?'Teen':'Kid'} &middot; ${done} lessons</div>
              <div class="pd-member-progress">
                <div class="pd-member-prog-bar"><div class="pd-member-prog-fill" style="width:${pct}%"></div></div>
                <div class="pd-member-prog-label">${pct}% of all lessons complete</div>
              </div>
            </div>
            <div class="pd-member-action"><button class="btn btn-sky btn-sm" onclick="event.stopPropagation();switchToKid('${k.id}')">View →</button></div>
          </div>`;
        }).join('')}
      </div>
      <button class="btn btn-primary btn-full" onclick="openAddMember()" style="border-radius:14px;">+ Add Child or Teen</button>
      <div class="pd-section-hd" style="margin-top:28px;"><span class="pd-section-title">Subscription</span></div>
      <div class="pd-plan-hero">
        <div class="pd-plan-label">Current Plan</div>
        <div class="pd-plan-name">${state.subscription.plan==='free'?'Free Plan':'Premium Family'}</div>
        <div class="pd-plan-desc">${state.subscription.plan==='free'?'1 learning path &middot; Up to 2 members':'All 5 paths &middot; Unlimited members &middot; Full insights'}</div>
      </div>
      ${state.subscription.plan==='free'?`
        <div class="pd-upgrade-card">
          <div style="font-weight:700;font-size:1rem;color:var(--slate-900);margin-bottom:6px;">Unlock Everything — $9.99/mo</div>
          <p style="font-size:0.825rem;color:var(--slate-600);margin-bottom:16px;line-height:1.6;">All 5 paths &middot; Unlimited members &middot; Full insights &middot; Teen journaling &middot; Priority support</p>
          <button class="btn btn-primary btn-full" onclick="upgradePlan()">Upgrade to Premium →</button>
        </div>`:`<button class="btn btn-ghost btn-sm" onclick="downgradePlan()" style="color:var(--slate-400);">Downgrade to Free</button>`}
    </div>`;
}

function renderParentPaths(el){
  const swatchColors={jesus:'linear-gradient(160deg,#1E3A5F,#0F3460)',fruit:'linear-gradient(160deg,#065F46,#059669)',courage:'linear-gradient(160deg,#7C3AED,#6D28D9)',words:'linear-gradient(160deg,#B45309,#D97706)',prayer:'linear-gradient(160deg,#0369A1,#0284C7)'};
  const pathDescs={jesus:'Who Jesus is — stories, miracles, and everyday faith.',fruit:'Love, joy, peace, patience — lasting character.',courage:'Biblical tools for fear, anxiety, and hard situations.',words:'Honesty, kindness in speech, and the power of words.',prayer:'How to pray, why it matters, and a life of gratitude.'};
  el.innerHTML=`
    <div class="pd-body">
      <div class="pd-section-hd" style="margin-top:8px;"><span class="pd-section-title">Learning Paths</span></div>
      <p style="font-size:0.825rem;color:var(--slate-500);margin-bottom:16px;line-height:1.5;">Choose your active path. You can switch any time.</p>
      ${PATHS.map(p=>{
        const locked=p.tier==='premium'&&state.subscription.plan==='free';
        const isActive=state.selectedPath===p.id;
        return `<div class="pd-path-card${isActive?' active-path':''}" onclick="${locked?"showToast('Upgrade to Premium for this path')":`selectFamilyPath('${p.id}')`}">
          <div class="pd-path-swatch" style="background:${swatchColors[p.id]||'#1E293B'};">${p.emoji}</div>
          <div style="flex:1;">
            <div class="pd-path-body">
              <div class="pd-path-title">${p.title}${locked?' 🔒':''} ${isActive?'<span style="font-size:0.62rem;background:var(--amber);color:white;padding:2px 8px;border-radius:100px;font-weight:700;">Active</span>':''}</div>
              <div class="pd-path-desc">${pathDescs[p.id]||p.desc}</div>
            </div>
            <div class="pd-path-footer">
              <span class="pd-path-badge">${p.lessons?.length||7} lessons</span>
              ${locked?'<span style="font-size:0.72rem;color:var(--amber-dark);font-weight:700;">Premium only</span>':'<span style="color:var(--amber-dark);">→</span>'}
            </div>
          </div>
        </div>`;
      }).join('')}
    </div>`;
}

function selectFamilyPath(id){
  state.selectedPath=id;saveUserData();
  showToast('Path selected: '+getPath(id)?.title);
  renderParentPaths(document.getElementById('parentContent'));
}

function renderParentApprovals(el){
  const pending = state.checkins.filter(c=>!c.approved);
  const approved = state.checkins.filter(c=>c.approved)
    .sort((a,b)=>new Date(b.approvedAt||b.createdAt)-new Date(a.approvedAt||a.createdAt));
  const thisWeek = approved.filter(c=>(Date.now()-new Date(c.approvedAt||c.createdAt))<7*24*60*60*1000).length;

  el.innerHTML = `
    <div class="ap-hero">
      <div class="ap-hero-grid"></div>
      <div class="ap-hero-glow"></div>
      <div class="ap-hero-content">
        <div class="ap-hero-top">
          <div class="ap-hero-icon">✅</div>
          <div>
            <div class="ap-hero-title">Mission Approvals</div>
            <div class="ap-hero-sub">${pending.length>0?`${pending.length} waiting for your review`:'All caught up!'}</div>
          </div>
        </div>
        <div class="ap-stats">
          <div class="ap-stat"><span class="ap-stat-val">${pending.length}</span><span class="ap-stat-lbl">Pending</span></div>
          <div class="ap-stat"><span class="ap-stat-val">${approved.length}</span><span class="ap-stat-lbl">Approved</span></div>
          <div class="ap-stat"><span class="ap-stat-val">${thisWeek}</span><span class="ap-stat-lbl">This Week</span></div>
        </div>
      </div>
    </div>
    <div class="ap-body">
      ${pending.length>0 ? `
        <div class="ap-section-hd">
          <span class="ap-section-title">Needs Your Review</span>
          <span class="ap-section-count">${pending.length} pending</span>
        </div>
        ${pending.map((c,i)=>{
          const member = state.members.find(m=>m.id===c.memberId);
          const date = new Date(c.createdAt).toLocaleDateString('en-US',{month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'});
          const praiseId = 'praise_'+c.id;
          return `
            <div class="ap-card" style="--i:${i}">
              <div class="ap-card-banner">
                <div class="ap-card-avatar">${member?.avatar||'🧒'}</div>
                <div>
                  <div class="ap-card-who">${member?.name||'Your child'}</div>
                  <div class="ap-card-mission">📌 ${c.missionTitle||'Mission'}</div>
                </div>
                ${c.emoji?`<div class="ap-card-mood">${c.emoji}</div>`:''}
              </div>
              <div class="ap-card-body">
                <div class="ap-card-date">Submitted ${date}</div>
                ${c.reflection?`<div class="ap-card-reflection">"${c.reflection}"</div>`:'<div class="ap-card-reflection" style="color:var(--slate-400);font-style:normal;">No reflection written.</div>'}
                <div class="ap-praise-row">
                  <div class="ap-praise-label">Your response (optional)</div>
                  <input class="ap-praise-input" id="${praiseId}" placeholder="Great job! I am so proud of you..." maxlength="120">
                  <div class="ap-praise-suggestions">
                    ${["Amazing work! 🌟","So proud of you!","That took real courage","God is pleased with you!","Keep it up! 🙏"].map(s=>
                      `<div class="ap-praise-chip" onclick="document.getElementById('${praiseId}').value='${s}'">${s}</div>`
                    ).join('')}
                  </div>
                </div>
                <div class="ap-card-actions">
                  <button class="ap-decline-btn" onclick="rejectCheckin('${c.id}')">Decline</button>
                  <button class="ap-approve-btn" onclick="approveCheckin('${c.id}','${praiseId}')">Approve Mission</button>
                </div>
              </div>
            </div>`;
        }).join('')}` : `
        <div class="ap-empty">
          <div style="font-size:3rem;margin-bottom:14px;">🎉</div>
          <div style="font-weight:800;font-size:1.05rem;color:var(--slate-700);margin-bottom:6px;">All caught up!</div>
          <div style="font-size:0.85rem;color:var(--slate-400);line-height:1.6;">No pending missions right now. When your kids complete missions and check in, they will appear here.</div>
        </div>`}
      ${approved.length>0 ? `
        <div class="ap-section-hd" style="margin-top:28px;">
          <span class="ap-section-title">Approval History</span>
          <span class="ap-section-count">${approved.length} total</span>
        </div>
        ${approved.slice(0,8).map(c=>{
          const m = state.members.find(x=>x.id===c.memberId);
          const d = new Date(c.approvedAt||c.createdAt).toLocaleDateString('en-US',{month:'short',day:'numeric'});
          return `
            <div class="ap-history">
              <div class="ap-history-check">+</div>
              <div class="ap-history-info">
                <div class="ap-history-name">${m?.name||'Child'} - ${c.missionTitle||'Mission'}</div>
                <div class="ap-history-meta">Approved ${d}${c.emoji?' - '+c.emoji:''}</div>
                ${c.praise?`<div class="ap-history-praise">"${c.praise}"</div>`:''}
              </div>
            </div>`;
        }).join('')}` : ''}
    </div>`;
}

function approveCheckin(id, praiseInputId){
  const c = state.checkins.find(x=>x.id===id);
  if(!c) return;
  c.approved = true;
  c.approvedAt = new Date().toISOString();
  c.praise = praiseInputId ? (document.getElementById(praiseInputId)?.value.trim()||null) : null;
  saveUserData();
  showToast('Mission approved! 🌟');
  parentNav('approvals');
}
function rejectCheckin(id){
  state.checkins = state.checkins.filter(x=>x.id!==id);
  saveUserData();
  showToast('Mission declined');
  parentNav('approvals');
}

function renderParentInsights(el){
  const kids=state.members.filter(m=>m.role!=='parent');
  const total=state.completions.length;
  const missions=state.checkins.filter(c=>c.approved).length;
  const familyStreak=kids.length?Math.max(...kids.map(k=>getStreak(k.id)),0):0;
  const heatData=Array.from({length:28},(_,i)=>{
    const v=(total*7+i*13)%10;
    return v<4?0:v<6?1:v<8?2:v<9?3:4;
  });
  const charData=[
    {label:'Kindness',icon:'💛',color:'#F59E0B',val:Math.min(95,20+(total*7)%60)},
    {label:'Honesty',icon:'✅',color:'#10B981',val:Math.min(95,30+(total*11)%55)},
    {label:'Service',icon:'🤲',color:'#0EA5E9',val:Math.min(95,25+(total*9)%50)},
    {label:'Prayer',icon:'🙏',color:'#8B5CF6',val:Math.min(95,15+(total*13)%65)},
    {label:'Courage',icon:'🦁',color:'#F43F5E',val:Math.min(95,10+(total*5)%70)},
  ];
  const days=['S','M','T','W','T','F','S'];
  el.innerHTML=`
    <div class="pd-body">
      <div class="pd-section-hd" style="margin-top:8px;"><span class="pd-section-title">Family Insights</span></div>
      <div class="pd-insights-kpi">
        <div class="pd-ins-card"><span class="pd-ins-icon">📖</span><span class="pd-ins-val">${total}</span><span class="pd-ins-lbl">Lessons done</span></div>
        <div class="pd-ins-card"><span class="pd-ins-icon">🎯</span><span class="pd-ins-val">${missions}</span><span class="pd-ins-lbl">Missions done</span></div>
        <div class="pd-ins-card"><span class="pd-ins-icon">🔥</span><span class="pd-ins-val">${familyStreak}</span><span class="pd-ins-lbl">Best streak</span></div>
        <div class="pd-ins-card"><span class="pd-ins-icon">👨‍👩‍👧</span><span class="pd-ins-val">${kids.length}</span><span class="pd-ins-lbl">Members</span></div>
      </div>
      <div class="pd-section-hd"><span class="pd-section-title">4-Week Activity</span></div>
      <div class="pd-heatmap-wrap">
        <div class="heatmap-day-labels">${days.map(d=>`<div class="heatmap-day-lbl">${d}</div>`).join('')}</div>
        <div class="heatmap">${heatData.map(d=>`<div class="heatmap-cell${d>0?' l'+d:''}" title="${d} lesson${d!==1?'s':''}"></div>`).join('')}</div>
        <div class="pd-heatmap-legend">
          <span>Less</span>
          ${[0,1,2,3,4].map(l=>`<div class="pd-legend-cell" style="background:${['var(--slate-100)','#FEF3C7','#FCD34D','#F59E0B','#D97706'][l]};"></div>`).join('')}
          <span>More</span>
        </div>
      </div>
      <div class="pd-section-hd"><span class="pd-section-title">Character Growth</span></div>
      <div class="pd-char-wrap">
        ${charData.map(c=>`
          <div class="pd-char-row">
            <div class="pd-char-top">
              <span class="pd-char-name">${c.icon} ${c.label}</span>
              <span class="pd-char-pct">${c.val}%</span>
            </div>
            <div class="pd-char-bar"><div class="pd-char-fill" style="width:${c.val}%;background:${c.color};"></div></div>
          </div>`).join('')}
      </div>
      <div class="pd-section-hd"><span class="pd-section-title">By Family Member</span></div>
      ${kids.map(k=>{
        const done=state.completions.filter(c=>c.memberId===k.id).length;
        const kidMissions=state.checkins.filter(c=>c.memberId===k.id&&c.approved).length;
        const streak=getStreak(k.id);
        const pct=Math.min(100,Math.round((done/35)*100));
        return `<div class="pd-kid-card">
          <div class="pd-kid-card-top">
            <div class="pd-kid-card-avatar">${k.avatar}</div>
            <div style="flex:1;">
              <div class="pd-kid-card-name">${k.name}</div>
              <div class="pd-kid-card-meta">${k.tier==='teen'?'Teen':'Kid'}</div>
            </div>
            <button class="btn btn-sky btn-sm" onclick="switchToKid('${k.id}')">View →</button>
          </div>
          <div class="pd-kid-stats">
            <div class="pd-kid-stat"><span class="pd-kid-stat-val">🔥${streak}</span><span class="pd-kid-stat-lbl">Streak</span></div>
            <div class="pd-kid-stat"><span class="pd-kid-stat-val">${done}</span><span class="pd-kid-stat-lbl">Lessons</span></div>
            <div class="pd-kid-stat"><span class="pd-kid-stat-val">${kidMissions}</span><span class="pd-kid-stat-lbl">Missions</span></div>
          </div>
          <div class="pd-member-prog-bar"><div class="pd-member-prog-fill" style="width:${pct}%"></div></div>
          <div class="pd-member-prog-label" style="margin-top:6px;">${done} of 35 &middot; ${pct}% complete</div>
        </div>`;
      }).join('')}
    </div>`;
}

function getStreak(memberId){
  return state.completions.filter(c=>c.memberId===memberId).length;
}
function upgradePlan(){
  state.subscription.plan='premium';saveUserData();
  document.getElementById('planBadge').textContent='Premium';
  showToast('Welcome to Premium Family! 🌟');parentNav('family');
}
function downgradePlan(){
  state.subscription.plan='free';saveUserData();
  document.getElementById('planBadge').textContent='Free';
  showToast('Downgraded to Free plan');parentNav('family');
}
function openAddMember(){
  document.getElementById('newMemberAvatarGrid').innerHTML=AVATARS.map(a=>`<div class="avatar-option" onclick="selectNewAvatar('${a}')">${a}</div>`).join('');
  openModal('modal-add-member');
}
let newMemberSelectedAvatar='😊';
function selectNewAvatar(a){
  newMemberSelectedAvatar=a;
  document.querySelectorAll('#newMemberAvatarGrid .avatar-option').forEach(el=>el.classList.toggle('selected',el.textContent===a));
}
function addMember(){
  const name=document.getElementById('new-member-name').value.trim();
  const tier=document.getElementById('new-member-tier').value;
  if(!name){showToast('Please enter a name');return;}
  const member={id:'m_'+Date.now(),name,role:tier==='teen'?'teen':'kid',avatar:newMemberSelectedAvatar,tier};
  state.members.push(member);saveUserData();
  closeModal('modal-add-member');showToast(`${name} added to your family!`);
  parentNav(state.parentTab);
}
function switchToKid(memberId){
  state.selectedMember=memberId;
  saveUserData();
  // Update parent switcher pills if we're still in parent view
  renderParentKidSwitcher();
  showKidApp();
}

// ===================== KID APP =====================
function showKidApp(){
  // Populate mode bar
  const member=getCurrentMember();
  const nameEl=document.getElementById('kidModeNameLabel');
  if(nameEl&&member) nameEl.innerHTML=`<span>${member.avatar}</span> ${member.name}`;

  // Populate profile switcher (only if 2+ kids)
  const kids=state.members.filter(m=>m.role!=='parent');
  const switcherEl=document.getElementById('kidProfileSwitcher');
  if(switcherEl){
    if(kids.length>1){
      switcherEl.style.display='flex';
      switcherEl.innerHTML=kids.map(k=>`
        <button class="kid-profile-pill${state.selectedMember===k.id?' active':''}" onclick="switchKidProfile('${k.id}')">
          ${k.avatar} ${k.name.split(' ')[0]}
        </button>`).join('');
    } else {
      switcherEl.style.display='none';
    }
  }

  showScreen('screen-kid');
  kidNav('home');
}

function switchKidProfile(memberId){
  state.selectedMember=memberId;
  saveUserData();
  // Re-render mode bar label
  const member=getCurrentMember();
  const nameEl=document.getElementById('kidModeNameLabel');
  if(nameEl&&member) nameEl.innerHTML=`<span>${member.avatar}</span> ${member.name}`;
  // Re-render profile switcher pills
  const kids=state.members.filter(m=>m.role!=='parent');
  const switcherEl=document.getElementById('kidProfileSwitcher');
  if(switcherEl&&kids.length>1){
    switcherEl.innerHTML=kids.map(k=>`
      <button class="kid-profile-pill${state.selectedMember===k.id?' active':''}" onclick="switchKidProfile('${k.id}')">
        ${k.avatar} ${k.name.split(' ')[0]}
      </button>`).join('');
  }
  // Also refresh parent switcher if it exists
  renderParentKidSwitcher();
  // Reload current kid tab with animation
  const content=document.getElementById('kidContent');
  if(content) content.classList.add('slide-in-right');
  kidNav(state.kidTab||'home');
  setTimeout(()=>content?.classList.remove('slide-in-right'),300);
  showToast(`Switched to ${member?.name}'s view`);
}
function kidNav(tab){
  state.kidTab=tab;
  document.querySelectorAll('[id^="knav-"]').forEach(el=>el.classList.remove('active'));
  const btn=document.getElementById(`knav-${tab}`);
  if(btn)btn.classList.add('active');
  renderKidContent(tab);
}
function renderKidContent(tab){
  const el=document.getElementById('kidContent');
  el.innerHTML='';
  if(tab==='home')renderKidHome(el);
  else if(tab==='rewards')renderKidRewards(el);
  else if(tab==='journal')renderKidJournal(el);
  else if(tab==='library')renderKidLibrary(el);
  else if(tab==='profile')renderKidProfile(el);

  // Show journal tab only for teens
  const member = getCurrentMember();
  const journalBtn = document.getElementById('knav-journal');
  if(journalBtn) journalBtn.style.display = member?.tier==='teen' ? 'flex' : 'none';
}
function renderKidHome(el){
  const member=getCurrentMember();
  if(!member){el.innerHTML='<div style="padding:40px;text-align:center;">No member selected.</div>';return;}
  const path=getPath(state.selectedPath||'jesus');
  const doneCount=state.completions.filter(c=>c.memberId===member.id).length;
  const nextIdx=Math.min(doneCount,path.lessons.length-1);
  const lesson=path.lessons[nextIdx];
  const streak=getStreak(member.id);
  const badges=getBadges(member.id);
  const missions=state.checkins.filter(c=>c.memberId===member.id&&c.approved).length;
  const pending=state.checkins.filter(c=>c.memberId===member.id&&!c.approved);
  const pct=Math.round((doneCount/path.lessons.length)*100);
  const lvl=Math.floor(doneCount/3)+1;

  // Time-of-day greeting
  const hr=new Date().getHours();
  const timeGreeting=hr<12?'Good morning':hr<17?'Good afternoon':'Good evening';

  // Stars — generate deterministically so they don't re-randomize on every render
  const starData=Array.from({length:28},(_,i)=>{
    const x=(i*37+13)%95+2;
    const y=(i*53+7)%90+2;
    const size=((i*11)%3)+1;
    const dur=2.5+((i*7)%3);
    const lo=0.15+((i*3)%4)*0.08;
    const hi=0.6+((i*13)%4)*0.1;
    const delay=((i*1.3)%3).toFixed(1);
    return `<div class="kh-star" style="left:${x}%;top:${y}%;width:${size}px;height:${size}px;--dur:${dur}s;--lo:${lo};--hi:${hi};animation-delay:${delay}s;"></div>`;
  }).join('');

  // Streak ring math — circumference 2πr where r≈47 → ~295
  const maxStreak=14; // ring fills at 14 days
  const ringFill=Math.min(streak/maxStreak,1);
  const dashOffset=Math.round(295*(1-ringFill));

  el.innerHTML=`
    <!-- ── Sky hero ── -->
    <div class="kh-sky">
      <div class="kh-stars">${starData}</div>
      <div class="kh-glow-left"></div>
      <div class="kh-glow-right"></div>

      <!-- Avatar + name row -->
      <div class="kh-top-row">
        <div class="kh-avatar-wrap">
          <div class="kh-avatar">${member.avatar}</div>
          <div class="kh-avatar-lvl">LV${lvl}</div>
        </div>
        <div class="kh-greeting-block">
          <div class="kh-time-greeting">${timeGreeting}</div>
          <div class="kh-hero-name">${member.name}</div>
        </div>
      </div>

      <!-- Animated streak ring -->
      <div class="kh-streak-center">
        <div class="kh-streak-ring-wrap">
          <svg class="kh-streak-ring-svg" viewBox="0 0 110 110">
            <defs>
              <linearGradient id="fireGrad" x1="0%" y1="0%" x2="100%" y2="0%">
                <stop offset="0%" stop-color="#F97316"/>
                <stop offset="100%" stop-color="#FBBF24"/>
              </linearGradient>
            </defs>
            <circle class="kh-streak-track" cx="55" cy="55" r="47"/>
            <circle class="kh-streak-fill" cx="55" cy="55" r="47" style="stroke-dashoffset:${dashOffset};"/>
          </svg>
          <div class="kh-streak-inner">
            <div class="kh-streak-flame">🔥</div>
            <div class="kh-streak-num">${streak}</div>
            <div class="kh-streak-label">Day${streak!==1?'s':''}</div>
          </div>
        </div>
        <div class="kh-streak-title">${streak===0?'Start your streak today!':streak===1?'Streak started — come back tomorrow!':streak<7?`${streak}-day streak — keep going!`:`${streak}-day streak — you're on fire!`}</div>
        <div class="kh-streak-sub">${streak<maxStreak?`${maxStreak-streak} more day${maxStreak-streak!==1?'s':''} to fill the ring`:'Ring complete! 🏆'}</div>
      </div>

      <!-- XP stat pills -->
      <div class="kh-stats-row">
        <div class="kh-stat-pill">
          <span class="kh-stat-icon">📖</span>
          <span class="kh-stat-val">${doneCount}</span>
          <span class="kh-stat-lbl">Lessons</span>
        </div>
        <div class="kh-stat-pill">
          <span class="kh-stat-icon">🏅</span>
          <span class="kh-stat-val">${badges}</span>
          <span class="kh-stat-lbl">Badges</span>
        </div>
        <div class="kh-stat-pill">
          <span class="kh-stat-icon">🎯</span>
          <span class="kh-stat-val">${missions}</span>
          <span class="kh-stat-lbl">Missions</span>
        </div>
      </div>
    </div>

    <!-- ── Quest card ── -->
    <div class="kh-body">
      <div class="kh-quest-card">
        <div class="kh-quest-banner">
          <div class="kh-quest-banner-glow"></div>
          <div class="kh-quest-tag">⚔️ Today's Quest</div>
          <div class="kh-quest-title">${lesson.title}</div>
          <div class="kh-quest-path">${path.emoji} ${path.title} &middot; Quest ${nextIdx+1} of ${path.lessons.length}</div>
        </div>
        <div class="kh-quest-body">
          <div class="kh-quest-prog-row">
            <div class="kh-quest-prog-bar">
              <div class="kh-quest-prog-fill" style="width:${pct}%;"></div>
            </div>
            <div class="kh-quest-prog-lbl">${doneCount}/${path.lessons.length} done</div>
          </div>
          <button class="kh-start-btn" onclick="startLesson('${path.id}',${nextIdx})">
            ⚔️ Begin Quest →
          </button>
        </div>
      </div>

      <!-- ── Active missions ── -->
      <div class="kh-section-hd">
        <span class="kh-section-title">Active Missions</span>
        ${pending.length>0?`<span class="kh-section-count">${pending.length} awaiting approval</span>`:''}
      </div>
      ${pending.length>0?
        pending.map(c=>`
          <div class="kh-mission pending">
            <div class="kh-mission-icon" style="background:#FEF3C7;">🎯</div>
            <div class="kh-mission-info">
              <div class="kh-mission-name">${c.missionTitle}</div>
              <div class="kh-mission-meta">Submitted &middot; Waiting for parent ✋</div>
            </div>
            <div class="kh-mission-badge">⏳</div>
          </div>`).join(''):
        `<div class="kh-empty-mission">
          <div class="kh-empty-mission-icon">🗺️</div>
          <div class="kh-empty-mission-title">No active missions yet</div>
          <div class="kh-empty-mission-sub">Finish a lesson to unlock your first mission!</div>
        </div>`}

      <!-- ── Completed missions ── -->
      ${missions>0?`
        <div class="kh-section-hd" style="margin-top:20px;">
          <span class="kh-section-title">Completed</span>
          <span class="kh-section-count">${missions} done ✅</span>
        </div>
        ${state.checkins.filter(c=>c.memberId===member.id&&c.approved).slice().reverse().slice(0,3).map(c=>`
          <div class="kh-mission done">
            <div class="kh-mission-icon" style="background:#D1FAE5;">✅</div>
            <div class="kh-mission-info">
              <div class="kh-mission-name">${c.missionTitle}</div>
              <div class="kh-mission-meta">Approved by parent ${c.emoji||''}</div>
            </div>
          </div>`).join('')}`:''}

      <button class="btn btn-ghost btn-full" onclick="openModal('modal-ask-parent')" style="margin-top:12px;font-size:0.8rem;color:var(--slate-500);border-radius:14px;">💬 Ask a Parent</button>
      <div class="kh-bottom-pad"></div>
    </div>`;

  // Animate streak ring after DOM settles
  requestAnimationFrame(()=>{
    const fill=el.querySelector('.kh-streak-fill');
    if(fill) fill.style.strokeDashoffset=dashOffset;
  });
}

function getBadges(memberId){
  const done=state.completions.filter(c=>c.memberId===memberId).length;
  const missions=state.checkins.filter(c=>c.memberId===memberId&&c.approved).length;
  const streak=getStreak(memberId);
  let count=0;
  if(done>=1)count++;if(done>=3)count++;if(done>=5)count++;if(done>=7)count++;
  if(missions>=1)count++;if(missions>=3)count++;if(streak>=3)count++;
  return count;
}
function renderKidRewards(el){
  const member=getCurrentMember();
  if(!member){el.innerHTML='';return;}
  const done=state.completions.filter(c=>c.memberId===member.id).length;
  const missions=state.checkins.filter(c=>c.memberId===member.id&&c.approved).length;
  const streak=getStreak(member.id);
  const lvl=Math.floor(done/3)+1;
  // XP within current level: each level = 3 lessons
  const xpInLevel=done%3;
  const xpPct=Math.round((xpInLevel/3)*100);

  const ALL_BADGES=[
    {emoji:'⭐',name:'First Light',    req:'Complete 1 lesson',   earned:done>=1,    cat:'lessons'},
    {emoji:'🌿',name:'Seedling',       req:'Complete 3 lessons',  earned:done>=3,    cat:'lessons'},
    {emoji:'🦁',name:'Brave Heart',    req:'Complete 5 lessons',  earned:done>=5,    cat:'lessons'},
    {emoji:'📖',name:'Scripture Scout',req:'Complete 7 lessons',  earned:done>=7,    cat:'lessons'},
    {emoji:'🌍',name:'World Changer',  req:'Complete all 35 lessons',earned:done>=35, cat:'lessons'},
    {emoji:'🎯',name:'Mission Ready',  req:'Complete 1 mission',  earned:missions>=1,cat:'missions'},
    {emoji:'⚔️',name:'Faith Hero',     req:'Complete 3 missions', earned:missions>=3,cat:'missions'},
    {emoji:'🛡️',name:'Quest Master',   req:'Complete 7 missions', earned:missions>=7,cat:'missions'},
    {emoji:'🔥',name:'Streak Starter', req:'3-day streak',        earned:streak>=3,  cat:'streak'},
    {emoji:'💎',name:'Streak Legend',  req:'7-day streak',        earned:streak>=7,  cat:'streak'},
    {emoji:'🙏',name:'Prayer Warrior', req:'Build a family prayer',earned:false,     cat:'special'},
    {emoji:'🌟',name:'Quest Champion', req:'Complete a full path', earned:done>=7,   cat:'special'},
  ];

  const earned=ALL_BADGES.filter(b=>b.earned);
  const locked=ALL_BADGES.filter(b=>!b.earned);
  const nextBadge=locked[0];

  // Stars
  const stars=Array.from({length:22},(_,i)=>{
    const x=(i*41+7)%93+2, y=(i*61+11)%88+2;
    const sz=((i*7)%2)+1, dur=2.5+((i*9)%3), delay=((i*1.7)%3).toFixed(1);
    return `<div class="rw-hero-star" style="left:${x}%;top:${y}%;width:${sz}px;height:${sz}px;--dur:${dur}s;animation-delay:${delay}s;"></div>`;
  }).join('');

  el.innerHTML=`
    <!-- ── Trophy hero ── -->
    <div class="rw-hero">
      <div class="rw-hero-stars">${stars}</div>
      <div class="rw-hero-glow"></div>
      <div class="rw-hero-content">
        <div class="rw-hero-top">
          <div class="rw-trophy">🏆</div>
          <div>
            <div class="rw-hero-name">${member.name}'s Trophy Room</div>
            <div class="rw-hero-level">Level ${lvl} · ${earned.length} of ${ALL_BADGES.length} badges</div>
          </div>
        </div>
        <div class="rw-xp-section">
          <div class="rw-xp-header">
            <span class="rw-xp-label">Level ${lvl} Progress</span>
            <span class="rw-xp-val">${xpInLevel}/3 XP</span>
          </div>
          <div class="rw-xp-track">
            <div class="rw-xp-fill" id="rwXpFill" style="width:0%;"></div>
          </div>
          <div class="rw-xp-next">${xpInLevel===0&&done===0?'Complete your first lesson to earn XP!':xpInLevel===0?`Level ${lvl} reached! 🎉`:`${3-xpInLevel} more lesson${3-xpInLevel!==1?'s':''} to reach Level ${lvl+1}`}</div>
        </div>
        <div class="rw-stats">
          <div class="rw-stat">
            <span class="rw-stat-val">${done}</span>
            <span class="rw-stat-lbl">Lessons</span>
          </div>
          <div class="rw-stat">
            <span class="rw-stat-val">${missions}</span>
            <span class="rw-stat-lbl">Missions</span>
          </div>
          <div class="rw-stat">
            <span class="rw-stat-val">${streak}</span>
            <span class="rw-stat-lbl">Streak</span>
          </div>
          <div class="rw-stat">
            <span class="rw-stat-val">${earned.length}</span>
            <span class="rw-stat-lbl">Badges</span>
          </div>
        </div>
      </div>
    </div>

    <div class="rw-body">
      <!-- ── Streak card ── -->
      <div class="rw-streak-card">
        <div class="rw-streak-flame">🔥</div>
        <div class="rw-streak-info">
          <div class="rw-streak-num">${streak} Day${streak!==1?'s':''}</div>
          <div class="rw-streak-label">${streak===0?'No streak yet':'Current Streak'}</div>
          <div class="rw-streak-sub">${streak===0?'Complete a lesson today to start!':streak<3?'3 days unlocks Streak Starter badge!':streak<7?'7 days unlocks Streak Legend badge!':'You\'re legendary! 🌟'}</div>
        </div>
      </div>

      <!-- ── Next unlock ── -->
      ${nextBadge?`
      <div class="rw-section-hd">
        <span class="rw-section-title">Next Unlock</span>
      </div>
      <div class="rw-next-unlock">
        <div class="rw-next-icon">${nextBadge.emoji}</div>
        <div class="rw-next-info">
          <div class="rw-next-label">🔒 Locked</div>
          <div class="rw-next-name">${nextBadge.name}</div>
          <div class="rw-next-desc">${nextBadge.req}</div>
        </div>
      </div>`:''}

      <!-- ── Earned badges ── -->
      ${earned.length>0?`
      <div class="rw-section-hd">
        <span class="rw-section-title">Earned Badges</span>
        <span class="rw-section-count">${earned.length} unlocked ✨</span>
      </div>
      <div class="rw-badge-grid">
        ${earned.map((b,i)=>`
          <div class="rw-badge earned" style="--i:${i}">
            <div class="rw-badge-shine">NEW</div>
            <span class="rw-badge-icon">${b.emoji}</span>
            <div class="rw-badge-name">${b.name}</div>
            <div class="rw-badge-req">${b.req}</div>
          </div>`).join('')}
      </div>`:`
      <div style="background:white;border-radius:20px;padding:28px 20px;text-align:center;margin-bottom:8px;box-shadow:0 2px 12px rgba(0,0,0,0.07);">
        <div style="font-size:2.5rem;margin-bottom:10px;">🌱</div>
        <div style="font-weight:800;font-size:0.95rem;color:var(--slate-700);margin-bottom:4px;">No badges yet</div>
        <div style="font-size:0.8rem;color:var(--slate-400);line-height:1.5;">Complete your first lesson to earn your first badge!</div>
      </div>`}

      <!-- ── Locked badges ── -->
      <div class="rw-section-hd" style="margin-top:20px;">
        <span class="rw-section-title">Still Locked</span>
        <span class="rw-section-count">${locked.length} to go</span>
      </div>
      <div class="rw-badge-grid">
        ${locked.map((b,i)=>`
          <div class="rw-badge locked" style="--i:${i}">
            <span class="rw-badge-icon">${b.emoji}</span>
            <div class="rw-badge-name">${b.name}</div>
            <div class="rw-badge-req">${b.req}</div>
          </div>`).join('')}
      </div>
    </div>`;

  // Animate XP bar after paint
  requestAnimationFrame(()=>{
    const fill=el.querySelector('#rwXpFill');
    if(fill) fill.style.width=xpPct+'%';
  });
}
function renderKidLibrary(el){
  const member=getCurrentMember();
  const done=state.completions.filter(c=>c.memberId===member?.id).map(c=>c.lessonId);
  let allLessons=[];
  PATHS.forEach(p=>p.lessons.forEach(l=>allLessons.push({...l,pathId:p.id,pathTitle:p.title,pathEmoji:p.emoji})));
  el.innerHTML=`
    <div style="padding:20px 16px 0;">
      <h2 style="font-family:var(--font-display);font-size:1.4rem;font-weight:700;">My Library</h2>
      <p style="font-size:0.875rem;color:var(--slate-500);margin-top:4px;">${done.length} of 35 lessons completed</p>
    </div>
    <div style="padding:12px 16px;padding-bottom:100px;" class="library-list">
      ${done.length===0?`<div class="card" style="text-align:center;padding:32px;"><div style="font-size:2rem;margin-bottom:8px;">📖</div><div style="font-weight:600;">No lessons yet</div><p class="body-sm muted">Complete your first lesson to see it here!</p></div>`:''}
      ${allLessons.filter(l=>done.includes(l.id)).map(l=>`
        <div class="library-item" onclick="startLesson('${l.pathId}',${PATHS.find(p=>p.id===l.pathId).lessons.indexOf(l)})">
          <div class="library-check">✓</div>
          <div class="library-info"><div class="library-title">${l.title}</div><div class="library-meta">${l.pathEmoji} ${l.pathTitle} · ${l.verseRef}</div></div>
        </div>`).join('')}
    </div>`;
}
// ===================== TEEN JOURNAL =====================

// Gemini API key — set your key here or via window.FQ_GEMINI_KEY
const GEMINI_KEY = window.FQ_GEMINI_KEY || 'YOUR_GEMINI_API_KEY';
const GEMINI_CONFIGURED = !GEMINI_KEY.startsWith('YOUR_');

const JOURNAL_PROMPTS_DEFAULT = [
  {icon:'🪞', text:'What did God show me today?'},
  {icon:'💡', text:'What challenged me this week?'},
  {icon:'🙏', text:'What am I grateful for right now?'},
  {icon:'⚔️', text:'Where did I need more courage?'},
  {icon:'🌱', text:'How am I growing in faith?'},
];


function renderKidJournal(el){
  const member = getCurrentMember();
  if(!member){ el.innerHTML=''; return; }

  const entries = (state.journals||[]).filter(j=>j.memberId===member.id)
    .sort((a,b)=>new Date(b.createdAt)-new Date(a.createdAt));

  const lastCompletion = state.completions.filter(c=>c.memberId===member.id).slice(-1)[0];
  let lastLesson = null;
  if(lastCompletion){
    const path = PATHS.find(p=>p.id===lastCompletion.pathId);
    lastLesson = path ? path.lessons.find(l=>l.id===lastCompletion.lessonId) : null;
  }

  const today = new Date().toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric'});
  const wordCount = entries.reduce((sum,e)=>sum+(e.text||'').split(/\s+/).filter(Boolean).length,0);

  // Build prompt chips HTML separately to avoid nested template literal issues
  var defaultChips = JOURNAL_PROMPTS_DEFAULT.slice(0,4).map(function(p){
    return '<div class="jn-prompt-chip" onclick="jnSelectPrompt(this,' + JSON.stringify(p.text) + ')">'
      + '<span class="jn-prompt-chip-icon">' + p.icon + '</span>' + p.text + '</div>';
  }).join('');

  var aiChip = (GEMINI_CONFIGURED && lastLesson)
    ? '<div class="jn-prompt-chip jn-prompt-chip-generate" id="jnAiBtn" onclick="jnLoadAiPrompts()">✨ AI prompts for this lesson</div>'
    : '';

  var geminiLabel = GEMINI_CONFIGURED
    ? '<span class="jn-gemini-badge">✨ Gemini AI</span>'
    : '<span style="font-size:0.65rem;color:var(--slate-400);">Add Gemini key for AI prompts</span>';

  // Build entries HTML separately
  var entriesHtml = '';
  if(entries.length === 0){
    entriesHtml = '<div class="jn-empty">'
      + '<span class="jn-empty-icon">📔</span>'
      + '<div class="jn-empty-title">Your journal is waiting</div>'
      + '<div class="jn-empty-sub">Write your first entry above. Just between you and God.</div>'
      + '</div>';
  } else {
    entriesHtml = entries.map(function(e,i){
      var d = new Date(e.createdAt).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'});
      var promptHtml = e.prompt ? '<div class="jn-entry-prompt">"' + e.prompt + '"</div>' : '';
      var lessonHtml = e.lessonTitle ? '<span class="jn-entry-lesson">📖 ' + e.lessonTitle + '</span>' : '';
      return '<div class="jn-entry" style="--i:' + i + '" onclick="jnToggleEntry(this)">'
        + '<div class="jn-entry-header">'
        + '<span class="jn-entry-date">' + d + '</span>'
        + '<span class="jn-entry-mood">' + (e.mood||'📔') + '</span>'
        + '</div>'
        + promptHtml
        + '<div class="jn-entry-text collapsed">' + (e.text||'') + '</div>'
        + lessonHtml
        + '</div>';
    }).join('');
  }

  el.innerHTML = '<div class="jn-hero">'
    + '<div class="jn-hero-grid"></div>'
    + '<div class="jn-hero-glow"></div>'
    + '<div class="jn-hero-content">'
    + '<div class="jn-hero-top">'
    + '<div class="jn-hero-icon">✍️</div>'
    + '<div><div class="jn-hero-name">' + member.name + "'s Journal</div>"
    + '<div class="jn-hero-sub">Private · Faith reflections</div>'
    + '</div></div>'
    + '<div class="jn-streak-row">'
    + '<div class="jn-stat"><span class="jn-stat-val">' + entries.length + '</span><span class="jn-stat-lbl">Entries</span></div>'
    + '<div class="jn-stat"><span class="jn-stat-val">' + wordCount + '</span><span class="jn-stat-lbl">Words</span></div>'
    + '<div class="jn-stat"><span class="jn-stat-val">' + getStreak(member.id) + '</span><span class="jn-stat-lbl">Streak</span></div>'
    + '</div></div></div>'
    + '<div class="jn-body">'
    + '<div class="jn-composer" id="jnComposer">'
    + '<div class="jn-composer-header">'
    + '<span class="jn-composer-title">New Entry</span>'
    + '<span class="jn-composer-date">' + today + '</span>'
    + '</div>'
    + '<div class="jn-composer-body">'
    + '<div id="jnPromptArea">'
    + '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">'
    + '<span style="font-size:0.72rem;font-weight:700;color:var(--slate-500);text-transform:uppercase;letter-spacing:0.08em;">Prompts</span>'
    + geminiLabel
    + '</div>'
    + '<div class="jn-prompt-row" id="jnPromptChips">' + defaultChips + aiChip + '</div>'
    + '</div>'
    + '<textarea class="jn-textarea" id="jnText" rows="5" placeholder="Write freely — this is just for you..." '
    + 'oninput="document.getElementById(\'jnCharCount\').textContent=this.value.split(/\\s+/).filter(Boolean).length+\' words\'">'
    + '</textarea>'
    + '<div class="jn-composer-footer">'
    + '<span class="jn-char-count" id="jnCharCount">0 words</span>'
    + '<button class="jn-save-btn" onclick="jnSave()">Save Entry ✍️</button>'
    + '</div></div></div>'
    + '<div class="jn-section-hd">'
    + '<span class="jn-section-title">Past Entries</span>'
    + '<span class="jn-section-sub">' + entries.length + ' total</span>'
    + '</div>'
    + entriesHtml
    + '</div>';

  if(GEMINI_CONFIGURED && lastLesson && entries.length === 0){
    setTimeout(function(){ jnLoadAiPrompts(); }, 400);
  }
}

function jnSelectPrompt(chip, text){
  document.querySelectorAll('.jn-prompt-chip').forEach(c=>c.classList.remove('active'));
  if(chip) chip.classList.add('active');
  const ta = document.getElementById('jnText');
  if(ta && !ta.value.trim()) ta.placeholder = text + '...';
  window._jnSelectedPrompt = text;
}

async function jnLoadAiPrompts(){
  const member = getCurrentMember();
  const lastCompletion = state.completions.filter(c=>c.memberId===member?.id).slice(-1)[0];
  if(!lastCompletion) return;
  const path = PATHS.find(p=>p.id===lastCompletion.pathId);
  const lesson = path?.lessons.find(l=>l.id===lastCompletion.lessonId);
  if(!lesson) return;

  const chipsEl = document.getElementById('jnPromptChips');
  if(chipsEl) chipsEl.innerHTML = `<div class="jn-ai-generating"><div class="jn-ai-dot"></div><div class="jn-ai-dot" style="animation-delay:0.2s"></div><div class="jn-ai-dot" style="animation-delay:0.4s"></div><span>Gemini is thinking...</span></div>`;

  const prompts = await geminiJournalPrompts(lesson.title, lesson.summary, member.name);
  const toShow = prompts || JOURNAL_PROMPTS_DEFAULT;

  if(chipsEl){
    chipsEl.innerHTML = toShow.map((p,i)=>`
      <div class="jn-prompt-chip${i===0?' active':''}" onclick="jnSelectPrompt(this,${JSON.stringify(p.text||'')})">
        <span class="jn-prompt-chip-icon">${p.icon||'💭'}</span>${p.text}
      </div>`).join('') +
      `<div class="jn-prompt-chip jn-prompt-chip-generate" onclick="jnLoadAiPrompts()">↻ New prompts</div>`;
  }

  if(toShow[0]){
    const ta = document.getElementById('jnText');
    if(ta && !ta.value.trim()) ta.placeholder = toShow[0].text + '...';
    window._jnSelectedPrompt = toShow[0].text;
  }
}

function jnSave(){
  const text = (document.getElementById('jnText')?.value||'').trim();
  if(!text){ showToast('Write something first ✍️'); return; }
  const member = getCurrentMember();
  const lastCompletion = state.completions.filter(c=>c.memberId===member?.id).slice(-1)[0];
  const path = lastCompletion ? PATHS.find(p=>p.id===lastCompletion.pathId) : null;
  const lesson = path?.lessons.find(l=>l.id===lastCompletion?.lessonId);

  const entry = {
    id:'jn_'+Date.now(),
    memberId:member.id,
    text,
    prompt:window._jnSelectedPrompt||null,
    mood:'📔',
    lessonTitle:lesson?.title||null,
    lessonId:lesson?.id||null,
    createdAt:new Date().toISOString(),
  };

  if(!state.journals) state.journals=[];
  state.journals.push(entry);
  saveUserData();
  window._jnSelectedPrompt=null;
  showToast('Entry saved 📔');
  const el=document.getElementById('kidContent');
  if(el) renderKidJournal(el);
}

function jnToggleEntry(el){
  const textEl=el.querySelector('.jn-entry-text');
  if(textEl) textEl.classList.toggle('collapsed');
}

async function geminiJournalPrompts(lessonTitle, lessonSummary, memberName){
  if(!GEMINI_CONFIGURED) return null;
  try {
    const res = await fetch(
      `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_KEY}`,
      {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({
          contents:[{parts:[{text:
            `You are a thoughtful faith journaling coach for teenagers (ages 11-17).
A teen just completed a Bible lesson titled "${lessonTitle}".
Lesson summary: "${lessonSummary}"
Their name is ${memberName}.

Generate exactly 4 short, personal journaling prompts tailored to this lesson.
Each prompt should be 6-10 words, written directly to the teen, starting with an action verb.
Format: JSON array of objects with "icon" (single emoji) and "text" (the prompt).
Only return valid JSON, no markdown, no explanation.
Example: [{"icon":"🌊","text":"Describe a storm you faced this week."}]`
          }]}],
          generationConfig:{temperature:0.8,maxOutputTokens:300}
        })
      }
    );
    const data = await res.json();
    const raw = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
    const clean = raw.replace(/```json|```/g,'').trim();
    return JSON.parse(clean);
  } catch(e) {
    console.error('[FQ] Gemini error:', e);
    return null;
  }
}

async function geminiDeepen(lessonId, lessonTitle, tier){
  const btn = document.getElementById('geminiDeepBtn');
  const resultEl = document.getElementById('geminiDeepResult');
  if(!btn || !resultEl) return;

  btn.disabled = true;
  btn.textContent = '✨ Thinking...';
  resultEl.innerHTML = `<div class="lp2-gemini-loading"><div class="jn-ai-dot"></div><div class="jn-ai-dot" style="animation-delay:0.2s"></div><div class="jn-ai-dot" style="animation-delay:0.4s"></div><span>Gemini is going deeper...</span></div>`;

  const path = PATHS.find(p => p.lessons.some(l => l.id === lessonId));
  const lesson = path?.lessons.find(l => l.id === lessonId);
  if(!lesson){ btn.disabled=false; btn.textContent='✨ Go Deeper with AI'; resultEl.innerHTML=''; return; }

  const tierDesc = tier==='teen' ? 'a teenager (14-17), intellectually curious, wants real depth'
    : tier==='younger' ? 'a young child (4-6), needs simple concrete language and fun analogies'
    : 'a child (7-10), curious and energetic, likes stories and relatable examples';

  try {
    const res = await fetch(
      `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_KEY}`,
      {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({
          contents:[{parts:[{text:
`You are a faith education coach helping ${tierDesc} understand a Bible lesson.

Lesson: "${lessonTitle}"
Verse excerpt: "${lesson.excerpt}"
Summary: "${lesson.summary}"

Provide:
1. A "Deeper Insight" paragraph (3-4 sentences) — go beyond the summary. Include historical context, original meaning, or a real-world connection appropriate for this age.
2. Exactly 2 bonus discussion questions — fresh, not repeating the existing ones. Make them thought-provoking for this age group.

Respond ONLY as JSON, no markdown:
{"insight":"...","questions":["...","..."]}`
          }]}],
          generationConfig:{temperature:0.7, maxOutputTokens:500}
        })
      }
    );
    const data = await res.json();
    const raw = data.candidates?.[0]?.content?.parts?.[0]?.text||'';
    const clean = raw.replace(/```json|```/g,'').trim();
    const parsed = JSON.parse(clean);

    resultEl.innerHTML = `
      <div class="lp2-gemini-result">
        <div class="lp2-gemini-label">✨ Gemini AI · Deeper Insight</div>
        <div class="lp2-gemini-text">${parsed.insight}</div>
        ${parsed.questions?.map((q,i)=>`
          <div class="lp2-gemini-q">
            <div class="lp2-gemini-q-num">Bonus Question ${i+1}</div>
            ${q}
          </div>`).join('')||''}
      </div>`;
    btn.style.display = 'none';
  } catch(e) {
    console.error('[FQ] Gemini deepen error:', e);
    resultEl.innerHTML = '';
    btn.disabled = false;
    btn.textContent = '✨ Go Deeper with AI';
    showToast('AI unavailable — try again');
  }
}
  const member = getCurrentMember();
  if(!member){ el.innerHTML=''; return; }

  const isTeen = member.tier === 'teen';
  const entries = (state.journals||[]).filter(j => j.memberId === member.id)
    .sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));

  // Find last completed lesson for context
  const lastCompletion = state.completions.filter(c=>c.memberId===member.id).slice(-1)[0];
  let lastLesson = null;
  if(lastCompletion){
    const path = PATHS.find(p=>p.id===lastCompletion.pathId);
    lastLesson = path?.lessons.find(l=>l.id===lastCompletion.lessonId);
  }

  const today = new Date().toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric'});
  const wordCount = entries.reduce((sum,e)=>sum+(e.text||'').split(/\s+/).filter(Boolean).length,0);

  el.innerHTML = `
    <div class="jn-hero">
      <div class="jn-hero-grid"></div>
      <div class="jn-hero-glow"></div>
      <div class="jn-hero-content">
        <div class="jn-hero-top">
          <div class="jn-hero-icon">✍️</div>
          <div>
            <div class="jn-hero-name">${member.name}'s Journal</div>
            <div class="jn-hero-sub">Private · Faith reflections</div>
          </div>
        </div>
        <div class="jn-streak-row">
          <div class="jn-stat"><span class="jn-stat-val">${entries.length}</span><span class="jn-stat-lbl">Entries</span></div>
          <div class="jn-stat"><span class="jn-stat-val">${wordCount}</span><span class="jn-stat-lbl">Words</span></div>
          <div class="jn-stat"><span class="jn-stat-val">${getStreak(member.id)}</span><span class="jn-stat-lbl">Streak</span></div>
        </div>
      </div>
    </div>

    <div class="jn-body">
      <!-- Composer -->
      <div class="jn-composer" id="jnComposer">
        <div class="jn-composer-header">
          <span class="jn-composer-title">New Entry</span>
          <span class="jn-composer-date">${today}</span>
        </div>
        <div class="jn-composer-body">
          <div id="jnPromptArea">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
              <span style="font-size:0.72rem;font-weight:700;color:var(--slate-500);text-transform:uppercase;letter-spacing:0.08em;">Prompts</span>
              ${GEMINI_CONFIGURED
                ? `<span class="jn-gemini-badge">✨ Gemini AI</span>`
                : `<span style="font-size:0.65rem;color:var(--slate-400);">Add your Gemini key for AI prompts</span>`}
            </div>
            <div class="jn-prompt-row" id="jnPromptChips">
              ${JOURNAL_PROMPTS_DEFAULT.slice(0,4).map((p,i)=>`
                <div class="jn-prompt-chip" onclick="jnSelectPrompt(this,'${p.text.replace(/'/g,"\\'")}')">
                  <span class="jn-prompt-chip-icon">${p.icon}</span>${p.text}
                </div>`).join('')}
              ${GEMINI_CONFIGURED && lastLesson ? `
                <div class="jn-prompt-chip jn-prompt-chip-generate" id="jnAiBtn" onclick="jnLoadAiPrompts()">
                  ✨ AI prompts for "${lastLesson.title.split(':')[0]}"
                </div>` : ''}
            </div>
          </div>
          <textarea class="jn-textarea" id="jnText" rows="5"
            placeholder="Write freely — this is just for you..."
            oninput="document.getElementById('jnCharCount').textContent=this.value.split(/\\s+/).filter(Boolean).length+' words'">
          </textarea>
          <div class="jn-composer-footer">
            <span class="jn-char-count" id="jnCharCount">0 words</span>
            <button class="jn-save-btn" onclick="jnSave()">Save Entry ✍️</button>
          </div>
        </div>
      </div>

      <!-- Past entries -->
      <div class="jn-section-hd">
        <span class="jn-section-title">Past Entries</span>
        <span class="jn-section-sub">${entries.length} total</span>
      </div>

      ${entries.length === 0 ? `
        <div class="jn-empty">
          <span class="jn-empty-icon">📔</span>
          <div class="jn-empty-title">Your journal is waiting</div>
          <div class="jn-empty-sub">Write your first entry above. No one else can see this — it's just between you and God.</div>
        </div>` :
        entries.map((e,i)=>{
          const d = new Date(e.createdAt).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'});
          return `
            <div class="jn-entry" style="--i:${i}" onclick="jnToggleEntry(this)">
              <div class="jn-entry-header">
                <span class="jn-entry-date">${d}</span>
                <span class="jn-entry-mood">${e.mood||'📔'}</span>
              </div>
              ${e.prompt?`<div class="jn-entry-prompt">"${e.prompt}"</div>`:''}
              <div class="jn-entry-text collapsed">${e.text||''}</div>
              ${e.lessonTitle?`<span class="jn-entry-lesson">📖 ${e.lessonTitle}</span>`:''}
            </div>`;
        }).join('')}
    </div>`;

  // Auto-load AI prompts if Gemini configured and there's a recent lesson
  if(GEMINI_CONFIGURED && lastLesson && entries.length === 0){
    setTimeout(()=>jnLoadAiPrompts(), 400);
  }
}

function renderKidProfile(el){
  const member=getCurrentMember();
  const kids=state.members.filter(m=>m.role!=='parent');
  el.innerHTML=`
    <div style="padding:24px 20px;padding-bottom:100px;">
      <div style="text-align:center;padding:28px 0 20px;">
        <div style="font-size:4rem;margin-bottom:10px;">${member?.avatar||'😊'}</div>
        <div style="font-family:var(--font-display);font-size:1.5rem;font-weight:700;">${member?.name}</div>
        <div style="font-size:0.875rem;color:var(--slate-500);margin-top:4px;">${member?.tier==='teen'?'Teen':'Kid'} · ${state.family?.name}</div>
      </div>
      <div class="stats-row" style="margin-bottom:24px;">
        <div class="stat-card"><span class="stat-value">${getStreak(member?.id)}</span><span class="stat-label">Streak</span></div>
        <div class="stat-card"><span class="stat-value">${state.completions.filter(c=>c.memberId===member?.id).length}</span><span class="stat-label">Lessons</span></div>
        <div class="stat-card"><span class="stat-value">${getBadges(member?.id)}</span><span class="stat-label">Badges</span></div>
      </div>
      ${kids.length>1?`
        <div style="margin-bottom:16px;">
          <div style="font-size:0.75rem;font-weight:700;color:var(--slate-500);text-transform:uppercase;letter-spacing:0.06em;margin-bottom:10px;">Switch Profile</div>
          <div style="display:flex;flex-direction:column;gap:8px;">
            ${kids.filter(k=>k.id!==member?.id).map(k=>`
              <button class="btn btn-secondary btn-full" onclick="switchKidProfile('${k.id}')" style="justify-content:flex-start;gap:10px;">
                <span style="font-size:1.2rem;">${k.avatar}</span> Switch to ${k.name}
              </button>`).join('')}
          </div>
        </div>`:''}
      <div style="display:flex;flex-direction:column;gap:8px;">
        <button class="btn btn-secondary btn-full" onclick="showParentApp()" style="justify-content:flex-start;gap:8px;">⬆ Back to Parent Dashboard</button>
        <button class="btn btn-ghost btn-full" onclick="doSignOut()" style="color:var(--rose);">Sign Out</button>
      </div>
    </div>`;
}

// ===================== LESSON PLAYER =====================
function startLesson(pathId,lessonIndex){
  state.lessonState={path:pathId,lessonIndex,step:0,selectedMission:null,selectedEmoji:null,reflectText:'',missionIndex:0};
  showScreen('screen-lesson');renderLessonStep();
}
function exitLesson(){
  const was=state.selectedMember?'kid':'parent';
  if(state.members.find(m=>m.id===state.selectedMember)?.role==='parent'){showParentApp();}
  else{showKidApp();}
}
const LESSON_STEPS=['read','understand','talk','do','reflect','prayer'];

const STEP_META=[
  {tag:'📖 Read',     band:'lp2-band-read',    label:'Read',    clr:'clr-read'},
  {tag:'🤔 Understand',band:'lp2-band-understand',label:'Understand',clr:'clr-understand'},
  {tag:'💬 Talk',     band:'lp2-band-talk',    label:'Talk',    clr:'clr-talk'},
  {tag:'🚀 Mission',  band:'lp2-band-do',      label:'Mission', clr:'clr-do'},
  {tag:'💭 Reflect',  band:'lp2-band-reflect', label:'Reflect', clr:'clr-reflect'},
  {tag:'🙏 Pray',     band:'lp2-band-prayer',  label:'Pray',    clr:'clr-prayer'},
];

function renderLessonStep(){
  const {path:pathId,lessonIndex,step}=state.lessonState;
  const lesson=getLesson(pathId,lessonIndex);
  const member=getCurrentMember();
  if(!lesson){exitLesson();return;}

  const meta=STEP_META[step];
  const stepName=LESSON_STEPS[step];
  const isTeen=member?.tier==='teen';
  const isYounger=member?.tier==='younger';

  // ── Nav: step track pills ──
  const track=document.getElementById('lp2Track');
  if(track){
    track.innerHTML=STEP_META.map((s,i)=>{
      const cls=i<step?'done':i===step?'active':'pending';
      return `<button class="lp2-step-pip ${cls}" onclick="jumpLessonStep(${i})">${cls==='active'?s.label:cls==='done'?'✓':''}</button>`;
    }).join('');
  }
  const frac=document.getElementById('lp2Fraction');
  if(frac) frac.textContent=`${step+1}/6`;

  // ── Back / Next buttons ──
  const prevBtn=document.getElementById('lessonPrevBtn');
  const nextBtn=document.getElementById('lessonNextBtn');
  if(prevBtn) prevBtn.style.display=step===0?'none':'block';
  if(nextBtn){
    const isLast=step===LESSON_STEPS.length-1;
    nextBtn.textContent=isLast?'Complete Lesson 🎉':'Continue →';
    nextBtn.className=`lp2-next-btn ${isLast?'complete':meta.clr}`;
  }

  // ── Band HTML ──
  const bandHtml=`
    <div class="lp2-band ${meta.band} lp2-step-in">
      <div class="lp2-band-grid"></div>
      <div class="lp2-band-glow"></div>
      <div class="lp2-band-content">
        <div class="lp2-step-tag">${meta.tag}</div>
        <div class="lp2-lesson-title">${lesson.title}</div>
        ${step===0?`<div class="lp2-lesson-sub">${lesson.verseRef}</div>`:''}
      </div>
    </div>`;

  // ── Step content ──
  let contentHtml='';

  if(stepName==='read'){
    const verseClean=lesson.excerpt.replace(/—\s*.+?(\(.*?\))?$/,'').trim();
    contentHtml=`
      <div class="lp2-content lp2-step-in">
        <div class="lp2-verse-card">
          <div class="lp2-verse-header">
            <div class="lp2-verse-ref-pill">📜 ${lesson.verseRef}</div>
            <div class="lp2-verse-text">"${verseClean}"</div>
          </div>
          <div class="lp2-verse-footer">
            <div class="lp2-verse-translation">World English Bible / KJV · Public Domain</div>
          </div>
        </div>
        <div class="lp2-section-label">What's happening here</div>
        <div class="lp2-summary">
          <div class="lp2-summary-label">Context</div>
          <div class="lp2-summary-text">${lesson.summary}</div>
        </div>
      </div>`;

  } else if(stepName==='understand'){
    const exp=isYounger
      ?`Let's think about this together! ${lesson.summary} Pretty cool, right? 😊`
      :isTeen
      ?`<strong>Deeper Study:</strong> ${lesson.summary}<br><br>Consider its original audience — what would these words have meant to them? Then ask how the same truth lands in your world today. That gap is where real faith grows.`
      :`Here's what this means for you: ${lesson.summary} God's word isn't just old history — it's alive and speaking into your life right now.`;
    const tierLabel=isYounger?'🌱 Little Explorer':isTeen?'🚀 Teen Study':'⭐ Kid Explanation';
    const geminiBtn = GEMINI_CONFIGURED ? `
      <button class="lp2-gemini-btn" id="geminiDeepBtn" onclick="geminiDeepen('${lesson.id}','${(lesson.title).replace(/'/g,"\\'")}','${(isTeen?'teen':isYounger?'younger':'kid')}')">
        ✨ Go Deeper with AI
      </button>` : '';
    contentHtml=`
      <div class="lp2-content lp2-step-in">
        <div class="lp2-explain">
          <div class="lp2-explain-tier">${tierLabel}</div>
          <div class="lp2-explain-text" id="explainText">${exp}</div>
        </div>
        ${geminiBtn}
        <div id="geminiDeepResult"></div>
        <div class="lp2-section-label">Think it through</div>
        <div class="lp2-q-list" id="questionList">
          ${lesson.questions.slice(0,2).map((q,i)=>`
            <div class="lp2-q" style="--i:${i}">
              <div class="lp2-q-num">Question ${i+1}</div>
              <div class="lp2-q-text">${q}</div>
            </div>`).join('')}
        </div>
        <button class="btn btn-ghost btn-sm" style="color:var(--slate-400);font-size:0.78rem;" onclick="openModal('modal-ask-parent')">🙋 Ask a parent about this</button>
      </div>`;

  } else if(stepName==='talk'){
    contentHtml=`
      <div class="lp2-content lp2-step-in">
        <div class="lp2-coaching">
          <div class="lp2-coaching-label">👨‍👩‍👧 Family Coach</div>
          <div class="lp2-coaching-text">Gather together. Let your child answer first — curiosity beats correction every time. Your goal is connection, not the right answer.</div>
        </div>
        <div class="lp2-section-label">Discussion questions</div>
        <div class="lp2-q-list">
          ${lesson.questions.map((q,i)=>`
            <div class="lp2-q" style="--i:${i}">
              <div class="lp2-q-num">${['First','Second','Third','Fourth'][i]||`Q${i+1}`} question</div>
              <div class="lp2-q-text">${q}</div>
            </div>`).join('')}
        </div>
      </div>`;

  } else if(stepName==='do'){
    contentHtml=`
      <div class="lp2-content lp2-step-in">
        <p style="font-size:0.85rem;color:var(--slate-500);line-height:1.65;margin-bottom:16px;">Choose one mission to complete in the real world this week. All missions work offline — no internet needed.</p>
        <div class="lp2-mission-list">
          ${lesson.missions.map((m,i)=>{
            const lvlCls=m.level==='Easy'?'lp2-badge-easy':m.level==='Medium'?'lp2-badge-medium':'lp2-badge-hard';
            const sel=state.lessonState.selectedMission===i;
            return `<div class="lp2-mission${sel?' selected':''}" style="--i:${i}" onclick="selectMission(${i})">
              <div class="lp2-mission-top">
                <span class="lp2-mission-emoji">${m.emoji}</span>
                <div class="lp2-mission-meta">
                  <div class="lp2-mission-title">${m.title}</div>
                  <div class="lp2-mission-desc">${m.desc}</div>
                </div>
                <div class="lp2-mission-check">${sel?'✓':''}</div>
              </div>
              <div class="lp2-mission-footer">
                <span class="lp2-mission-badge ${lvlCls}">${m.level}</span>
                <span style="font-size:0.7rem;color:var(--slate-400);">Real-world · Offline ✓</span>
              </div>
            </div>`;
          }).join('')}
        </div>
      </div>`;

  } else if(stepName==='reflect'){
    const prompts=lesson.reflectPrompts||['How did your mission go?','What will you remember from this lesson?'];
    contentHtml=`
      <div class="lp2-content lp2-step-in">
        <div class="lp2-mood-section">
          <div class="lp2-mood-label">How are you feeling right now?</div>
          <div class="lp2-mood-grid">
            ${['😊','🤩','😅','😤','🙏','😢','💪','🥺'].map(e=>`
              <button class="lp2-mood-btn${state.lessonState.selectedEmoji===e?' selected':''}" onclick="selectEmoji('${e}')">${e}</button>`).join('')}
          </div>
        </div>
        ${prompts.slice(0,isTeen?2:1).map((p,i)=>`
          <div class="lp2-journal">
            <div class="lp2-journal-label">${p}</div>
            <textarea class="lp2-journal-input" rows="${isTeen?3:3}" id="reflectText${i+1}"
              placeholder="${isYounger?'Just one sentence is great!':'Write a few sentences...'}"
              oninput="${i===0?'updateReflect(this.value)':''}"
              style="width:100%;">${i===0?state.lessonState.reflectText||'':''}</textarea>
          </div>`).join('')}
      </div>`;

  } else if(stepName==='prayer'){
    contentHtml=`
      <div class="lp2-content lp2-step-in">
        <p style="font-size:0.85rem;color:var(--slate-500);line-height:1.65;margin-bottom:18px;">Each person adds one line to build your prayer together. Then read it aloud as one.</p>
        <div class="lp2-prayer-lines">
          ${state.members.map((m,i)=>`
            <div class="lp2-prayer-row">
              <div class="lp2-prayer-who">${m.avatar||'👤'} ${m.name.split(' ')[0]}</div>
              <input type="text" class="lp2-prayer-input" id="prayer-${m.id}"
                placeholder="${['Start with thanks...','Add a need or hope...','Say amen your way...'][Math.min(i,2)]}">
            </div>`).join('')}
        </div>
        <button class="lp2-prayer-compile-btn" onclick="buildPrayer()">🙏 Compile Your Family Prayer</button>
        <div id="prayerResult" style="display:none;"></div>
      </div>`;
  }

  const body=document.getElementById('lessonBody');
  body.innerHTML=bandHtml+contentHtml;
  const scroll=document.getElementById('lessonScroll');
  if(scroll) scroll.scrollTo({top:0,behavior:'instant'});
}

function jumpLessonStep(i){
  if(i<state.lessonState.step){state.lessonState.step=i;renderLessonStep();}
}

function selectMission(i){
  state.lessonState.selectedMission=i;
  // In-place DOM update — no full re-render flicker
  document.querySelectorAll('.lp2-mission').forEach((el,idx)=>{
    el.classList.toggle('selected',idx===i);
    const chk=el.querySelector('.lp2-mission-check');
    if(chk) chk.textContent=idx===i?'✓':'';
  });
}
function selectEmoji(e){
  state.lessonState.selectedEmoji=e;
  document.querySelectorAll('.lp2-mood-btn').forEach(btn=>{
    btn.classList.toggle('selected',btn.textContent===e);
  });
}
function updateReflect(v){state.lessonState.reflectText=v;}
function buildPrayer(){
  const lines=state.members.map(m=>{const el=document.getElementById('prayer-'+m.id);return el?el.value.trim():''}).filter(Boolean);
  if(lines.length===0){showToast('Add at least one prayer line');return;}
  const result=document.getElementById('prayerResult');
  if(!result) return;
  result.innerHTML=`
    <div class="lp2-prayer-result">
      <span class="lp2-prayer-result-icon">🙏</span>
      <div class="lp2-prayer-result-title">Your Family Prayer</div>
      <div class="lp2-prayer-result-text">${lines.join('<br>')}</div>
      <div class="lp2-prayer-amen">✨ AMEN ✨</div>
    </div>`;
  result.style.display='block';
  setTimeout(()=>result.scrollIntoView({behavior:'smooth',block:'center'}),100);
}
function lessonNext(){
  const {step,path:pathId,lessonIndex}=state.lessonState;
  if(step===LESSON_STEPS.length-1){
    completeLesson();return;
  }
  state.lessonState.step++;renderLessonStep();
  document.getElementById('screen-lesson').scrollTop=0;
}
function lessonPrev(){
  if(state.lessonState.step>0){state.lessonState.step--;renderLessonStep();}
}
function completeLesson(){
  const {path:pathId,lessonIndex,selectedMission,selectedEmoji,reflectText}=state.lessonState;
  const lesson=getLesson(pathId,lessonIndex);
  const member=getCurrentMember();
  if(!isLessonComplete(member.id,lesson.id)){
    state.completions.push({memberId:member.id,lessonId:lesson.id,pathId,completedAt:new Date().toISOString()});
  }
  // Auto-create mission checkin
  if(selectedMission!==null){
    const mission=lesson.missions[selectedMission];
    state.checkins.push({id:'ci_'+Date.now(),memberId:member.id,lessonId:lesson.id,missionTitle:mission.title,reflection:reflectText||'Completed the mission!',emoji:selectedEmoji,approved:false,createdAt:new Date().toISOString()});
  }
  saveUserData();
  showToast('Lesson complete! 🎉 Mission submitted for parent approval.');
  setTimeout(()=>{
    if(member.role==='parent'){showParentApp();}else{showKidApp();}
  },300);
}

// ===================== CHECKIN (standalone) =====================
function startCheckin(mission,memberId){
  state.checkinState={
    mission,
    member:state.members.find(m=>m.id===memberId),
    step:0,
    selectedMood:null,
    reflectText:'',
  };
  showScreen('screen-checkin');
  renderCheckin();
}
function exitCheckin(){showKidApp();}

function renderCheckin(){
  const {mission,member,step,selectedMood,reflectText}=state.checkinState;
  const el=document.getElementById('checkinContent');
  const scroll=document.getElementById('ciScroll');

  // Update step track
  const track=document.getElementById('ciTrack');
  if(track){
    track.innerHTML=[0,1,2].map(i=>`<div class="ci-pip ${i<step?'done':i===step?'active':''}"></div>`).join('');
  }

  if(step===0){
    // ── Step 1: Mission confirmation ──────────────────────────────────────
    el.innerHTML=`
      <div class="ci-confirm-hero">
        <div class="ci-confirm-grid"></div>
        <div class="ci-confirm-glow"></div>
        <div class="ci-confirm-content">
          <div class="ci-confirm-ring">${mission?.emoji||'🎯'}</div>
          <div class="ci-confirm-tag">✅ Mission Complete</div>
          <div class="ci-confirm-title">You did it!</div>
          <div class="ci-confirm-mission">${member?.name||'You'} finished a real-world mission.</div>
        </div>
      </div>
      <div class="ci-confirm-body">
        <div class="ci-mission-recap">
          <div class="ci-recap-icon">${mission?.emoji||'🎯'}</div>
          <div class="ci-recap-info">
            <div class="ci-recap-label">Your mission</div>
            <div class="ci-recap-name">${mission?.title||'Mission'}</div>
            <div class="ci-recap-desc">${mission?.desc||''}</div>
          </div>
        </div>
        <p style="font-size:0.82rem;color:var(--slate-500);line-height:1.65;margin-bottom:20px;">
          Now share how it went — your parent will see this reflection and approve your mission.
        </p>
        <div class="ci-bar">
          <button class="ci-next-btn" onclick="ciNext()">Tell My Story →</button>
        </div>
      </div>`;

  } else if(step===1){
    // ── Step 2: Mood + reflection ─────────────────────────────────────────
    const moods=['😊','🤩','💪','🙏','😅','😤','😢','🥺'];
    el.innerHTML=`
      <div class="ci-story-hero">
        <div class="ci-confirm-grid"></div>
        <span class="ci-story-icon">📖</span>
        <div class="ci-story-title">Tell Your Story</div>
        <div class="ci-story-sub">How did the mission go? Your parent will love hearing about it.</div>
      </div>
      <div class="ci-story-body">
        <div class="ci-card">
          <div class="ci-card-label">How are you feeling?</div>
          <div class="ci-mood-grid">
            ${moods.map(e=>`<button class="ci-mood-btn${selectedMood===e?' selected':''}" onclick="ciSelectMood('${e}')">${e}</button>`).join('')}
          </div>
        </div>
        <div class="ci-card">
          <div class="ci-card-label">What happened? How did it feel?</div>
          <textarea class="ci-textarea" rows="5" id="ciReflect"
            placeholder="Describe what you did and how it went. Even one or two sentences is great!"
            oninput="state.checkinState.reflectText=this.value;document.getElementById('ciCharCount').textContent=this.value.length+' characters'"
          >${reflectText}</textarea>
          <div class="ci-char-count" id="ciCharCount">${reflectText.length} characters</div>
        </div>
        <div class="ci-photo-prompt" onclick="showToast('Photo upload coming soon! 📸')">
          <div class="ci-photo-icon">📸</div>
          <div class="ci-photo-text">
            <strong>Add a photo (optional)</strong>
            Snap a pic of your mission in action
          </div>
        </div>
        <div class="ci-bar">
          <button class="ci-next-btn" onclick="ciSubmit()" style="background:linear-gradient(135deg,#0369A1,#0284C7);box-shadow:0 4px 16px rgba(3,105,161,0.35);">
            Submit to Parent 🙏
          </button>
        </div>
      </div>`;

    // Restore scroll
    if(scroll) scroll.scrollTo({top:0,behavior:'instant'});

  } else if(step===2){
    // ── Step 3: Success ───────────────────────────────────────────────────
    el.innerHTML=`
      <div class="ci-success">
        <div class="ci-success-confetti">🎉 ⭐ 🎉</div>
        <div class="ci-success-ring">✅</div>
        <div class="ci-success-title">Submitted!</div>
        <div class="ci-success-sub">
          Your parent will review your mission and reflection soon. Great job putting faith into action!
        </div>
        <div class="ci-xp-burst">
          <div class="ci-xp-icon">⭐</div>
          <div class="ci-xp-text">
            <div class="ci-xp-val">+1 XP Earned</div>
            <div class="ci-xp-lbl">Mission submitted for approval</div>
          </div>
        </div>
        <div class="ci-success-note">
          You'll get a notification when your parent approves it.<br>
          Your reflection has been saved.
        </div>
        <button class="ci-done-btn" onclick="exitCheckin()">Back to Home 🏠</button>
      </div>`;

    if(scroll) scroll.scrollTo({top:0,behavior:'instant'});
  }
}

function ciSelectMood(e){
  state.checkinState.selectedMood=e;
  // In-place update — no full re-render
  document.querySelectorAll('.ci-mood-btn').forEach(btn=>{
    btn.classList.toggle('selected',btn.textContent===e);
  });
}

function ciNext(){
  state.checkinState.step++;
  renderCheckin();
}

function ciSubmit(){
  const text=state.checkinState.reflectText.trim()||
             document.getElementById('ciReflect')?.value.trim()||'';
  if(!text){showToast('Write a short reflection first ✏️');return;}
  const {mission,member,selectedMood}=state.checkinState;
  // Save check-in to state
  const existing=state.checkins.find(c=>
    c.memberId===member?.id&&c.missionTitle===mission?.title&&!c.approved
  );
  if(!existing){
    state.checkins.push({
      id:'ci_'+Date.now(),
      memberId:member?.id,
      lessonId:mission?.lessonId||'manual',
      missionTitle:mission?.title||'Mission',
      reflection:text,
      emoji:selectedMood||'😊',
      approved:false,
      createdAt:new Date().toISOString(),
    });
    saveUserData();
  }
  state.checkinState.step=2;
  renderCheckin();
}

// ===================== INIT =====================
// ===================== LANDING NAV =====================
function toggleMobileNav(){
  const drawer=document.getElementById('lnavDrawer');
  const btn=document.getElementById('mobileMenuBtn');
  drawer.classList.toggle('open');
  btn.classList.toggle('open');
}
function closeMobileNav(){
  document.getElementById('lnavDrawer').classList.remove('open');
  document.getElementById('mobileMenuBtn').classList.remove('open');
}
document.addEventListener('click',function(e){
  const drawer=document.getElementById('lnavDrawer');
  const btn=document.getElementById('mobileMenuBtn');
  if(drawer&&!drawer.contains(e.target)&&btn&&!btn.contains(e.target)){
    drawer.classList.remove('open');
    btn.classList.remove('open');
  }
});

// ===================== LESSON PREVIEW =====================
const LP_STEPS=[
  {icon:'📖',label:'Read',preview:'read'},
  {icon:'🤔',label:'Understand',preview:'understand'},
  {icon:'💬',label:'Talk Together',preview:'talk'},
  {icon:'🚀',label:'Faith-in-Action',preview:'do'},
  {icon:'💭',label:'Reflect',preview:'reflect'},
  {icon:'🙏',label:'Prayer Builder',preview:'prayer'},
];
const LP_PREVIEWS={
  read:`<div class="lp-preview-card">
    <div class="lp-preview-progress"><div class="lp-preview-progress-fill" style="width:16%;"></div></div>
    <div class="lp-preview-step-label">📖 Read</div>
    <div class="lp-preview-title">Jesus, the Good Shepherd</div>
    <div class="lp-preview-verse">
      <div class="lp-preview-verse-ref">John 10:11 · WEB</div>
      <div class="lp-preview-verse-text">"I am the good shepherd. The good shepherd lays down his life for the sheep."</div>
    </div>
    <p style="font-size:0.78rem;color:var(--slate-600);line-height:1.6;">Jesus compares himself to a shepherd who truly cares for and protects his sheep—even at great cost to himself.</p>
  </div>`,
  understand:`<div class="lp-preview-card">
    <div class="lp-preview-progress"><div class="lp-preview-progress-fill" style="width:33%;"></div></div>
    <div class="lp-preview-step-label">🤔 Understand</div>
    <div class="lp-preview-title">What does this mean for you?</div>
    <div style="background:var(--amber-light);border-radius:10px;padding:12px 14px;margin-bottom:10px;border-left:3px solid var(--amber);">
      <div style="font-size:0.65rem;font-weight:700;color:var(--gold);text-transform:uppercase;letter-spacing:0.06em;margin-bottom:5px;">For Kids (ages 6–10)</div>
      <p style="font-size:0.78rem;color:var(--slate-700);line-height:1.6;">Here's what this verse means for you: A shepherd's whole job is to protect and care for his sheep. Jesus says that's exactly how he feels about you!</p>
    </div>
    <div class="lp-preview-q">
      <div class="lp-preview-q-label">Question 1</div>
      <div class="lp-preview-q-text">What does it mean to you that Jesus calls himself your shepherd?</div>
    </div>
  </div>`,
  talk:`<div class="lp-preview-card">
    <div class="lp-preview-progress"><div class="lp-preview-progress-fill" style="width:50%;"></div></div>
    <div class="lp-preview-step-label">💬 Talk Together</div>
    <div class="lp-preview-title">Family Discussion</div>
    <div style="background:var(--sky-light);border-radius:10px;padding:10px 12px;margin-bottom:8px;">
      <div style="font-size:0.65rem;font-weight:700;color:#0369A1;text-transform:uppercase;letter-spacing:0.06em;margin-bottom:4px;">Coaching Note</div>
      <p style="font-size:0.75rem;color:var(--slate-600);">Let your child answer first before sharing your own perspective.</p>
    </div>
    <div class="lp-preview-q" style="margin-bottom:6px;"><div class="lp-preview-q-label">Q1</div><div class="lp-preview-q-text">What does it mean to you that Jesus calls himself your shepherd?</div></div>
    <div class="lp-preview-q"><div class="lp-preview-q-label">Q2</div><div class="lp-preview-q-text">How does a good shepherd act differently from someone who doesn't care?</div></div>
  </div>`,
  do:`<div class="lp-preview-card">
    <div class="lp-preview-progress"><div class="lp-preview-progress-fill" style="width:66%;"></div></div>
    <div class="lp-preview-step-label">🚀 Faith-in-Action</div>
    <div class="lp-preview-title">Choose Your Mission</div>
    <div class="lp-preview-mission">
      <div class="lp-preview-mission-label">✓ Selected · Easy</div>
      <div class="lp-preview-mission-title">🐑 Protect a Friend</div>
      <div class="lp-preview-mission-desc">This week, stand up for someone being left out or picked on. Be their shepherd.</div>
    </div>
    <div style="border:2px solid var(--slate-200);border-radius:10px;padding:12px 14px;margin-bottom:0;">
      <div class="lp-preview-mission-title" style="font-size:0.8rem;">✉️ Write a Care Note</div>
      <div class="lp-preview-mission-desc">Write or draw a note for someone who might feel alone. Deliver it in person.</div>
    </div>
  </div>`,
  reflect:`<div class="lp-preview-card">
    <div class="lp-preview-progress"><div class="lp-preview-progress-fill" style="width:83%;"></div></div>
    <div class="lp-preview-step-label">💭 Reflect</div>
    <div class="lp-preview-title">How did it go?</div>
    <div style="font-weight:600;font-size:0.75rem;margin-bottom:8px;color:var(--slate-600);">How are you feeling?</div>
    <div class="lp-preview-emoji-row">
      <span class="lp-preview-emoji sel">💪</span>
      <span class="lp-preview-emoji">😊</span>
      <span class="lp-preview-emoji">🤩</span>
      <span class="lp-preview-emoji">🙏</span>
      <span class="lp-preview-emoji">😢</span>
    </div>
    <div style="background:var(--slate-50);border-radius:8px;padding:10px 12px;">
      <div style="font-size:0.65rem;font-weight:700;color:var(--slate-500);text-transform:uppercase;letter-spacing:0.06em;margin-bottom:4px;">Your reflection</div>
      <p style="font-size:0.78rem;color:var(--slate-600);font-style:italic;">"I stood up for my friend at recess and it felt really brave!"</p>
    </div>
  </div>`,
  prayer:`<div class="lp-preview-card">
    <div class="lp-preview-progress"><div class="lp-preview-progress-fill" style="width:100%;"></div></div>
    <div class="lp-preview-step-label">🙏 Prayer Builder</div>
    <div class="lp-preview-title">Build a Family Prayer</div>
    <div style="display:flex;flex-direction:column;gap:8px;margin-bottom:12px;">
      <div style="display:flex;gap:8px;align-items:center;">
        <span style="font-size:0.75rem;font-weight:600;color:var(--slate-500);min-width:60px;">👤 Mom:</span>
        <div style="flex:1;background:var(--slate-50);border-radius:8px;padding:8px 10px;font-size:0.78rem;color:var(--slate-700);font-style:italic;">Thank you for giving us courage...</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center;">
        <span style="font-size:0.75rem;font-weight:600;color:var(--slate-500);min-width:60px;">⭐ Emma:</span>
        <div style="flex:1;background:var(--slate-50);border-radius:8px;padding:8px 10px;font-size:0.78rem;color:var(--slate-700);font-style:italic;">Help me be brave tomorrow...</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center;">
        <span style="font-size:0.75rem;font-weight:600;color:var(--slate-500);min-width:60px;">🦁 Jake:</span>
        <div style="flex:1;background:var(--slate-50);border:2px dashed var(--slate-200);border-radius:8px;padding:8px 10px;font-size:0.78rem;color:var(--slate-400);">Add your line...</div>
      </div>
    </div>
    <div style="text-align:center;background:linear-gradient(135deg,var(--amber-light),#FFF7ED);border-radius:8px;padding:8px;font-size:0.75rem;font-weight:600;color:var(--gold);">✨ Amen together</div>
  </div>`,
};
let lpActiveStep=0;
function initLessonPreview(){
  const stepsEl=document.getElementById('lpStepsList');
  const phoneEl=document.getElementById('lpPhoneContent');
  if(!stepsEl||!phoneEl)return;
  // Already pre-populated inline — just wire up the active state
  if(stepsEl.children.length===0){
    stepsEl.innerHTML=LP_STEPS.map((s,i)=>`
      <div class="lp-step-row${i===0?' active':''}" id="lpStep${i}" onclick="selectLpStep(${i})">
        <div class="lp-step-dot">${s.icon}</div>
        <span class="lp-step-label">${s.label}</span>
      </div>`).join('');
    phoneEl.innerHTML=LP_PREVIEWS[LP_STEPS[0].preview];
  }
}
function selectLpStep(i){
  lpActiveStep=i;
  document.querySelectorAll('.lp-step-row').forEach((el,idx)=>el.classList.toggle('active',idx===i));
  const phoneEl=document.getElementById('lpPhoneContent');
  if(phoneEl){phoneEl.style.opacity='0';setTimeout(()=>{phoneEl.innerHTML=LP_PREVIEWS[LP_STEPS[i].preview];phoneEl.style.opacity='1';},150);}
}

// Init on load
buildFAQ();
initLessonPreview();

// ── Firebase init check + hard overlay timeout ─────────────────────────────
(function(){
  function hideOverlay(){
    var ov = document.getElementById('fq-loading-overlay');
    if(ov) ov.style.display = 'none';
  }

  // Hard timeout: never stay stuck longer than 4 seconds
  setTimeout(function(){
    hideOverlay();
    showScreen('screen-landing');
  }, 4000);

  // Soft check at 1s — update UI hints
  setTimeout(function(){
    var configured = window._fb?.configured;
    var hint = document.getElementById('authDemoHintText');
    if(hint){
      hint.innerHTML = configured
        ? '<strong>Secure sign-in</strong> powered by Firebase. Your data syncs across all devices.'
        : '<strong>Demo mode:</strong> Firebase not configured. Enter any email + password to explore.';
    }
    if(!configured){
      var banner = document.getElementById('fq-firebase-banner');
      if(banner) banner.style.display = 'block';
      hideOverlay();
      showScreen('screen-landing');
    }
  }, 1000);
})();


// ── PWA: Inline Web App Manifest ─────────────────────────────────────────
(function(){
  var manifest = {
    name: "FaithQuest \u2014 Family Bible Learning",
    short_name: "FaithQuest",
    description: "Family Bible learning with guided lessons, real-world missions, and age-safe AI.",
    start_url: "./",
    display: "standalone",
    orientation: "portrait-primary",
    background_color: "#0F172A",
    theme_color: "#0F172A",
    categories: ["education","lifestyle"],
    icons: [
      { src: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' rx='115' fill='%230F172A'/%3E%3Crect x='60' y='60' width='392' height='392' rx='80' fill='%23F59E0B'/%3E%3Ctext x='256' y='330' font-size='240' text-anchor='middle' fill='white'%3E%E2%9C%9D%3C/text%3E%3C/svg%3E", sizes: "512x512", type: "image/svg+xml", purpose: "any maskable" },
      { src: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'%3E%3Crect width='192' height='192' rx='42' fill='%230F172A'/%3E%3Crect x='22' y='22' width='148' height='148' rx='30' fill='%23F59E0B'/%3E%3Ctext x='96' y='125' font-size='90' text-anchor='middle' fill='white'%3E%E2%9C%9D%3C/text%3E%3C/svg%3E", sizes: "192x192", type: "image/svg+xml", purpose: "any maskable" }
    ],
    shortcuts: [
      { name: "Today's Lesson", short_name: "Lesson", url: "./#lesson" },
      { name: "Mission Check-In", short_name: "Mission", url: "./#mission" }
    ]
  };
  var blob = new Blob([JSON.stringify(manifest)], {type:'application/manifest+json'});
  var link = document.createElement('link');
  link.rel = 'manifest';
  link.href = URL.createObjectURL(blob);
  document.head.appendChild(link);
})();

// ── PWA: Service Worker via Blob (no separate sw.js needed) ───────────────
(function(){
  if (!('serviceWorker' in navigator)) return;
  var sw = [
    "const CACHE='faithquest-v1';",
    "const FC='faithquest-fonts-v1';",
    "self.addEventListener('install',e=>{e.waitUntil(caches.open(CACHE).then(c=>c.add(self.location.pathname||'/').catch(()=>{})).then(()=>self.skipWaiting()));});",
    "self.addEventListener('activate',e=>{e.waitUntil(caches.keys().then(ks=>Promise.all(ks.filter(k=>k!==CACHE&&k!==FC).map(k=>caches.delete(k)))).then(()=>self.clients.claim()));});",
    "self.addEventListener('fetch',e=>{",
    "  const u=new URL(e.request.url);",
    "  if(u.hostname==='fonts.googleapis.com'||u.hostname==='fonts.gstatic.com'){",
    "    e.respondWith(caches.open(FC).then(c=>c.match(e.request).then(cached=>{",
    "      if(cached)return cached;",
    "      return fetch(e.request).then(r=>{if(r&&r.status===200)c.put(e.request,r.clone());return r;}).catch(()=>cached);",
    "    })));return;",
    "  }",
    "  if(e.request.mode==='navigate'){",
    "    e.respondWith(fetch(e.request).then(r=>{if(r&&r.status===200)caches.open(CACHE).then(c=>c.put(e.request,r.clone()));return r;}).catch(()=>caches.match(e.request).then(c=>c||new Response('<html><body style=\"font-family:sans-serif;display:flex;align-items:center;justify-content:center;min-height:100vh;margin:0;background:#0F172A;color:white;text-align:center;padding:24px\"><div><div style=\"font-size:3rem;margin-bottom:16px\">&#10013;</div><h2 style=\"font-family:serif\">FaithQuest</h2><p style=\"opacity:.7\">You are offline. Reconnect to continue.</p></div></body></html>',{headers:{'Content-Type':'text/html'}}))));return;",
    "  }",
    "  e.respondWith(caches.match(e.request).then(cached=>{",
    "    const fresh=fetch(e.request).then(r=>{if(r&&r.status===200)caches.open(CACHE).then(c=>c.put(e.request,r.clone()));return r;}).catch(()=>cached);",
    "    return cached||fresh;",
    "  }));",
    "});",
    "self.addEventListener('sync',e=>{if(e.tag==='sync-missions')console.log('[FQ SW] sync');});",
    "self.addEventListener('notificationclick',e=>{e.notification.close();e.waitUntil(clients.matchAll({type:'window',includeUncontrolled:true}).then(l=>{for(const c of l){if(c.focus)return c.focus();}return clients.openWindow('./');})  );});"
  ].join('\n');
  var blob = new Blob([sw], {type:'application/javascript'});
  navigator.serviceWorker.register(URL.createObjectURL(blob))
    .then(function(reg){
      console.log('[FaithQuest] SW registered');
      setInterval(function(){reg.update();}, 60000);
      reg.addEventListener('updatefound', function(){
        var nw = reg.installing;
        nw.addEventListener('statechange', function(){
          if(nw.state==='installed' && navigator.serviceWorker.controller){
            showToast('App updated — refresh to get the latest version', 5000);
          }
        });
      });
    })
    .catch(function(err){ console.warn('[FaithQuest] SW error:', err); });
})();

// ── PWA: Add to Home Screen banner ───────────────────────────────────────
var _ip = null;
window.addEventListener('beforeinstallprompt', function(e){
  e.preventDefault(); _ip = e;
  setTimeout(showInstallBanner, 20000);
});
window.addEventListener('appinstalled', function(){
  _ip = null; hideInstallBanner();
  showToast('FaithQuest added to your home screen!', 4000);
});
function showInstallBanner(){
  if(!_ip || document.getElementById('pwa-banner')) return;
  var b = document.createElement('div');
  b.id = 'pwa-banner';
  b.style.cssText = 'position:fixed;bottom:80px;left:12px;right:12px;background:white;border-radius:16px;padding:14px 16px;box-shadow:0 8px 40px rgba(0,0,0,0.18);display:flex;align-items:center;gap:10px;z-index:9000;animation:slideUpBanner 0.35s cubic-bezier(0.34,1.56,0.64,1) both';
  b.innerHTML = '<div style="display:flex;align-items:center;gap:12px;flex:1"><div style="font-size:1.6rem">&#10013;&#65039;</div><div><div style="font-weight:700;font-size:0.875rem;color:#0F172A">Add FaithQuest to Home Screen</div><div style="font-size:0.75rem;color:#64748B;margin-top:1px">Offline access &middot; Faster &middot; No browser chrome</div></div></div><button onclick="triggerInstall()" style="background:#F59E0B;color:white;border:none;padding:10px 18px;border-radius:10px;font-weight:700;font-size:0.85rem;cursor:pointer;font-family:inherit;white-space:nowrap;flex-shrink:0">Install</button><button onclick="hideInstallBanner()" style="background:none;border:none;font-size:1.1rem;cursor:pointer;color:#94A3B8;padding:4px 8px;flex-shrink:0">&times;</button>';
  document.body.appendChild(b);
}
function hideInstallBanner(){
  var b=document.getElementById('pwa-banner'); if(b) b.remove();
}
function triggerInstall(){
  if(!_ip) return;
  _ip.prompt();
  _ip.userChoice.then(function(r){
    if(r.outcome==='accepted') showToast('Installing FaithQuest...', 3000);
    _ip = null; hideInstallBanner();
  });
}
</script>

<!-- ===== FIREBASE LOADING OVERLAY ===== -->
<div id="fq-loading-overlay" style="position:fixed;inset:0;background:#060D1F;z-index:9999;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;">
  <div style="width:56px;height:56px;background:linear-gradient(135deg,#F59E0B,#D97706);border-radius:16px;display:flex;align-items:center;justify-content:center;font-size:28px;box-shadow:0 8px 24px rgba(245,158,11,0.4);">✝️</div>
  <div style="font-family:Georgia,serif;font-size:1.3rem;font-weight:700;color:white;">FaithQuest</div>
  <div style="display:flex;gap:6px;margin-top:4px;">
    <div style="width:8px;height:8px;border-radius:50%;background:#F59E0B;animation:dotPulse 1.2s 0s ease-in-out infinite;"></div>
    <div style="width:8px;height:8px;border-radius:50%;background:#F59E0B;animation:dotPulse 1.2s 0.2s ease-in-out infinite;"></div>
    <div style="width:8px;height:8px;border-radius:50%;background:#F59E0B;animation:dotPulse 1.2s 0.4s ease-in-out infinite;"></div>
  </div>
  <style>@keyframes dotPulse{0%,80%,100%{opacity:0.2;transform:scale(0.8);}40%{opacity:1;transform:scale(1.1);}}</style>
</div>

<!-- ===== FIREBASE CONFIG BANNER ===== -->
<div id="fq-firebase-banner" style="display:none;position:fixed;bottom:0;left:0;right:0;z-index:8000;background:linear-gradient(135deg,#0F172A,#1E3A5F);border-top:2px solid rgba(245,158,11,0.4);padding:16px 20px;box-shadow:0 -8px 32px rgba(0,0,0,0.4);">
  <div style="max-width:600px;margin:0 auto;display:flex;align-items:flex-start;gap:12px;">
    <div style="font-size:1.4rem;flex-shrink:0;margin-top:2px;">🔧</div>
    <div style="flex:1;">
      <div style="font-weight:800;font-size:0.9rem;color:white;margin-bottom:4px;">Firebase not configured — running in demo mode</div>
      <div style="font-size:0.78rem;color:rgba(255,255,255,0.6);line-height:1.5;margin-bottom:10px;">Auth + cloud sync disabled. Add your project credentials to the <code style="background:rgba(255,255,255,0.1);padding:1px 5px;border-radius:4px;">FIREBASE_CONFIG</code> object at the top of the module script.</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;">
        <a href="https://console.firebase.google.com/" target="_blank" style="display:inline-flex;align-items:center;gap:5px;background:rgba(245,158,11,0.2);border:1px solid rgba(245,158,11,0.4);color:#F59E0B;padding:6px 12px;border-radius:8px;font-size:0.75rem;font-weight:700;text-decoration:none;">Open Firebase Console ↗</a>
        <button onclick="document.getElementById('fq-firebase-banner').style.display='none'" style="background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);color:rgba(255,255,255,0.6);padding:6px 12px;border-radius:8px;font-size:0.75rem;font-weight:700;cursor:pointer;font-family:inherit;">Dismiss</button>
      </div>
    </div>
  </div>
</div>

</body>
</html>
